<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Desk - Sistema de Ponto de Venda</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 0;
        }

        /* Tela de Login */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Verde do sistema com contraste suave branco */
            background: linear-gradient(135deg, #1e293b 0%, #334155 45%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header .material-symbols-rounded {
            font-size: 4rem;
            color: #059669;
            margin-bottom: 1rem;
        }

        .login-header h2 {
            font-size: 1.8rem;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #64748b;
            font-size: 0.95rem;
        }

        .login-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        .login-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: #64748b;
            font-weight: 600;
            transition: all 0.3s;
        }

        .login-tab.active {
            color: #059669;
            border-bottom-color: #059669;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group-login {
            margin-bottom: 1.5rem;
        }

        .form-group-login label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #475569;
            font-size: 0.9rem;
        }

        .form-group-login {
            position: relative;
        }

        .form-group-login input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group-login input[type="password"] {
            padding-right: 48px;
        }

        .form-group-login input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: calc(50% + 8px);
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #64748b;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
            z-index: 10;
        }

        .password-toggle:hover {
            color: #059669;
        }

        .password-toggle:active {
            transform: translateY(-50%) scale(0.95);
        }

        .password-toggle svg {
            width: 26px;
            height: 26px;
            display: block;
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: #059669;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-login .material-symbols-rounded {
            font-size: 20px;
            line-height: 1;
            vertical-align: middle;
        }

        .btn-login:hover {
            background: #047857;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            box-shadow: 0 0 30px rgba(0,0,0,0.05);
        }

        .header {
            background: #1e293b;
            color: white;
            padding: 18px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header-menu {
            position: relative;
            display: inline-block;
        }
        
        .menu-button {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: #cbd5e1;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .menu-button:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
        }
        
        .menu-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 220px;
            display: none;
            z-index: 1000;
            overflow: hidden;
        }
        
        .menu-dropdown.active {
            display: block;
        }
        
        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #475569;
            font-size: 14px;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .menu-item:hover {
            background: #f8fafc;
            color: #059669;
        }
        
        .menu-item .material-symbols-rounded {
            font-size: 18px;
        }

        .menu-item.logout-item {
            color: #dc2626;
        }

        .menu-item.logout-item:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .menu-item.logout-item .material-symbols-rounded {
            color: #dc2626;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.3px;
        }

.header h1 i, .header h1 .material-symbols-rounded {
            font-size: 24px;
            color: #059669;
        }

        .tabs {
            display: flex;
            background: #fff;
            padding: 0 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

.tab i, .tab .material-symbols-rounded {
            font-size: 16px;
        }

        .tab:hover {
            color: #059669;
            background: #f8fafc;
        }

        .tab.active {
            color: #059669;
            border-bottom-color: #059669;
            background: transparent;
            font-weight: 700;
        }

        .content {
            padding: 24px;
            min-height: calc(100vh - 140px);
            background: #f8fafc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Vendas */
        .vendas-grid {
            display: grid;
            grid-template-columns: 750px 1fr;
            gap: 24px;
        }

        .busca-produto {
            margin-bottom: 20px;
        }
        
        #leitorStatus {
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        #leitorIcon {
            animation: pulse 2s infinite;
        }
        
        #leitorIcon svg {
            width: 16px;
            height: 16px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .busca-produto input {
            width: 100%;
            padding: 14px 16px 14px 44px;
            font-size: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            outline: none;
            background: white;
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%2394a3b8' viewBox='0 0 512 512'%3E%3Cpath d='M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 16px center;
            background-size: 16px;
        }

        .busca-produto input:focus {
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        /* Estilo unificado para barras de busca */
        .busca-input {
            width: 100%;
            padding: 14px 16px 14px 44px;
            font-size: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            outline: none;
            background: white;
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%2394a3b8' viewBox='0 0 512 512'%3E%3Cpath d='M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 16px center;
            background-size: 16px;
        }

        .busca-input:focus {
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        /* Estilos para filtros - Clientes e Histórico */
        .filtros-container {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .filtros-grid {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filtro-item {
            flex: 1;
            min-width: 150px;
        }

        .filtro-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #475569;
            font-size: 14px;
        }

        .filtro-item input[type="text"],
        .filtro-item input[type="number"],
        .filtro-item input[type="date"] {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
            font-family: inherit;
            color: #1e293b;
        }

        .filtro-item input[type="text"]:focus,
        .filtro-item input[type="number"]:focus,
        .filtro-item input[type="date"]:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .filtro-item select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
            font-family: inherit;
            color: #1e293b;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .filtro-item select:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .filtro-item select:hover {
            border-color: #94a3b8;
        }

        .filtro-actions {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .filtro-actions .btn {
            white-space: nowrap;
            padding: 12px 16px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* Estilos para edição de conta */
        #contaFotoPreview:hover {
            border-color: #059669;
            transform: scale(1.02);
        }

        #contaFotoPreview:hover #contaFotoIcon {
            opacity: 0.8;
        }

        /* Estilo para teclas no modal de atalhos */
        .key-button {
            display: inline-block;
            background: #e5e7eb;
            color: #374151;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid #d1d5db;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            min-width: 32px;
            text-align: center;
            line-height: 1.4;
        }

        .key-combination {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .key-separator {
            color: #1f2937;
            font-weight: 600;
            font-size: 16px;
        }

        .produtos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .produto-card {
            background: white;
            padding: 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }

        .produto-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            border-color: #059669;
        }

        .produto-card:active {
            transform: translateY(-1px);
        }

        .produto-card h4 {
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            line-height: 1.3;
        }

        .produto-card .preco {
            color: #059669;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
        }


        .carrinho {
            background: white;
            padding: 48px;
            border-radius: 12px;
            position: sticky;
            top: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            min-width: 700px;
        }

        .carrinho h3 {
            margin-bottom: 32px;
            color: #1e293b;
            font-size: 32px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .carrinho h3 i {
            color: #059669;
            font-size: 28px;
        }

        .carrinho-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #f1f5f9;
            gap: 14px;
        }

        .carrinho-item > * {
            display: flex;
            align-items: center;
        }

        .carrinho-item .quantidade {
            flex-shrink: 0;
        }

        .carrinho-item .nome {
            flex: 1;
            font-size: 20px;
            color: #1e293b;
            font-weight: 500;
            line-height: 1.5;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            word-wrap: break-word;
            max-width: 100%;
            min-width: 0;
        }

        .foto-carrinho {
            border-radius: 0 !important;
        }

        .foto-carrinho img {
            border-radius: 0 !important;
        }

        .carrinho-item .quantidade {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: #f1f5f9;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: 600;
            color: #475569;
        }

        .carrinho-item .quantidade button {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carrinho-item button {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .carrinho-item button:hover {
            background: #fecaca;
        }

        .carrinho-total {
            margin-top: 40px;
            padding-top: 28px;
            border-top: 2px solid #e2e8f0;
        }

        .carrinho-total .linha {
            display: flex;
            justify-content: space-between;
            margin: 24px 0;
            font-size: 22px;
            color: #475569;
            font-weight: 500;
        }

        .carrinho-total .linha input {
            width: 100px;
            text-align: right;
            padding: 6px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
        }

        .carrinho-total .total {
            font-weight: 700;
            font-size: 36px;
            color: #1e293b;
            margin-top: 16px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* Otimizações de performance */
            will-change: transform;
            transform: translateZ(0); /* Aceleração GPU */
            touch-action: manipulation; /* Melhora responsividade em cliques */
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn i {
            font-size: 14px;
        }

        .btn-primary {
            background: #059669;
            color: white;
        }

        .btn-primary:hover {
            background: #047857;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-success {
            background: #059669;
            color: white;
            width: 100%;
            padding: 14px;
            font-size: 15px;
            margin-top: 16px;
        }

        .btn-success:hover {
            background: #047857;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        /* Produtos */
        .produtos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .produtos-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .tabela {
            table-layout: auto;
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #e2e8f0;
        }

        .tabela th {
            background: #f8fafc;
            color: #475569;
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e2e8f0;
        }

        .tabela td {
            padding: 14px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: #1e293b;
            font-size: 14px;
        }
        
        .tabela td:nth-child(3) {
            max-width: 400px;
            min-width: 200px;
        }

        .tabela tbody tr {
            transition: all 0.15s;
        }

        .tabela tbody tr:hover {
            background: #f8fafc;
        }

        .tabela tbody tr:last-child td {
            border-bottom: none;
        }

        .foto-produto-container {
            transition: all 0.2s;
        }

        .foto-produto-container:hover {
            border-color: #059669;
            background: #f0fdf4;
        }

        .foto-produto-container:hover .foto-overlay {
            display: flex !important;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Checkbox Customizado - Estilo HeroUI */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e1;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin: 0;
        }

        input[type="checkbox"]:hover {
            border-color: #059669;
            background: #f0fdf4;
        }

        input[type="checkbox"]:checked {
            background: #059669;
            border-color: #059669;
        }

        input[type="checkbox"]:checked::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            border-radius: 1px;
        }

        input[type="checkbox"]:indeterminate {
            background: #059669;
            border-color: #059669;
        }

        input[type="checkbox"]:indeterminate::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 2px;
            background: white;
            border-radius: 1px;
        }

        input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        input[type="checkbox"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f1f5f9;
            border-color: #e2e8f0;
        }

        /* Modal - Otimizado para performance */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s;
            /* Otimizações de performance */
            contain: layout style paint;
            will-change: opacity;
            transform: translateZ(0); /* Aceleração GPU */
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
            /* Otimizações de performance */
            contain: layout style paint;
            will-change: transform, opacity;
            transform: translateZ(0); /* Aceleração GPU */
            backface-visibility: hidden; /* Evita renderização desnecessária */
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .modal-header button {
            color: #94a3b8;
            transition: color 0.2s;
        }

        .modal-header button:hover {
            color: #1e293b;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #475569;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }

        /* Loader do botão Salvar (modal produto) */
        .loader {
            width: 32px;
            overflow: visible;
            transform: rotate(-90deg);
            transform-origin: center;

            --active: #a6abad;
            --track: #ededed;
            --duration: 8s;

            animation: spin 2s linear infinite;
        }

        /* Skeleton Loader */
        .skeleton-loader {
            display: table-row;
        }
        .skeleton-cell {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
            height: 20px;
        }
        .skeleton-cell-photo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
        }
        .skeleton-cell-small {
            width: 80px;
        }
        .skeleton-cell-medium {
            width: 150px;
        }
        .skeleton-cell-large {
            width: 250px;
        }
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        @keyframes spin {
            0% {
                rotate: 0deg;
            }
            100% {
                rotate: 360deg;
            }
        }

        .loader circle.loader-active {
            stroke: var(--active);
            stroke-linecap: round;
            stroke-dashoffset: 360;
            animation: active-animation var(--duration) ease-in-out infinite;
        }

        @keyframes active-animation {
            0% {
                stroke-dasharray: 0 0 0 360 0 360;
            }
            12.5% {
                stroke-dasharray: 0 0 270 90 270 90;
            }
            25% {
                stroke-dasharray: 0 270 0 360 0 360;
            }
            37.5% {
                stroke-dasharray: 0 270 270 90 270 90;
            }
            50% {
                stroke-dasharray: 0 540 0 360 0 360;
            }
            50.001% {
                stroke-dasharray: 0 180 0 360 0 360;
            }
            62.5% {
                stroke-dasharray: 0 180 270 90 270 90;
            }
            75% {
                stroke-dasharray: 0 450 0 360 0 360;
            }
            87.5% {
                stroke-dasharray: 0 450 270 90 270 90;
            }
            87.501% {
                stroke-dasharray: 0 90 270 90 270 90;
            }
            100% {
                stroke-dasharray: 0 360 1 360 0 360;
            }
        }

        .loader circle.loader-track {
            stroke: var(--track);
            stroke-linecap: round;
            stroke-dashoffset: 360;
            animation: track-animation var(--duration) ease-in-out infinite;
        }

        @keyframes track-animation {
            0% {
                stroke-dasharray: 0 20 320 40 320 40;
            }
            12.5% {
                stroke-dasharray: 0 290 50 310 50 310;
            }
            25% {
                stroke-dasharray: 0 290 320 40 320 40;
            }
            37.5% {
                stroke-dasharray: 0 560 50 310 50 310;
            }
            37.501% {
                stroke-dasharray: 0 200 50 310 50 310;
            }
            50% {
                stroke-dasharray: 0 200 320 40 320 40;
            }
            62.5% {
                stroke-dasharray: 0 470 50 310 50 310;
            }
            62.501% {
                stroke-dasharray: 0 110 50 310 50 310;
            }
            75% {
                stroke-dasharray: 0 110 320 40 320 40;
            }
            87.5% {
                stroke-dasharray: 0 380 50 310 50 310;
            }
            100% {
                stroke-dasharray: 0 380 320 40 320 40;
            }
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .estatisticas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 13px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-card h3 i {
            font-size: 16px;
            color: #059669;
        }

        .stat-card .valor {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
            letter-spacing: -0.5px;
        }
        /* Toasts */
        .toast-container { position: fixed; right: 20px; bottom: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 10001; }
        .toast { min-width: 260px; max-width: 360px; background: #0f172a; color: #e2e8f0; padding: 14px 16px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); display: flex; align-items: center; gap: 10px; border-left: 4px solid #38bdf8; animation: fadeIn 0.2s ease-out; }
        .toast.success { border-left-color: #10b981; }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }
        .toast .material-symbols-rounded { font-size: 18px; opacity: 0.9; }
        /* Modal de confirmação */
        .confirm-modal { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.6); z-index:10002; align-items:center; justify-content:center; }
        .confirm-modal.active { display:flex; }
        .confirm-box { background:#fff; width:92%; max-width:420px; border-radius:14px; box-shadow: 0 20px 60px rgba(0,0,0,0.35); padding:22px; }
        .confirm-title { font-size:18px; color:#0f172a; font-weight:700; margin-bottom:8px; }
        .confirm-text { color:#475569; margin-bottom:18px; }
        .confirm-actions { display:flex; gap:10px; justify-content:flex-end; }
        .btn-outline { background:#fff; color:#0f172a; border:1px solid #cbd5e1; }
    </style>
</head>
<body>
    <!-- Tela de Login/Cadastro -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <span class="material-symbols-rounded">point_of_sale</span>
                <h2>PDV Desk</h2>
                <p id="loginWelcome">Bem-vindo! Faça login para continuar</p>
            </div>

            <div class="error-message" id="loginError"></div>
            <div class="success-message" id="loginSuccess"></div>

            <div class="login-tabs" id="loginTabs">
                <div class="login-tab active" onclick="mudarLoginTab('login')">Entrar</div>
                <div class="login-tab" onclick="mudarLoginTab('cadastro')">Criar Conta</div>
            </div>

            <!-- Form de Login -->
            <form class="login-form active" id="formLogin" onsubmit="fazerLogin(event)">
                <div class="form-group-login">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required placeholder="seu@email.com">
                </div>
                <div class="form-group-login">
                    <label>Senha</label>
                    <input type="password" id="loginSenha" required placeholder="••••••••">
                    <button type="button" class="password-toggle" onclick="togglePassword('loginSenha', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="eye-icon eye-closed"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10a13.4 13.4 0 0 0 3 2.685M21 10a13.4 13.4 0 0 1-3 2.685m-8 1.624L9.5 16.5m.5-2.19a10.6 10.6 0 0 0 4 0m-4 0a11.3 11.3 0 0 1-4-1.625m8 1.624l.5 2.191m-.5-2.19a11.3 11.3 0 0 0 4-1.625m0 0l1.5 1.815M6 12.685L4.5 14.5"/></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="eye-icon eye-open" style="display:none;"><g fill="currentColor"><path d="M15.83 7.42C15.1 6.38 12.38 3 8 3S.9 6.38.17 7.42a.99.99 0 0 0 0 1.16C.9 9.62 3.62 13 8 13s7.1-3.38 7.83-4.42a.99.99 0 0 0 0-1.16M8 11c-1.65 0-3-1.35-3-3s1.35-3 3-3s3 1.35 3 3s-1.35 3-3 3"/><circle cx="8" cy="8" r="2"/></g></svg>
                    </button>
                </div>
                <button type="submit" class="btn-login">
                    <span class="material-symbols-rounded">login</span> Entrar
                </button>
            </form>

            <!-- Form de Cadastro -->
            <form class="login-form" id="formCadastro" onsubmit="fazerCadastro(event)">
                <div class="form-group-login">
                    <label>Nome Completo</label>
                    <input type="text" id="cadastroNome" required placeholder="Seu nome">
                </div>
                <div class="form-group-login">
                    <label>Email</label>
                    <input type="email" id="cadastroEmail" required placeholder="seu@email.com">
                </div>
                <div class="form-group-login">
                    <label>Senha</label>
                    <input type="password" id="cadastroSenha" required placeholder="••••••••" minlength="6">
                    <button type="button" class="password-toggle" onclick="togglePassword('cadastroSenha', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="eye-icon eye-closed"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10a13.4 13.4 0 0 0 3 2.685M21 10a13.4 13.4 0 0 1-3 2.685m-8 1.624L9.5 16.5m.5-2.19a10.6 10.6 0 0 0 4 0m-4 0a11.3 11.3 0 0 1-4-1.625m8 1.624l.5 2.191m-.5-2.19a11.3 11.3 0 0 0 4-1.625m0 0l1.5 1.815M6 12.685L4.5 14.5"/></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="eye-icon eye-open" style="display:none;"><g fill="currentColor"><path d="M15.83 7.42C15.1 6.38 12.38 3 8 3S.9 6.38.17 7.42a.99.99 0 0 0 0 1.16C.9 9.62 3.62 13 8 13s7.1-3.38 7.83-4.42a.99.99 0 0 0 0-1.16M8 11c-1.65 0-3-1.35-3-3s1.35-3 3-3s3 1.35 3 3s-1.35 3-3 3"/><circle cx="8" cy="8" r="2"/></g></svg>
                    </button>
                </div>
                <div class="form-group-login">
                    <label>Confirmar Senha</label>
                    <input type="password" id="cadastroSenhaConfirm" required placeholder="••••••••" minlength="6">
                    <button type="button" class="password-toggle" onclick="togglePassword('cadastroSenhaConfirm', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="eye-icon eye-closed"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10a13.4 13.4 0 0 0 3 2.685M21 10a13.4 13.4 0 0 1-3 2.685m-8 1.624L9.5 16.5m.5-2.19a10.6 10.6 0 0 0 4 0m-4 0a11.3 11.3 0 0 1-4-1.625m8 1.624l.5 2.191m-.5-2.19a11.3 11.3 0 0 0 4-1.625m0 0l1.5 1.815M6 12.685L4.5 14.5"/></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="eye-icon eye-open" style="display:none;"><g fill="currentColor"><path d="M15.83 7.42C15.1 6.38 12.38 3 8 3S.9 6.38.17 7.42a.99.99 0 0 0 0 1.16C.9 9.62 3.62 13 8 13s7.1-3.38 7.83-4.42a.99.99 0 0 0 0-1.16M8 11c-1.65 0-3-1.35-3-3s1.35-3 3-3s3 1.35 3 3s-1.35 3-3 3"/><circle cx="8" cy="8" r="2"/></g></svg>
                    </button>
                </div>
                <button type="submit" class="btn-login">
                    <span class="material-symbols-rounded">person_add</span> Criar Conta
                </button>
            </form>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1><span class="material-symbols-rounded">point_of_sale</span> PDV Desk</h1>
            <div style="display:flex;align-items:center;gap:20px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <div id="usuarioLogadoAvatar" style="width:36px;height:36px;border-radius:50%;background:#059669;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;border:2px solid rgba(203,213,225,0.3);">
                        <svg id="usuarioLogadoAvatarIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="color:white;display:block;"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21a7 7 0 1 0-14 0m7-10a4 4 0 1 1 0-8a4 4 0 0 1 0 8"/></svg>
                        <img id="usuarioLogadoAvatarImg" src="" alt="Avatar" style="width:100%;height:100%;object-fit:cover;display:none;">
                    </div>
                    <span id="usuarioLogadoNome" style="color:#cbd5e1;"></span>
                </div>
                <button onclick="abrirModalAtalhos()" style="background:#059669;color:white;border:none;padding:8px 16px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all 0.2s;">
                    <span class="material-symbols-rounded" style="font-size:18px;">keyboard</span>
                    Ver Atalhos (<span class="key-button" style="font-size:11px;padding:3px 6px;">ESC</span>)
                </button>
                <div class="header-menu">
                    <button class="menu-button" onclick="toggleMenu()">
                        <span class="material-symbols-rounded" id="menuIcon">menu</span>
                        Menu
                    </button>
                    <div class="menu-dropdown" id="menuDropdown">
                        <button class="menu-item" onclick="mudaTab('conta'); toggleMenu();">
                            <span class="material-symbols-rounded">account_circle</span>
                            A Conta
                        </button>
                        <button class="menu-item" onclick="mudaTab('gerenciamento'); toggleMenu();">
                            <span class="material-symbols-rounded">manage_accounts</span>
                            Gerenciamento de Vendas
                        </button>
                        <hr style="margin:4px 0;border:none;border-top:1px solid #e2e8f0;">
                        <button class="menu-item logout-item" onclick="fazerLogout(); toggleMenu();">
                            <span class="material-symbols-rounded">logout</span>
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Banner de Aviso Nome do Comércio -->
        <div id="bannerNomeComercio" style="display:none;background:#fef3c7;border-left:4px solid #f59e0b;padding:16px 20px;margin-bottom:0;align-items:center;justify-content:space-between;gap:16px;z-index:100;">
            <div style="display:flex;align-items:center;gap:12px;flex:1;">
                <div style="width:32px;height:32px;border-radius:50%;background:#f59e0b;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="color:white;"><path fill="currentColor" d="m2 7l-1 5v2h1v6h10v-6h4v6h2v-6h1v-2l-1-5zm8 11H4v-4h6zm-6.96-6l.6-3h12.72l.6 3zM18 6H2V4h16zm5 1v6h-2V7zm-2 8h2v2h-2z"/></svg>
                </div>
                <div style="flex:1;">
                    <div style="font-weight:600;color:#78350f;font-size:14px;margin-bottom:4px;">Adicione o nome do seu comércio</div>
                    <div style="font-size:12px;color:#92400e;">O nome do comércio aparecerá no cabeçalho ao invés do seu nome completo</div>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:12px;">
                <button onclick="abrirModalEditarConta()" style="background:#f59e0b;color:white;border:none;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;white-space:nowrap;" onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">
                    Adicionar
                </button>
                <button onclick="fecharBannerNomeComercio()" style="background:none;border:none;color:#78350f;font-size:20px;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:4px;transition:all 0.2s;flex-shrink:0;" onmouseover="this.style.background='rgba(120,53,15,0.1)'" onmouseout="this.style.background='transparent'" title="Fechar">
                    ×
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="mudaTab('vendas', this)"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32" style="vertical-align: middle; margin-right: 4px;"><path fill="currentColor" d="M4 7a1 1 0 0 0 0 2h2.22l2.624 10.5c.223.89 1.02 1.5 1.937 1.5h12.47c.903 0 1.67-.6 1.907-1.47L27.75 10h-2.094l-2.406 9H10.78L8.157 8.5A1.984 1.984 0 0 0 6.22 7zm18 14c-1.645 0-3 1.355-3 3s1.355 3 3 3s3-1.355 3-3s-1.355-3-3-3m-9 0c-1.645 0-3 1.355-3 3s1.355 3 3 3s3-1.355 3-3s-1.355-3-3-3m3-14v5h-3l4 4l4-4h-3V7zm-3 16c.564 0 1 .436 1 1s-.436 1-1 1s-1-.436-1-1s.436-1 1-1m9 0c.564 0 1 .436 1 1s-.436 1-1 1s-1-.436-1-1s.436-1 1-1"/></svg> Vendas</button>
            <button class="tab" onclick="mudaTab('produtos', this)"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 1024 1024" style="vertical-align: middle; margin-right: 4px;"><path fill="currentColor" fill-rule="evenodd" d="M464 144c8.837 0 16 7.163 16 16v304c0 8.836-7.163 16-16 16H160c-8.837 0-16-7.164-16-16V160c0-8.837 7.163-16 16-16zm-52 68H212v200h200zm493.333 87.686c6.248 6.248 6.248 16.379 0 22.627l-181.02 181.02c-6.248 6.248-16.378 6.248-22.627 0l-181.019-181.02c-6.248-6.248-6.248-16.379 0-22.627l181.02-181.02c6.248-6.248 16.378-6.248 22.627 0zm-84.853 11.313L713 203.52L605.52 311L713 418.48zM464 544c8.837 0 16 7.164 16 16v304c0 8.837-7.163 16-16 16H160c-8.837 0-16-7.163-16-16V560c0-8.836 7.163-16 16-16zm-52 68H212v200h200zm452-68c8.837 0 16 7.164 16 16v304c0 8.837-7.163 16-16 16H560c-8.837 0-16-7.163-16-16V560c0-8.836 7.163-16 16-16zm-52 68H612v200h200z"/></svg> Produtos</button>
            <button class="tab" onclick="mudaTab('historico', this)"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 32 32" style="vertical-align: middle; margin-right: 4px;"><path fill="currentColor" d="M30 6V4h-3V2h-2v2h-1c-1.103 0-2 .898-2 2v2c0 1.103.897 2 2 2h4v2h-6v2h3v2h2v-2h1c1.103 0 2-.897 2-2v-2c0-1.102-.897-2-2-2h-4V6zm-6 14v2h2.586L23 25.586l-2.292-2.293a1 1 0 0 0-.706-.293H20a1 1 0 0 0-.706.293L14 28.586L15.414 30l4.587-4.586l2.292 2.293a1 1 0 0 0 1.414 0L28 23.414V26h2v-6zM4 30H2v-5c0-3.86 3.14-7 7-7h6c1.989 0 3.89.85 5.217 2.333l-1.49 1.334A5 5 0 0 0 15 20H9c-2.757 0-5 2.243-5 5zm8-14a7 7 0 1 0 0-14a7 7 0 0 0 0 14m0-12a5 5 0 1 1 0 10a5 5 0 0 1 0-10"/></svg> Histórico</button>
            <button class="tab" onclick="mudaTab('clientes', this)"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;"><path fill="currentColor" fill-rule="evenodd" d="M7.75 7.5a4.25 4.25 0 1 1 8.5 0a4.25 4.25 0 0 1-8.5 0M12 4.75a2.75 2.75 0 1 0 0 5.5a2.75 2.75 0 0 0 0-5.5m-4 10A2.25 2.25 0 0 0 5.75 17v1.188c0 .018.013.034.031.037c4.119.672 8.32.672 12.438 0a.04.04 0 0 0 .031-.037V17A2.25 2.25 0 0 0 16 14.75h-.34a.3.3 0 0 0-.079.012l-.865.283a8.75 8.75 0 0 1-5.432 0l-.866-.283a.3.3 0 0 0-.077-.012zM4.25 17A3.75 3.75 0 0 1 8 13.25h.34q.28.001.544.086l.866.283a7.25 7.25 0 0 0 4.5 0l.866-.283c.175-.057.359-.086.543-.086H16A3.75 3.75 0 0 1 19.75 17v1.188c0 .754-.546 1.396-1.29 1.517a40.1 40.1 0 0 1-12.92 0a1.54 1.54 0 0 1-1.29-1.517z" clip-rule="evenodd"/></svg> Clientes</button>
        </div>

        <div class="content">
            <!-- TAB VENDAS -->
            <div id="tab-vendas" class="tab-content active">
                <!-- Status da Impressora -->
                <div id="statusImpressora" style="background:white;border-radius:12px;padding:16px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:none;">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span class="material-symbols-rounded" id="impressoraIcon" style="font-size:24px;">print</span>
                            <div>
                                <div style="font-weight:600;color:#1e293b;font-size:14px;">Status da Impressora</div>
                                <div id="impressoraStatus" style="font-size:12px;color:#64748b;">Verificando...</div>
                            </div>
                        </div>
                        <span id="impressoraBadge" class="badge" style="background:#f3f4f6;color:#64748b;">Aguardando</span>
                    </div>
                </div>
                
                <!-- Modal de Atalhos -->
                <div id="modalAtalhos" class="modal">
                    <div class="modal-content" style="max-width:900px;">
                        <div class="modal-header">
                            <h2 style="display:flex;align-items:center;gap:8px;">
                                <span class="material-symbols-rounded" style="font-size:28px;color:#059669;">keyboard</span>
                                Atalhos do Sistema
                            </h2>
                            <button onclick="fecharModalAtalhos()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
                        </div>
                        <div style="padding:24px;">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                                <!-- Coluna Esquerda -->
                                <div>
                                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">1</span>
                                            <span style="color:#78350f;">Finalizar Venda à Vista</span>
                                        </div>
                                    </div>
                                    <div style="background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">5</span>
                                            <span style="color:#4b5563;">Consultar Mercadoria</span>
                                        </div>
                                    </div>
                                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">9</span>
                                            <span style="color:#78350f;">Pegar o peso da Balança Eletrônica</span>
                                        </div>
                                    </div>
                                    <div style="background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">Espaço</span>
                                            <span style="color:#4b5563;">Encontrar mercadoria pelo nome</span>
                                        </div>
                                    </div>
                                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">F1</span>
                                            <span style="color:#78350f;">Entrada/Retirada no caixa</span>
                                        </div>
                                    </div>
                                    <div style="background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">F5</span>
                                            <span style="color:#4b5563;">Abrir Gaveta do dinheiro</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Coluna Direita -->
                                <div>
                                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">2</span>
                                            <span style="color:#78350f;">Finalizar Venda a Prazo</span>
                                        </div>
                                    </div>
                                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">3</span>
                                            <span style="color:#78350f;">Cancelar Item registrado durante a venda</span>
                                        </div>
                                    </div>
                                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">4</span>
                                            <span style="color:#78350f;">Cancelar VENDAS ANTIGAS ou imprimir cupom antigo</span>
                                        </div>
                                    </div>
                                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">6</span>
                                            <span style="color:#78350f;">Pausa (parar temporariamente o caixa)</span>
                                        </div>
                                    </div>
                                    <div style="background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">7</span>
                                            <span style="color:#4b5563;">Orçamento de Preço</span>
                                        </div>
                                    </div>
                                    <div style="background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">8</span>
                                            <span style="color:#4b5563;">Consultar movimento do Caixa</span>
                                        </div>
                                    </div>
                                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">0</span>
                                            <span style="color:#78350f;">Fechar esta tela de Vendas</span>
                                        </div>
                                    </div>
                                    <div style="background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">F8</span>
                                            <span style="color:#4b5563;">Abrir a Calculadora</span>
                                        </div>
                                    </div>
                                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">F2</span>
                                            <span style="color:#78350f;">Reimprimir cupom da última venda</span>
                                        </div>
                                    </div>
                                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-button">F3</span>
                                            <span style="color:#78350f;">Imprimir comprovante com assinatura da última venda</span>
                                        </div>
                                    </div>
                                    <div style="background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span class="key-combination">
                                                <span class="key-button">Shift</span>
                                                <span class="key-separator">+</span>
                                                <span class="key-button">A</span>
                                            </span>
                                            <span style="color:#4b5563;">Anotações</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                

                <div class="vendas-grid">
                    <div class="carrinho">
                        <h3><span class="material-symbols-rounded">shopping_cart</span> Carrinho</h3>
                        <div id="carrinhoItens"></div>
                        <div class="carrinho-total">
                            <div class="linha">
                                <span>Subtotal:</span>
                                <span id="subtotal">R$ 0,00</span>
                            </div>
                            <div class="linha">
                                <span>Desconto:</span>
                                <input type="number" id="desconto" value="0" min="0" step="0.01" style="width:100px;text-align:right;" onchange="atualizarCarrinho()">
                            </div>
                            <div class="linha total">
                                <span>TOTAL:</span>
                                <span id="total">R$ 0,00</span>
                            </div>
                            <button class="btn btn-success" onclick="finalizarVenda()"><span class="material-symbols-rounded">check_circle</span> Finalizar Venda</button>
                            <button class="btn btn-secondary" style="width:100%;margin-top:10px;" onclick="limparCarrinho()"><span class="material-symbols-rounded">delete</span> Limpar Carrinho</button>
                        </div>
                    </div>
                    
                    <div>
                        <div class="busca-produto">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                                <div id="leitorStatus" style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:6px;background:#f1f5f9;font-size:14px;">
                                    <span id="leitorIcon" style="display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;color:#64748b;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="currentColor" d="M4 3a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4.176A2 2 0 0 1 8 10.179V9a2 2 0 0 1 1-1.732V6a2 2 0 0 1 2-2h2c.293 0 .572.063.823.177A2 2 0 0 0 12 3zm.5 9h4.344l.656.915V13h-5a.5.5 0 0 1 0-1M10 6v2a1 1 0 0 0-1 1v1.179a1 1 0 0 0 .187.582l1.313 1.833V14a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-1.406l1.309-1.8a1 1 0 0 0 .191-.588V9a1 1 0 0 0-1-1V6a1 1 0 0 0-1-1h-2a1 1 0 0 0-1 1m3 0v2h-2V6z"/></svg></span>
                                    <span id="leitorTexto">Aguardando conexão do leitor...</span>
                                </div>
                            </div>
                            <input type="text" id="buscaCodigo" placeholder="Digite o código ou nome do produto..." onkeyup="buscarProdutoVendas(event)" onkeydown="detectarLeitorUSB(event)" onclick="this.focus()" style="font-size:16px;">
                        </div>
                        <div class="produtos-grid" id="produtosGrid"></div>
                    </div>
                </div>
            </div>

            <!-- TAB PRODUTOS -->
            <div id="tab-produtos" class="tab-content">
                <div class="produtos-header">
                    <h2>Gerenciar Produtos</h2>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="abrirModalProduto()"><span class="material-symbols-rounded">add_circle</span> Adicionar Produto</button>
                        <button class="btn btn-primary" onclick="document.getElementById('fileImport').click()" style="background:#0891b2;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;"><g fill="none" stroke="currentColor" stroke-width="1.6"><ellipse cx="11" cy="5" rx="8" ry="3"/><path stroke-linecap="round" d="M6 10.842c.602.18 1.274.33 2 .44M11 15c-4.418 0-8-1.343-8-3m3 5.842c.602.18 1.274.33 2 .44"/><path stroke-linecap="round" stroke-linejoin="round" d="M11 22c-4.418 0-8-1.343-8-3V5m16 0v7m0 4.674l-1.174-1.487C17.2 14.396 16.888 14 16.5 14s-.7.396-1.326 1.187L14 16.674m2.5-2.587V22"/></g></svg> Importar Produto</button>
                        <input type="file" id="fileImport" accept=".xlsx,.xls,.csv" style="display:none;" onchange="importarProdutos(event)">
                        <button class="btn btn-secondary" onclick="selecionarTodosProdutos()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16" style="vertical-align: middle; margin-right: 4px;"><path fill="currentColor" d="M4.5 2A2.5 2.5 0 0 0 2 4.5v5A2.5 2.5 0 0 0 4.5 12h5A2.5 2.5 0 0 0 12 9.5v-5A2.5 2.5 0 0 0 9.5 2zm5.354 3.854l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L6.5 7.793l2.646-2.647a.5.5 0 1 1 .708.708M5 13c.456.607 1.182 1 2 1h2.5A4.5 4.5 0 0 0 14 9.5V6c0-.818-.393-1.544-1-2v5.5A3.5 3.5 0 0 1 9.5 13z"/></svg> Selecionar Todos</button>
                        <button id="btnRemoverProdutos" class="btn" onclick="removerProdutosSelecionados()" style="background:#dc2626;color:white;" disabled><span class="material-symbols-rounded">delete_sweep</span> Remover Selecionados</button>
                    </div>
                </div>
                <div style="margin-bottom:20px;">
                    <input type="text" id="buscaProdutos" class="busca-input" placeholder="Buscar produtos por código ou nome..." onkeyup="buscarProdutosTabela(event)">
                </div>
                <table class="tabela">
                    <thead>
                        <tr>
                            <th style="width:40px;"><input type="checkbox" id="checkTodos" onchange="toggleTodosProdutos(this.checked)"></th>
                            <th>Código</th>
                            <th>Foto</th>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Preço</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaProdutos"></tbody>
                </table>
            </div>

            <!-- TAB HISTÓRICO -->
            <div id="tab-historico" class="tab-content">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h2>Histórico de Vendas</h2>
                    <div style="display:flex;gap:12px;">
                        <button class="btn btn-secondary" onclick="selecionarTodosHistorico()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16" style="vertical-align: middle; margin-right: 4px;"><path fill="currentColor" d="M4.5 2A2.5 2.5 0 0 0 2 4.5v5A2.5 2.5 0 0 0 4.5 12h5A2.5 2.5 0 0 0 12 9.5v-5A2.5 2.5 0 0 0 9.5 2zm5.354 3.854l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L6.5 7.793l2.646-2.647a.5.5 0 1 1 .708.708M5 13c.456.607 1.182 1 2 1h2.5A4.5 4.5 0 0 0 14 9.5V6c0-.818-.393-1.544-1-2v5.5A3.5 3.5 0 0 1 9.5 13z"/></svg> Selecionar Todos</button>
                        <button id="btnRemoverHistorico" class="btn" onclick="removerVendasSelecionadas()" style="background:#dc2626;color:white;" disabled><span class="material-symbols-rounded">delete_sweep</span> Remover Selecionadas</button>
                    </div>
                </div>
                <!-- Filtros -->
                <div class="filtros-container">
                    <div class="filtros-grid">
                        <div class="filtro-item" style="min-width:200px;">
                            <label>Buscar por Cliente</label>
                            <input type="text" id="filtroClienteHistorico" class="busca-input" placeholder="Nome do cliente..." onkeyup="filtrarHistorico()">
                        </div>
                        <div class="filtro-item" style="min-width:180px;">
                            <label>Forma de Pagamento</label>
                            <select id="filtroPagamentoHistorico" onchange="filtrarHistorico()">
                                <option value="">Todas</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Débito">Débito</option>
                                <option value="Crédito">Crédito</option>
                                <option value="PIX">PIX</option>
                                <option value="A Prazo">A Prazo</option>
                            </select>
                        </div>
                        <div class="filtro-item" style="min-width:200px;">
                            <label>Buscar por Produto/Item</label>
                            <input type="text" id="filtroProdutoHistorico" class="busca-input" placeholder="Nome do produto..." onkeyup="filtrarHistorico()">
                        </div>
                        <div class="filtro-item" style="min-width:150px;">
                            <label>Data</label>
                            <input type="date" id="filtroDataHistorico" onchange="filtrarHistorico()">
                        </div>
                        <div class="filtro-actions">
                            <button class="btn btn-secondary" onclick="limparFiltrosHistorico()">
                                <span class="material-symbols-rounded">clear</span>
                                Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>
                <table class="tabela">
                    <thead>
                        <tr>
                            <th style="width:40px;"><input type="checkbox" id="checkTodosHistorico" onchange="toggleTodosHistorico(this.checked)"></th>
                            <th>#</th>
                            <th>Data/Hora</th>
                            <th>Itens</th>
                            <th>Total</th>
                            <th>Pagamento</th>
                            <th>Cliente</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaHistorico"></tbody>
                </table>
            </div>
            
            <!-- TAB CLIENTES -->
            <div id="tab-clientes" class="tab-content">
                <div style="margin-bottom:24px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2>Clientes</h2>
                        <div style="display:flex;gap:12px;">
                            <button class="btn btn-primary" onclick="abrirModalCliente()">
                                <span class="material-symbols-rounded">add_circle</span>
                                Adicionar Cliente
                            </button>
                            <button class="btn btn-secondary" onclick="selecionarTodosClientes()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16" style="vertical-align: middle; margin-right: 4px;"><path fill="currentColor" d="M4.5 2A2.5 2.5 0 0 0 2 4.5v5A2.5 2.5 0 0 0 4.5 12h5A2.5 2.5 0 0 0 12 9.5v-5A2.5 2.5 0 0 0 9.5 2zm5.354 3.854l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L6.5 7.793l2.646-2.647a.5.5 0 1 1 .708.708M5 13c.456.607 1.182 1 2 1h2.5A4.5 4.5 0 0 0 14 9.5V6c0-.818-.393-1.544-1-2v5.5A3.5 3.5 0 0 1 9.5 13z"/></svg> Selecionar Todos</button>
                            <button id="btnRemoverClientes" class="btn" onclick="removerClientesSelecionados()" style="background:#dc2626;color:white;" disabled><span class="material-symbols-rounded">delete_sweep</span> Remover Selecionados</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <input type="text" id="buscaClientes" class="busca-input" placeholder="Buscar clientes por nome ou CPF..." onkeyup="buscarClientes(event)">
                    </div>
                    
                    <!-- Filtros -->
                    <div class="filtros-container">
                        <div class="filtros-grid">
                            <div class="filtro-item" style="min-width:150px;">
                                <label>Número</label>
                                <input type="number" id="filtroStatusCliente" min="0" step="1" placeholder="Filtrar por número" onchange="filtrarClientes()" onkeyup="filtrarClientes()">
                            </div>
                            <div class="filtro-item" style="min-width:120px;">
                                <label>Dia</label>
                                <select id="filtroDiaCliente" onchange="filtrarClientes()">
                                    <option value="">Todos</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                    <option value="21">21</option>
                                    <option value="22">22</option>
                                    <option value="23">23</option>
                                    <option value="24">24</option>
                                    <option value="25">25</option>
                                    <option value="26">26</option>
                                    <option value="27">27</option>
                                    <option value="28">28</option>
                                    <option value="29">29</option>
                                    <option value="30">30</option>
                                    <option value="31">31</option>
                                </select>
                            </div>
                            <div class="filtro-item" style="min-width:150px;">
                                <label>Mês</label>
                                <select id="filtroMesCliente" onchange="filtrarClientes()">
                                    <option value="">Todos</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Março</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="filtro-actions">
                                <button class="btn btn-secondary" onclick="limparFiltrosClientes()">
                                    <span class="material-symbols-rounded">clear</span>
                                    Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela de Clientes -->
                <table class="tabela">
                    <thead>
                        <tr>
                            <th style="width:40px;"><input type="checkbox" id="checkTodosClientes" onchange="toggleTodosClientes(this.checked)"></th>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th>Valor</th>
                            <th>Data</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaClientes"></tbody>
                </table>
                </div>
            </div>
            
            <!-- TAB A CONTA -->
            <div id="tab-conta" class="tab-content">
                <div style="max-width:600px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
                        <h2 style="margin:0;">Minha Conta</h2>
                        <button class="btn btn-primary" onclick="abrirModalEditarConta()" style="display:inline-flex;align-items:center;gap:6px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle;flex-shrink:0;"><path fill="currentColor" d="m7 17.013l4.413-.015l9.632-9.54c.378-.378.586-.88.586-1.414s-.208-1.036-.586-1.414l-1.586-1.586c-.756-.756-2.075-.752-2.825-.003L7 12.583zM18.045 4.458l1.589 1.583l-1.597 1.582l-1.586-1.585zM9 13.417l6.03-5.973l1.586 1.586l-6.029 5.971L9 15.006z"/><path fill="currentColor" d="M5 21h14c1.103 0 2-.897 2-2v-8.668l-2 2V19H8.158c-.026 0-.053.01-.079.01c-.033 0-.066-.009-.1-.01H5V5h6.847l2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2"/></svg>
                            Editar
                        </button>
                    </div>
                    <div class="stat-card" style="margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
                            <div style="position:relative;display:inline-block;">
                                <div id="contaFotoDisplay" style="width:80px;height:80px;border-radius:50%;background:#059669;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;">
                                    <span id="contaFotoIconDisplay" class="material-symbols-rounded" style="font-size:48px;color:white;">account_circle</span>
                                    <img id="contaFotoImgDisplay" src="" alt="Foto" style="width:100%;height:100%;object-fit:cover;display:none;">
                                </div>
                                <button id="btnRemoverFotoConta" onclick="removerFotoPerfil()" style="position:absolute;bottom:0;right:0;background:#dc2626;color:white;width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;cursor:pointer;border:2px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.15);transition:all 0.2s;flex-shrink:0;" onmouseover="this.style.background='#b91c1c';this.style.transform='scale(1.1)'" onmouseout="this.style.background='#dc2626';this.style.transform='scale(1)'" title="Remover foto">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" style="color:white;"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"/></svg>
                                </button>
                            </div>
                            <div>
                                <h3 style="font-size:20px;color:#1e293b;margin-bottom:4px;" id="contaNome"></h3>
                                <p style="color:#64748b;font-size:14px;" id="contaEmail"></p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3 style="margin-bottom:16px;color:#64748b;font-size:14px;font-weight:600;">INFORMAÇÕES DA CONTA</h3>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;color:#475569;font-size:12px;font-weight:600;margin-bottom:4px;">Nome Completo</label>
                            <p style="color:#1e293b;font-size:14px;" id="contaInfoNome"></p>
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;color:#475569;font-size:12px;font-weight:600;margin-bottom:4px;">Email</label>
                            <p style="color:#1e293b;font-size:14px;" id="contaInfoEmail"></p>
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="display:block;color:#475569;font-size:12px;font-weight:600;margin-bottom:4px;">Nome do Comércio</label>
                            <p style="color:#1e293b;font-size:14px;" id="contaInfoNomeComercio"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB GERENCIAMENTO DE VENDAS -->
            <div id="tab-gerenciamento" class="tab-content">
                <div class="estatisticas" style="margin-bottom:24px;">
                    <div class="stat-card">
                        <h3><span class="material-symbols-rounded">calendar_today</span> Vendas Hoje</h3>
                        <div class="valor" id="vendasHoje">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <h3><span class="material-symbols-rounded">event</span> Vendas Mês</h3>
                        <div class="valor" id="vendasMes">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <h3><span class="material-symbols-rounded">category</span> Total Produtos</h3>
                        <div class="valor" id="totalProdutos">0</div>
                    </div>
                </div>
                <div style="margin-bottom:24px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="margin:0;">Gerenciamento de Vendas</h2>
                        <div style="display:flex;gap:12px;">
                            <button class="btn btn-secondary" onclick="selecionarTodosGerenciamento()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16" style="vertical-align: middle; margin-right: 4px;"><path fill="currentColor" d="M4.5 2A2.5 2.5 0 0 0 2 4.5v5A2.5 2.5 0 0 0 4.5 12h5A2.5 2.5 0 0 0 12 9.5v-5A2.5 2.5 0 0 0 9.5 2zm5.354 3.854l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L6.5 7.793l2.646-2.647a.5.5 0 1 1 .708.708M5 13c.456.607 1.182 1 2 1h2.5A4.5 4.5 0 0 0 14 9.5V6c0-.818-.393-1.544-1-2v5.5A3.5 3.5 0 0 1 9.5 13z"/></svg> Selecionar Todos</button>
                            <button id="btnRemoverGerenciamento" class="btn" onclick="removerVendasGerenciamentoSelecionadas()" style="background:#dc2626;color:white;" disabled><span class="material-symbols-rounded">delete_sweep</span> Remover Selecionadas</button>
                        </div>
                    </div>
                    <div class="filtros-container">
                        <div class="filtros-grid">
                            <div class="filtro-item" style="min-width:200px;">
                                <label>Buscar por Data</label>
                                <input type="date" id="filtroData" onchange="filtrarVendas()">
                            </div>
                            <div class="filtro-item" style="min-width:200px;">
                                <label>Buscar por Produto</label>
                                <input type="text" id="filtroProduto" class="busca-input" placeholder="Digite o nome do produto..." onkeyup="filtrarVendas()">
                            </div>
                            <div class="filtro-actions">
                                <button class="btn btn-secondary" onclick="limparFiltros()">
                                    <span class="material-symbols-rounded">clear</span>
                                    Limpar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <table class="tabela">
                    <thead>
                        <tr>
                            <th style="width:40px;"><input type="checkbox" id="checkTodosGerenciamento" onchange="toggleTodosGerenciamento(this.checked)"></th>
                            <th>#</th>
                            <th>Data/Hora</th>
                            <th>Produtos e Quantidades</th>
                            <th>Total Venda</th>
                            <th>Forma Pagamento</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaGerenciamento"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal de Confirmação -->
    <div class="confirm-modal" id="modalConfirm">
        <div class="confirm-box">
            <div class="confirm-title" id="confirmTitle">Confirmação</div>
            <div class="confirm-text" id="confirmMessage">Tem certeza?</div>
            <div class="confirm-actions">
                <button id="confirmCancel" class="btn btn-outline">Cancelar</button>
                <button id="confirmOk" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Produto -->
    <div id="modalProduto" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Adicionar Produto</h2>
                <button onclick="fecharModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
            </div>
            <form onsubmit="salvarProduto(event)">
                <div class="form-group">
                    <label>Código *</label>
                    <input type="text" id="produtoCodigo" required>
                </div>
                <div class="form-group">
                    <label>Nome *</label>
                    <input type="text" id="produtoNome" required>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <input type="text" id="produtoCategoria">
                </div>
                <div class="form-group">
                    <label>Preço *</label>
                    <input type="number" id="produtoPreco" step="0.01" required>
                </div>
                <button type="submit" class="btn btn-success" id="btnSalvarProduto" style="display:inline-flex;align-items:center;gap:8px;min-width:130px;justify-content:center;">
                    <span id="btnSalvarProdutoLabel" style="display:inline-flex;align-items:center;">
                        Salvar
                    </span>
                    <span id="btnSalvarProdutoSpinner" style="display:none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 384" class="loader">
                          <circle
                            r="176"
                            cy="192"
                            cx="192"
                            stroke-width="32"
                            fill="transparent"
                            pathLength="360"
                            class="loader-active"
                          ></circle>
                          <circle
                            r="176"
                            cy="192"
                            cx="192"
                            stroke-width="32"
                            fill="transparent"
                            pathLength="360"
                            class="loader-track"
                          ></circle>
                        </svg>
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Pagamento -->
    <div id="modalPagamento" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Finalizar Venda</h2>
                <button onclick="fecharModalPagamento()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
            </div>
            <div style="margin-bottom:24px;padding:20px;background:#f8fafc;border-radius:12px;text-align:center;">
                <div style="font-size:13px;color:#64748b;font-weight:600;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">Total a Pagar</div>
                <h3 style="color:#1e293b;font-size:42px;font-weight:700;letter-spacing:-1px;" id="totalPagamento">R$ 0,00</h3>
            </div>
            <div class="form-group">
                <label>Forma de Pagamento</label>
                <select id="formaPagamento" onchange="calcularTroco(); this.style.borderColor='#cbd5e1';" style="width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:8px;font-size:14px;background:white;">
                    <option value="" selected>Selecione a forma de pagamento</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Débito">Débito</option>
                    <option value="Crédito">Crédito</option>
                    <option value="PIX">PIX</option>
                    <option value="A Prazo">A Prazo</option>
                </select>
            </div>
            <div class="form-group" id="divValorRecebido" style="display:none;">
                <label>Valor Recebido *</label>
                <input type="number" id="valorRecebido" step="0.01" min="0" onkeyup="calcularTroco(); this.style.borderColor='#cbd5e1';" oninput="calcularTroco(); this.style.borderColor='#cbd5e1';" style="width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:8px;font-size:14px;" placeholder="0,00">
            </div>
            <div class="form-group" id="divTroco" style="display:none;">
                <label>Troco</label>
                <div style="background:#d1fae5;padding:16px;border-radius:10px;text-align:center;margin-top:8px;">
                    <h3 style="color:#065f46;font-size:28px;font-weight:700;margin:0;" id="troco">R$ 0,00</h3>
                </div>
            </div>
            <div class="form-group" id="divClientePrazo" style="display:none;">
                <label>Cliente *</label>
                <select id="clientePrazo" required style="width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:8px;font-size:14px;background:white;">
                    <option value="">Selecione o cliente</option>
                </select>
            </div>
            <button type="button" class="btn btn-success" onclick="confirmarVenda()" id="btnConfirmarVenda" style="display:inline-flex;align-items:center;gap:8px;min-width:160px;justify-content:center;">
                <span id="btnConfirmarVendaLabel" style="display:inline-flex;align-items:center;gap:6px;">
                    <span class="material-symbols-rounded" style="font-size:18px;">check_circle</span>
                    Confirmar Venda
                </span>
                <span id="btnConfirmarVendaSpinner" style="display:none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 384" class="loader">
                      <circle
                        r="176"
                        cy="192"
                        cx="192"
                        stroke-width="32"
                        fill="transparent"
                        pathLength="360"
                        class="loader-active"
                      ></circle>
                      <circle
                        r="176"
                        cy="192"
                        cx="192"
                        stroke-width="32"
                        fill="transparent"
                        pathLength="360"
                        class="loader-track"
                      ></circle>
                    </svg>
                </span>
            </button>
        </div>
    </div>

    <!-- Modal Detalhes Venda -->
    <div id="modalDetalhesVenda" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h2 id="modalDetalhesVendaTitle">VENDA #0</h2>
                <button onclick="fecharModalDetalhesVenda()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
            </div>
            <div id="modalDetalhesVendaContent" style="padding:24px;">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal Editar Conta -->
    <div id="modalEditarConta" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h2>Editar Conta</h2>
                <button onclick="fecharModalEditarConta()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
            </div>
            <form onsubmit="salvarConta(event)">
                <div style="text-align:center;margin-bottom:24px;">
                    <div style="position:relative;display:inline-block;">
                        <div id="contaFotoPreview" style="width:120px;height:120px;border-radius:50%;background:#059669;display:flex;align-items:center;justify-content:center;margin:0 auto;overflow:hidden;border:4px solid #e2e8f0;cursor:pointer;transition:all 0.2s;" onclick="document.getElementById('contaFotoInput').click()">
                            <span id="contaFotoIcon" class="material-symbols-rounded" style="font-size:64px;color:white;">account_circle</span>
                            <img id="contaFotoImg" src="" alt="Foto" style="width:100%;height:100%;object-fit:cover;display:none;">
                        </div>
                        <div style="position:absolute;bottom:0;right:0;background:#059669;color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.15);" onclick="document.getElementById('contaFotoInput').click()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="color:white;"><path fill="currentColor" fill-rule="evenodd" d="M12 3a1 1 0 0 1 .78.375l4 5a1 1 0 1 1-1.56 1.25L13 6.85V14a1 1 0 1 1-2 0V6.85L8.78 9.626a1 1 0 1 1-1.56-1.25l4-5A1 1 0 0 1 12 3M9 14v-1H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2h-4v1a3 3 0 1 1-6 0m8 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2z" clip-rule="evenodd"/></svg>
                        </div>
                        <input type="file" id="contaFotoInput" accept="image/*" style="display:none;" onchange="previewFotoConta(this.files[0])">
                    </div>
                    <p style="margin-top:12px;color:#64748b;font-size:13px;">Clique na foto para alterar</p>
                </div>
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="contaEditarNome" required placeholder="Digite o nome completo">
                </div>
                <div class="form-group">
                    <label>Nome do Comércio</label>
                    <input type="text" id="contaEditarNomeComercio" placeholder="Digite o nome do comércio">
                    <small style="color:#64748b;font-size:12px;margin-top:4px;display:block;">O nome do comércio aparecerá no cabeçalho ao invés do nome completo</small>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="contaEditarEmail" required placeholder="Digite o email">
                </div>
                <div class="form-group">
                    <label>Nova Senha (deixe em branco para não alterar)</label>
                    <input type="password" id="contaEditarSenha" placeholder="Digite a nova senha">
                </div>
                <div class="form-group">
                    <label>Confirmar Nova Senha</label>
                    <input type="password" id="contaEditarSenhaConfirm" placeholder="Confirme a nova senha">
                </div>
                <button type="submit" class="btn btn-success" id="btnSalvarConta" style="display:inline-flex;align-items:center;gap:8px;min-width:160px;justify-content:center;">
                    <span id="btnSalvarContaLabel" style="display:inline-flex;align-items:center;gap:6px;">
                        <span class="material-symbols-rounded" style="font-size:18px;">save</span>
                        Salvar Alterações
                    </span>
                    <span id="btnSalvarContaSpinner" style="display:none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 384" class="loader">
                          <circle
                            r="176"
                            cy="192"
                            cx="192"
                            stroke-width="32"
                            fill="transparent"
                            pathLength="360"
                            class="loader-active"
                          ></circle>
                          <circle
                            r="176"
                            cy="192"
                            cx="192"
                            stroke-width="32"
                            fill="transparent"
                            pathLength="360"
                            class="loader-track"
                          ></circle>
                        </svg>
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div id="modalCliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalClienteTitle">Adicionar Cliente</h2>
                <button onclick="fecharModalCliente()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
            </div>
            <form onsubmit="salvarCliente(event)">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="clienteNome" required placeholder="Digite o nome completo">
                </div>
                <div class="form-group">
                    <label>CPF *</label>
                    <input type="text" id="clienteCpf" required placeholder="000.000.000-00" maxlength="14" oninput="aplicarMascaraCPF(this)">
                    <small style="color:#64748b;font-size:12px;margin-top:4px;display:block;" id="cpfErro"></small>
                </div>
                <button type="submit" class="btn btn-success">Salvar</button>
            </form>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const XLSX = require('xlsx');

        // Variáveis globais
        let produtos = [];
        let vendas = [];
        let carrinho = [];
        let clientes = [];
        let clientesFiltrados = [];
        let vendasFiltradasHistorico = [];
        let editandoClienteId = null;
        
        // Variáveis para leitor de código de barras USB
        let leitorConectado = false;
        let ultimaLeitura = '';
        let tempoUltimaTecla = 0;
        let bufferLeitura = '';
        let timeoutLeitura = null;
        let capturandoLeitura = false;
        let bufferGlobalLeitura = '';
        let leitorInicializado = false;
        let intervaloLeitor = null;
        let nextId = 1;
        let editandoId = null;
        let usuarioLogado = null;

        // ============ PAGINAÇÃO E VIRTUALIZAÇÃO PARA GRANDES VOLUMES ============
        
        // Configurações de paginação
        const ITENS_POR_PAGINA_TABELA = 100; // Tabela: 100 produtos por vez
        const ITENS_POR_PAGINA_GRID = 50; // Grid: 50 produtos por vez
        let paginaAtualTabela = 1;
        let produtosVisiveis = [];
        let buscaCache = null;
        let ultimoTermoBusca = '';

        // ============ OTIMIZAÇÕES DE PERFORMANCE ============
        
        // Detectar performance do dispositivo (PCs lentos)
        const isLowPerformance = (() => {
            try {
                // Verificar se é possível medir performance
                if (!window.performance || !window.performance.memory) {
                    // Se não conseguir medir, assumir PC lento para segurança
                    return true;
                }
                const memInfo = window.performance.memory;
                // Considerar PC lento se RAM < 6GB (6 * 1024 * 1024 * 1024 bytes)
                const lowRam = memInfo.jsHeapSizeLimit < 6 * 1024 * 1024 * 1024;
                // Verificar hardwareConcurrency (número de cores)
                const lowCores = navigator.hardwareConcurrency <= 2;
                return lowRam || lowCores;
            } catch (e) {
                return true; // Em caso de erro, assumir PC lento
            }
        })();

        // Debounce - reduz chamadas de funções frequentes
        function debounce(func, wait = 150) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Throttle - limita execução de funções
        function throttle(func, limit = 100) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // Memoização simples
        function memoize(fn) {
            const cache = new Map();
            return function(...args) {
                const key = JSON.stringify(args);
                if (cache.has(key)) {
                    return cache.get(key);
                }
                const result = fn.apply(this, args);
                cache.set(key, result);
                return result;
            };
        }

        // Abrir modal otimizado com requestAnimationFrame
        function abrirModalOtimizado(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            // Usar requestAnimationFrame para animação suave
            requestAnimationFrame(() => {
                modal.classList.add('active');
                // Reduzir animações em PCs lentos
                if (isLowPerformance) {
                    modal.style.animation = 'none';
                    modal.querySelector('.modal-content').style.animation = 'none';
                }
            });
        }

        // Fechar modal otimizado
        function fecharModalOtimizado(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            requestAnimationFrame(() => {
                modal.classList.remove('active');
            });
        }

        // Click handler otimizado com throttle
        function handleClickOptimized(element, handler) {
            if (!element) return;
            const throttledHandler = throttle(handler, 200); // Throttle de 200ms
            element.addEventListener('click', throttledHandler, { passive: true });
        }

        // Adicionar CSS para reduzir animações em PCs lentos
        if (isLowPerformance) {
            const style = document.createElement('style');
            style.textContent = `
                /* Reduzir animações em PCs lentos */
                *, *::before, *::after {
                    animation-duration: 0.1s !important;
                    transition-duration: 0.1s !important;
                }
                /* Desabilitar backdrop-filter em PCs lentos */
                .modal {
                    backdrop-filter: none !important;
                    background: rgba(15, 23, 42, 0.8) !important;
                }
            `;
            document.head.appendChild(style);
        }

        // ============ AUTENTICAÇÃO ============
        
        // Verificar se é primeiro acesso
        async function verificarPrimeiroAcesso() {
            const primeiroAcesso = await ipcRenderer.invoke('verificar-primeiro-acesso');
            
            if (primeiroAcesso) {
                document.getElementById('loginWelcome').textContent = 'Bem-vindo! Crie sua conta para começar';
                // Esconder tabs e form de login quando é primeiro acesso
                document.getElementById('loginTabs').style.display = 'none';
                document.getElementById('formLogin').style.display = 'none';
                document.getElementById('formCadastro').classList.add('active');
            }
        }

        // Mudar entre Login e Cadastro
        function mudarLoginTab(tipo) {
            const tabs = document.querySelectorAll('.login-tab');
            const forms = document.querySelectorAll('.login-form');
            
            tabs.forEach(t => t.classList.remove('active'));
            forms.forEach(f => f.classList.remove('active'));
            
            if (tipo === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('formLogin').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('formCadastro').classList.add('active');
            }
            
            ocultarMensagens();
        }

        // Alternar mostrar/ocultar senha
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const eyeClosed = button.querySelector('.eye-closed');
            const eyeOpen = button.querySelector('.eye-open');
            
            if (input.type === 'password') {
                input.type = 'text';
                eyeClosed.style.display = 'none';
                eyeOpen.style.display = 'block';
            } else {
                input.type = 'password';
                eyeClosed.style.display = 'block';
                eyeOpen.style.display = 'none';
            }
        }

        // Fazer Login
        async function fazerLogin(event) {
            event.preventDefault();
            ocultarMensagens();
            
            const email = document.getElementById('loginEmail').value;
            const senha = document.getElementById('loginSenha').value;
            
            const result = await ipcRenderer.invoke('login', { email, senha });
            
            if (result.success) {
                usuarioLogado = result.usuario;
                document.getElementById('loginScreen').classList.add('hidden');
                atualizarNomeCabecalho();
                await carregarDadosUsuario();
                mostrarSucesso('Login realizado com sucesso!');
            } else {
                mostrarErro(result.error || 'Email ou senha incorretos');
            }
        }

        // Fazer Cadastro
        async function fazerCadastro(event) {
            event.preventDefault();
            ocultarMensagens();
            
            const nome = document.getElementById('cadastroNome').value;
            const email = document.getElementById('cadastroEmail').value;
            const senha = document.getElementById('cadastroSenha').value;
            const senhaConfirm = document.getElementById('cadastroSenhaConfirm').value;
            
            if (senha !== senhaConfirm) {
                mostrarErro('As senhas não coincidem!');
                return;
            }
            
            if (senha.length < 6) {
                mostrarErro('A senha deve ter no mínimo 6 caracteres!');
                return;
            }
            
            const result = await ipcRenderer.invoke('criar-usuario', { nome, email, senha });
            
            if (result.success) {
                mostrarSucessoCadastro('Conta criada com sucesso! Entrando automaticamente...');
                
                // Fazer login automático após cadastro (reduzido delay de 1000ms para 300ms)
                setTimeout(async () => {
                    const loginResult = await ipcRenderer.invoke('login', { email, senha });
                    
                    if (loginResult.success) {
                        usuarioLogado = loginResult.usuario;
                        document.getElementById('loginScreen').classList.add('hidden');
                        atualizarNomeCabecalho();
                        await carregarDadosUsuario();
                        mostrarSucesso('Bem-vindo ao PDV Desk!');
                    } else {
                        mostrarErro('Conta criada, mas erro ao fazer login. Tente fazer login manualmente.');
                        // Mostrar tabs novamente para permitir login
                        document.getElementById('loginTabs').style.display = 'flex';
                        document.getElementById('formLogin').style.display = 'block';
                        mudarLoginTab('login');
                    }
                }, 300);
            } else {
                mostrarErro(result.error || 'Erro ao criar conta. Email já cadastrado?');
            }
        }

        // Fazer Logout
        async function fazerLogout() {
            const ok = await showConfirm('Deseja realmente sair?');
            if (!ok) return;
            await ipcRenderer.invoke('logout');
            usuarioLogado = null;
            produtos = [];
            vendas = [];
            carrinho = [];
            
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginSenha').value = '';
            
            // Limpar displays
            document.getElementById('carrinhoItens').innerHTML = '';
            document.getElementById('tabelaProdutos').innerHTML = '';
            document.getElementById('tabelaHistorico').innerHTML = '';
            if (document.getElementById('tabelaClientes')) {
                document.getElementById('tabelaClientes').innerHTML = '';
            }
        }

        // Carregar dados do usuário
        async function carregarDadosUsuario() {
            // Carregar produtos
            produtos = await ipcRenderer.invoke('produtos-listar');
            nextId = produtos.length > 0 ? Math.max(...produtos.map(p => p.id)) + 1 : 1;
            
            // Carregar vendas
            vendas = await ipcRenderer.invoke('vendas-listar');
            
            // Carregar clientes
            clientes = await ipcRenderer.invoke('clientes-listar');
            clientesFiltrados = [...clientes];
            
            // Atualizar interface
            carregarProdutosGrid();
            atualizarEstatisticas();
            carregarProdutos();
            carregarConta();
            atualizarNomeCabecalho();
            
            // Inicializar leitor USB após carregar dados (sem delay desnecessário)
            inicializarLeitorUSB();
        }

        // Mensagens de erro/sucesso
        function mostrarErro(mensagem) {
            const el = document.getElementById('loginError');
            el.textContent = mensagem;
            el.classList.add('show');
        }

        function mostrarSucessoCadastro(mensagem) {
            const el = document.getElementById('loginSuccess');
            el.textContent = mensagem;
            el.classList.add('show');
        }

        function ocultarMensagens() {
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('loginSuccess').classList.remove('show');
        }

        // ============ FUNÇÕES DO PDV ============

        // Função de compatibilidade (não usa mais localStorage)
        function salvarDados() {
            // Dados salvos automaticamente no banco via IPC
        }

        // Converter valor monetário brasileiro (R$ 1.330,00) para número
        function parsearValorMonetario(valorStr) {
            if (!valorStr) return 0;
            
            // Remover "R$ " e espaços
            let valor = String(valorStr).trim().replace(/R\$\s*/g, '').trim();
            
            // Se está vazio, retornar 0
            if (!valor) return 0;
            
            // Verificar se tem vírgula (separador decimal brasileiro)
            if (valor.includes(',')) {
                // Dividir por vírgula: parte inteira e parte decimal
                const partes = valor.split(',');
                // Remover pontos da parte inteira (separadores de milhar)
                const parteInteira = partes[0].replace(/\./g, '');
                // Juntar parte inteira + ponto + parte decimal (máximo 2 dígitos)
                const parteDecimal = partes[1] ? partes[1].substring(0, 2).padEnd(2, '0') : '00';
                // Converter para número: "1330.00" → 1330.00
                return parseFloat(parteInteira + '.' + parteDecimal) || 0;
            } else {
                // Não tem vírgula, pode ter ponto como separador decimal ou apenas número
                // Se tem ponto, pode ser decimal (ex: "1330.50") ou separador de milhar (ex: "1.330")
                // Se tem mais de um ponto ou o ponto está no meio, é separador de milhar
                const pontos = (valor.match(/\./g) || []).length;
                if (pontos > 1 || (pontos === 1 && valor.split('.')[0].length > 3)) {
                    // É separador de milhar, remover pontos
                    return parseFloat(valor.replace(/\./g, '')) || 0;
                } else {
                    // É decimal ou número simples
                    return parseFloat(valor) || 0;
                }
            }
        }

        // Formatar número para moeda brasileira (R$ 1.330,00)
        function formatarMoeda(valor) {
            const num = typeof valor === 'string' ? parsearValorMonetario(valor) : parseFloat(valor || 0);
            // Formatar com separador de milhar e vírgula decimal
            return 'R$ ' + num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Toggle menu
        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            const menuIcon = document.getElementById('menuIcon');
            menu.classList.toggle('active');
            
            // Atualizar ícone baseado no estado do menu
            if (menu.classList.contains('active')) {
                menuIcon.textContent = 'close';
            } else {
                menuIcon.textContent = 'menu';
            }
        }
        
        // Fechar menu ao clicar fora - Otimizado com debounce
        document.addEventListener('click', debounce(function(event) {
            const menu = document.getElementById('menuDropdown');
            const menuButton = document.querySelector('.menu-button');
            const menuIcon = document.getElementById('menuIcon');
            if (menu && menuButton && !menu.contains(event.target) && !menuButton.contains(event.target)) {
                requestAnimationFrame(() => {
                    menu.classList.remove('active');
                    // Atualizar ícone quando menu é fechado
                    if (menuIcon) {
                        menuIcon.textContent = 'menu';
                    }
                });
            }
        }, 100));
        
        // Atualizar ícones das abas baseado no estado active
        function atualizarIconesTab() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(button => {
                const isActive = button.classList.contains('active');
                const svg = button.querySelector('svg');
                if (!svg) return;
                
                // Definir ícones inativos e ativos para cada aba
                const iconConfigs = {
                    'Vendas': {
                        inactive: '<path fill="currentColor" d="M4 7a1 1 0 0 0 0 2h2.22l2.624 10.5c.223.89 1.02 1.5 1.937 1.5h12.47c.903 0 1.67-.6 1.907-1.47L27.75 10h-2.094l-2.406 9H10.78L8.157 8.5A1.984 1.984 0 0 0 6.22 7zm18 14c-1.645 0-3 1.355-3 3s1.355 3 3 3s3-1.355 3-3s-1.355-3-3-3m-9 0c-1.645 0-3 1.355-3 3s1.355 3 3 3s3-1.355 3-3s-1.355-3-3-3m3-14v5h-3l4 4l4-4h-3V7zm-3 16c.564 0 1 .436 1 1s-.436 1-1 1s-1-.436-1-1s.436-1 1-1m9 0c.564 0 1 .436 1 1s-.436 1-1 1s-1-.436-1-1s.436-1 1-1"/>',
                        active: '<path fill="currentColor" d="M4 7a1 1 0 0 0 0 2h2.22l2.624 10.5c.223.89 1.02 1.5 1.937 1.5h12.47c.903 0 1.67-.6 1.907-1.47L27.75 10h-2.094l-2.406 9H10.78L8.157 8.5A1.984 1.984 0 0 0 6.22 7zm18 14c-1.645 0-3 1.355-3 3s1.355 3 3 3s3-1.355 3-3s-1.355-3-3-3m-9 0c-1.645 0-3 1.355-3 3s1.355 3 3 3s3-1.355 3-3s-1.355-3-3-3m3-14v5h-3l4 4l4-4h-3V7zm-3 16c.564 0 1 .436 1 1s-.436 1-1 1s-1-.436-1-1s.436-1 1-1m9 0c.564 0 1 .436 1 1s-.436 1-1 1s-1-.436-1-1s.436-1 1-1" stroke-width="0.3" stroke="currentColor"/>',
                        viewBox: '0 0 32 32'
                    },
                    'Produtos': {
                        inactive: '<path fill="currentColor" fill-rule="evenodd" d="M464 144c8.837 0 16 7.163 16 16v304c0 8.836-7.163 16-16 16H160c-8.837 0-16-7.164-16-16V160c0-8.837 7.163-16 16-16zm-52 68H212v200h200zm493.333 87.686c6.248 6.248 6.248 16.379 0 22.627l-181.02 181.02c-6.248 6.248-16.378 6.248-22.627 0l-181.019-181.02c-6.248-6.248-6.248-16.379 0-22.627l181.02-181.02c6.248-6.248 16.378-6.248 22.627 0zm-84.853 11.313L713 203.52L605.52 311L713 418.48zM464 544c8.837 0 16 7.164 16 16v304c0 8.837-7.163 16-16 16H160c-8.837 0-16-7.163-16-16V560c0-8.836 7.163-16 16-16zm-52 68H212v200h200zm452-68c8.837 0 16 7.164 16 16v304c0 8.837-7.163 16-16 16H560c-8.837 0-16-7.163-16-16V560c0-8.836 7.163-16 16-16zm-52 68H612v200h200z"/>',
                        active: '<path fill="currentColor" fill-rule="evenodd" d="M160 144h304c8.837 0 16 7.163 16 16v304c0 8.837-7.163 16-16 16H160c-8.837 0-16-7.163-16-16V160c0-8.837 7.163-16 16-16m564.314-25.333l181.019 181.02c6.248 6.248 6.248 16.378 0 22.627l-181.02 181.019c-6.248 6.248-16.378 6.248-22.627 0l-181.019-181.02c-6.248-6.248-6.248-16.378 0-22.627l181.02-181.019c6.248-6.248 16.378-6.248 22.627 0M160 544h304c8.837 0 16 7.163 16 16v304c0 8.837-7.163 16-16 16H160c-8.837 0-16-7.163-16-16V560c0-8.837 7.163-16 16-16m400 0h304c8.837 0 16 7.163 16 16v304c0 8.837-7.163 16-16 16H560c-8.837 0-16-7.163-16-16V560c0-8.837 7.163-16 16-16" stroke-width="25.5" stroke="currentColor"/>',
                        viewBox: '0 0 1024 1024',
                        viewBoxActive: '0 0 1024 1024'
                    },
                    'Histórico': {
                        inactive: '<path fill="currentColor" d="M30 6V4h-3V2h-2v2h-1c-1.103 0-2 .898-2 2v2c0 1.103.897 2 2 2h4v2h-6v2h3v2h2v-2h1c1.103 0 2-.897 2-2v-2c0-1.102-.897-2-2-2h-4V6zm-6 14v2h2.586L23 25.586l-2.292-2.293a1 1 0 0 0-.706-.293H20a1 1 0 0 0-.706.293L14 28.586L15.414 30l4.587-4.586l2.292 2.293a1 1 0 0 0 1.414 0L28 23.414V26h2v-6zM4 30H2v-5c0-3.86 3.14-7 7-7h6c1.989 0 3.89.85 5.217 2.333l-1.49 1.334A5 5 0 0 0 15 20H9c-2.757 0-5 2.243-5 5zm8-14a7 7 0 1 0 0-14a7 7 0 0 0 0 14m0-12a5 5 0 1 1 0 10a5 5 0 0 1 0-10"/>',
                        active: '<path fill="currentColor" d="M30 6V4h-3V2h-2v2h-1c-1.103 0-2 .898-2 2v2c0 1.103.897 2 2 2h4v2h-6v2h3v2h2v-2h1c1.103 0 2-.897 2-2v-2c0-1.102-.897-2-2-2h-4V6zm-6 14v2h2.586L23 25.586l-2.292-2.293a1 1 0 0 0-.706-.293H20a1 1 0 0 0-.706.293L14 28.586L15.414 30l4.587-4.586l2.292 2.293a1 1 0 0 0 1.414 0L28 23.414V26h2v-6zM4 30H2v-5c0-3.86 3.14-7 7-7h6c1.989 0 3.89.85 5.217 2.333l-1.49 1.334A5 5 0 0 0 15 20H9c-2.757 0-5 2.243-5 5zm8-14a7 7 0 1 0 0-14a7 7 0 0 0 0 14m0-12a5 5 0 1 1 0 10a5 5 0 0 1 0-10" stroke-width="1.1" stroke="currentColor"/>',
                        viewBox: '0 0 32 32'
                    },
                    'Clientes': {
                        inactive: '<path fill="currentColor" fill-rule="evenodd" d="M7.75 7.5a4.25 4.25 0 1 1 8.5 0a4.25 4.25 0 0 1-8.5 0M12 4.75a2.75 2.75 0 1 0 0 5.5a2.75 2.75 0 0 0 0-5.5m-4 10A2.25 2.25 0 0 0 5.75 17v1.188c0 .018.013.034.031.037c4.119.672 8.32.672 12.438 0a.04.04 0 0 0 .031-.037V17A2.25 2.25 0 0 0 16 14.75h-.34a.3.3 0 0 0-.079.012l-.865.283a8.75 8.75 0 0 1-5.432 0l-.866-.283a.3.3 0 0 0-.077-.012zM4.25 17A3.75 3.75 0 0 1 8 13.25h.34q.28.001.544.086l.866.283a7.25 7.25 0 0 0 4.5 0l.866-.283c.175-.057.359-.086.543-.086H16A3.75 3.75 0 0 1 19.75 17v1.188c0 .754-.546 1.396-1.29 1.517a40.1 40.1 0 0 1-12.92 0a1.54 1.54 0 0 1-1.29-1.517z" clip-rule="evenodd"/>',
                        active: '<path fill="currentColor" d="M12 3.75a3.75 3.75 0 1 0 0 7.5a3.75 3.75 0 0 0 0-7.5m-4 9.5A3.75 3.75 0 0 0 4.25 17v1.188c0 .754.546 1.396 1.29 1.517c4.278.699 8.642.699 12.92 0a1.54 1.54 0 0 0 1.29-1.517V17A3.75 3.75 0 0 0 16 13.25h-.34q-.28.001-.544.086l-.866.283a7.25 7.25 0 0 1-4.5 0l-.866-.283a1.8 1.8 0 0 0-.543-.086z"/>',
                        viewBox: '0 0 24 24'
                    }
                };
                
                // Identificar qual aba é pelo texto do botão
                const buttonText = button.textContent.trim().replace(/\s+/g, ' ');
                let tabName = null;
                for (const name in iconConfigs) {
                    if (buttonText.includes(name)) {
                        tabName = name;
                        break;
                    }
                }
                
                if (tabName && iconConfigs[tabName]) {
                    const config = iconConfigs[tabName];
                    const pathContent = isActive ? config.active : config.inactive;
                    svg.setAttribute('viewBox', config.viewBox);
                    svg.innerHTML = pathContent;
                }
            });
        }
        
        // Mudar tab
        function mudaTab(tab, eventElement = null) {
            // Remover active de todas as tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Adicionar active na tab clicada
            if (eventElement) {
                eventElement.classList.add('active');
            } else {
                // Se não tiver elemento, encontrar pelo texto
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(t => {
                    if (t.textContent.includes(tab.charAt(0).toUpperCase() + tab.slice(1))) {
                        t.classList.add('active');
                    }
                });
            }
            
            // Atualizar ícones
            atualizarIconesTab();
            
            // Mostrar conteúdo da tab
            const tabContent = document.getElementById('tab-' + tab);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            if (tab === 'produtos') carregarProdutos();
            if (tab === 'historico') {
                // Recarregar vendas e clientes antes de mostrar histórico para garantir dados atualizados
                (async () => {
                    vendas = await ipcRenderer.invoke('vendas-listar');
                    // Carregar clientes também para exibir nomes no histórico
                    if (!clientes || clientes.length === 0) {
                        clientes = await ipcRenderer.invoke('clientes-listar');
                    }
                    carregarHistorico();
                })();
            }
            if (tab === 'clientes') {
                carregarClientes();
            }
            if (tab === 'vendas') { 
                carregarProdutosGrid(); 
                atualizarCarrinho();
                // Inicializar leitor USB quando abrir aba de vendas (sem delay)
                if (!leitorInicializado) {
                    inicializarLeitorUSB();
                }
                // Inicializar atalhos de teclado
                inicializarAtalhosTeclado();
            }
            if (tab === 'conta') carregarConta();
            if (tab === 'gerenciamento') {
                carregarGerenciamento();
                atualizarEstatisticas();
            }
        }

        // ========= UI Custom: Toasts e Confirmação =========
        function showToast(message, type = 'info', timeout = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            const icon = type === 'success' ? 'check_circle' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            toast.innerHTML = `<span class="material-symbols-rounded">${icon}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(6px)';
                setTimeout(() => container.removeChild(toast), 180);
            }, timeout);
        }

        function showConfirm(message) {
            return new Promise(resolve => {
                const modal = document.getElementById('modalConfirm');
                const titleEl = document.getElementById('confirmTitle');
                const msg = document.getElementById('confirmMessage');
                const ok = document.getElementById('confirmOk');
                const cancel = document.getElementById('confirmCancel');
                msg.textContent = message;
                
                // Usar requestAnimationFrame para abrir modal suavemente
                requestAnimationFrame(() => {
                    abrirModalOtimizado('modalConfirm');
                });

                function cleanup(result) {
                    requestAnimationFrame(() => {
                        fecharModalOtimizado('modalConfirm');
                        titleEl.textContent = 'Confirmação';
                        cancel.style.display = '';
                        ok.textContent = 'Confirmar';
                        ok.removeEventListener('click', onOk);
                        cancel.removeEventListener('click', onCancel);
                    });
                    resolve(result);
                }
                function onOk(){ cleanup(true); }
                function onCancel(){ cleanup(false); }
                ok.addEventListener('click', onOk, { passive: true });
                cancel.addEventListener('click', onCancel, { passive: true });
            });
        }

        // Mostrar informação em modal (sem botão Cancelar) - Otimizado
        function showInfo(titulo, mensagem) {
            const modal = document.getElementById('modalConfirm');
            const titleEl = document.getElementById('confirmTitle');
            const msg = document.getElementById('confirmMessage');
            const ok = document.getElementById('confirmOk');
            const cancel = document.getElementById('confirmCancel');
            titleEl.textContent = titulo || 'Informação';
            msg.textContent = mensagem;
            cancel.style.display = 'none';
            ok.textContent = 'Fechar';
            
            // Usar requestAnimationFrame para abrir modal suavemente
            requestAnimationFrame(() => {
                abrirModalOtimizado('modalConfirm');
            });
            
            function onClose(){
                requestAnimationFrame(() => {
                    fecharModalOtimizado('modalConfirm');
                    titleEl.textContent = 'Confirmação';
                    cancel.style.display = '';
                    ok.textContent = 'Confirmar';
                });
                ok.removeEventListener('click', onClose);
            }
            ok.addEventListener('click', onClose, { passive: true });
        }

        // Variável para armazenar termo de busca atual
        let termoBuscaAtual = '';
        
        // Carregar produtos grid - Otimizado com lazy loading para grandes volumes
        let paginaAtualGrid = 1;
        let gridCarregamentoLazy = false;
        
        function carregarProdutosGrid() {
            const grid = document.getElementById('produtosGrid');
            
            if (!grid) {
                console.error('Elemento produtosGrid não encontrado');
                return;
            }
            
            // Se houver termo de busca, mostrar produtos encontrados (limitados)
            if (termoBuscaAtual && termoBuscaAtual.trim()) {
                const termoLower = termoBuscaAtual.toLowerCase();
                const produtosEncontrados = produtos.filter(p => {
                    const codigo = String(p.codigo || '').trim().toLowerCase();
                    const nome = String(p.nome || '').trim().toLowerCase();
                    return codigo.includes(termoLower) || nome.includes(termoLower);
                });
                
                if (produtosEncontrados.length === 0) {
                    grid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #64748b;">
                            <span class="material-symbols-rounded" style="font-size: 48px; display: block; margin-bottom: 16px; opacity: 0.5;">search_off</span>
                            <h3 style="font-size: 16px; font-weight: 600; color: #475569;">Nenhum produto encontrado</h3>
                            <p style="font-size: 14px; margin-top: 8px;">Tente buscar por outro termo</p>
                        </div>
                    `;
                    return;
                }
                
                // Limitar a 100 produtos na busca (melhor performance)
                const produtosLimitados = produtosEncontrados.slice(0, 100);
                const fragment = document.createDocumentFragment();
                const container = document.createElement('div');
                
                container.innerHTML = produtosLimitados.map(p => `
                    <div class="produto-card" onclick="adicionarAoCarrinhoPorId(${p.id})" style="cursor:pointer;">
                        <h4>${p.nome}</h4>
                        <div class="preco">${formatarMoeda(p.preco)}</div>
                    </div>
                `).join('');
                
                // Adicionar aviso se houver mais resultados
                if (produtosEncontrados.length > 100) {
                    container.innerHTML += `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #64748b; background: #f8fafc; border-radius: 8px; margin-top: 16px;">
                            <p style="font-size: 14px;">Mostrando 100 de ${produtosEncontrados.length} resultados. Refine sua busca para ver mais.</p>
                        </div>
                    `;
                }
                
                grid.innerHTML = container.innerHTML;
                return;
            }
            
            // Se não houver busca, mostrar produtos do carrinho
            if (carrinho && carrinho.length > 0) {
                const fragment = document.createDocumentFragment();
                const container = document.createElement('div');
                container.innerHTML = carrinho.map(item => {
                    const produto = produtos.find(p => p.id === item.id) || item;
                    return `
                        <div class="produto-card" onclick="adicionarAoCarrinhoPorId(${produto.id})" style="cursor:pointer;border:2px solid #059669;">
                            <h4>${produto.nome}</h4>
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                                <div class="preco">${formatarMoeda(produto.preco)}</div>
                                <div style="background:#059669;color:white;padding:4px 12px;border-radius:6px;font-size:14px;font-weight:600;">
                                    ${item.quantidade}x
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                grid.innerHTML = container.innerHTML;
                return;
            }
            
            // Se não houver produtos cadastrados
            if (!produtos || produtos.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #64748b;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" style="display: block; margin: 0 auto 16px; opacity: 0.5;">
                            <path fill="currentColor" d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67l-.5-.68C10.96 2.54 10 2 9 2C7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2m-5-2c.55 0 1 .45 1 1s-.45 1-1 1s-1-.45-1-1s.45-1 1-1M9 4c.55 0 1 .45 1 1s-.45 1-1 1s-1-.45-1-1s.45-1 1-1m11 15H4v-2h16zm0-5H4V8h5.08L7 10.83L8.62 12L11 8.76l1-1.36l4 5.6H20z"/>
                        </svg>
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #475569;">Nenhum produto cadastrado</h3>
                        <p style="font-size: 14px; margin-bottom: 24px;">Cadastre produtos na aba "Produtos" para começar a vender</p>
                        <button class="btn btn-primary" onclick="mudaTab('produtos')" style="display: inline-flex; align-items: center; gap: 8px;">
                            <span class="material-symbols-rounded">add_circle</span>
                            Cadastrar Produto
                        </button>
                    </div>
                `;
                return;
            }
            
            // Para grandes volumes, mostrar apenas os primeiros 50 produtos (lazy loading)
            // Se houver mais de 50, mostrar mensagem e botão "Ver mais"
            if (produtos.length > ITENS_POR_PAGINA_GRID) {
                const produtosPagina = produtos.slice(0, ITENS_POR_PAGINA_GRID);
                const fragment = document.createDocumentFragment();
                const container = document.createElement('div');
                
                container.innerHTML = produtosPagina.map(p => `
                    <div class="produto-card" onclick="adicionarAoCarrinhoPorId(${p.id})" style="cursor:pointer;">
                        <h4>${p.nome}</h4>
                        <div class="preco">${formatarMoeda(p.preco)}</div>
                    </div>
                `).join('');
                
                // Adicionar botão para ver mais ou usar busca
                container.innerHTML += `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px; margin-top: 16px;">
                        <p style="font-size: 14px; color: #64748b; margin-bottom: 12px;">Mostrando ${ITENS_POR_PAGINA_GRID} de ${produtos.length} produtos</p>
                        <p style="font-size: 13px; color: #94a3b8;">Use o campo de busca acima para encontrar produtos específicos</p>
                    </div>
                `;
                
                grid.innerHTML = container.innerHTML;
            } else {
                // Se tiver poucos produtos, mostrar todos normalmente
                const fragment = document.createDocumentFragment();
                const container = document.createElement('div');
                container.innerHTML = produtos.map(p => `
                    <div class="produto-card" onclick="adicionarAoCarrinhoPorId(${p.id})" style="cursor:pointer;">
                        <h4>${p.nome}</h4>
                        <div class="preco">${formatarMoeda(p.preco)}</div>
                    </div>
                `).join('');
                grid.innerHTML = container.innerHTML;
            }
        }
        
        // Adicionar ao carrinho por ID (sem delay)
        function adicionarAoCarrinhoPorId(id) {
            const produto = produtos.find(p => p.id === id);
            if (produto) {
                adicionarAoCarrinho(produto);
            }
        }

        // Detectar leitor de código de barras USB (global - funciona mesmo sem campo focado)
        function detectarLeitorUSBGlobal(e) {
            // Só funciona na aba de vendas
            const tabVendas = document.getElementById('tab-vendas');
            if (!tabVendas || tabVendas.classList.contains('hidden')) {
                return;
            }
            
            // Ignorar se estiver digitando em campos de formulário (exceto campo de busca)
            const tagName = e.target.tagName.toLowerCase();
            const isInput = tagName === 'input' || tagName === 'textarea';
            const inputId = e.target.id;
            
            // Se estiver no campo de busca, usar lógica antiga
            if (inputId === 'buscaCodigo') {
                detectarLeitorUSB(e);
                return;
            }
            
            // Ignorar teclas especiais e atalhos (mas permitir se já estiver capturando)
            if (!capturandoLeitura) {
                if (e.ctrlKey || e.altKey || e.metaKey || e.key.startsWith('F') || 
                    ['Tab', 'Escape', 'Delete', 'Backspace'].includes(e.key)) {
                    return;
                }
            }
            
            const agora = Date.now();
            const tempoEntreTeclas = agora - tempoUltimaTecla;
            
            // Se for Enter e tiver buffer, processar
            if (e.key === 'Enter' || e.keyCode === 13) {
                if (bufferGlobalLeitura.trim().length > 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    processarCodigoBarras(bufferGlobalLeitura.trim());
                    bufferGlobalLeitura = '';
                    capturandoLeitura = false;
                    return false;
                }
                return;
            }
            
            // Se for caractere alfanumérico, pode ser leitor
            if (e.key.length === 1 && /[a-zA-Z0-9]/.test(e.key)) {
                // Se começou agora ou se está digitando muito rápido (leitor)
                if (!capturandoLeitura || tempoEntreTeclas < 100) {
                    capturandoLeitura = true;
                    bufferGlobalLeitura += e.key;
                    leitorConectado = true;
                    atualizarStatusLeitor(true);
                    tempoUltimaTecla = agora;
                    
                    // Limpar timeout anterior
                    if (timeoutLeitura) {
                        clearTimeout(timeoutLeitura);
                    }
                    
                    // Se parar de digitar por mais de 150ms, processar (leitor terminou)
                    timeoutLeitura = setTimeout(() => {
                        if (bufferGlobalLeitura.trim().length > 3) {
                            processarCodigoBarras(bufferGlobalLeitura.trim());
                            bufferGlobalLeitura = '';
                            capturandoLeitura = false;
                        }
                    }, 150);
                    
                    // Prevenir que a tecla apareça em outros lugares e não interfira com atalhos
                    if (!isInput) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                } else {
                    // Se passou muito tempo, resetar buffer (não é leitor)
                    bufferGlobalLeitura = '';
                    capturandoLeitura = false;
                }
            } else if (capturandoLeitura && bufferGlobalLeitura.length > 0) {
                // Se não for caractere válido mas estava capturando, pode ser fim da leitura
                if (bufferGlobalLeitura.trim().length > 3) {
                    processarCodigoBarras(bufferGlobalLeitura.trim());
                    bufferGlobalLeitura = '';
                    capturandoLeitura = false;
                }
            }
        }
        
        // Detectar leitor quando campo está focado
        function detectarLeitorUSB(e) {
            const input = document.getElementById('buscaCodigo');
            if (!input) return;
            
            const agora = Date.now();
            const tempoEntreTeclas = agora - tempoUltimaTecla;
            
            // Se for Enter, processar código
            if (e.key === 'Enter' || e.keyCode === 13) {
                const codigo = input.value.trim();
                if (codigo) {
                    // Se o código foi digitado muito rápido (menos de 500ms), é leitor
                    if (tempoEntreTeclas < 500 && input.value.length > 3) {
                        leitorConectado = true;
                        atualizarStatusLeitor(true);
                    }
                    processarCodigoBarras(codigo);
                    input.value = '';
                }
                e.preventDefault();
                return false;
            }
            
            // Detectar se é leitor baseado na velocidade de digitação
            // Leitores USB digitam muito rápido (menos de 50ms entre teclas)
            if (tempoEntreTeclas > 0 && tempoEntreTeclas < 50 && input.value.length > 0) {
                leitorConectado = true;
                atualizarStatusLeitor(true);
            }
            
            // Se começou a digitar no campo vazio, pode ser leitor
            if (input.value.length === 1 && e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                bufferLeitura = e.key;
                tempoUltimaTecla = agora;
            } else {
                tempoUltimaTecla = agora;
            }
            
            // Limpar timeout anterior
            if (timeoutLeitura) {
                clearTimeout(timeoutLeitura);
            }
            
            // Se parar de digitar por mais de 200ms e tiver conteúdo, pode ser leitor completo
            timeoutLeitura = setTimeout(() => {
                if (input.value.length > 5 && leitorConectado) {
                    // Auto-processar se for leitor (alguns leitores não enviam Enter)
                    const codigo = input.value.trim();
                    if (codigo) {
                        processarCodigoBarras(codigo);
                        input.value = '';
                    }
                }
            }, 200);
        }
        
        // Processar código de barras lido ou busca por código/nome
        function processarCodigoBarras(termo) {
            if (!termo || termo.trim() === '') return;
            
            const termoLimpo = termo.trim();
            const termoLower = termoLimpo.toLowerCase();
            
            // Buscar produto por código (exata ou parcial) ou por nome (parcial)
            const produto = produtos.find(p => {
                const codigoProduto = String(p.codigo || '').trim().toLowerCase();
                const nomeProduto = String(p.nome || '').trim().toLowerCase();
                
                // Busca por código (exata ou que comece com o termo)
                if (codigoProduto === termoLower || codigoProduto.startsWith(termoLower)) {
                    return true;
                }
                
                // Busca por nome (parcial)
                if (nomeProduto.includes(termoLower)) {
                    return true;
                }
                
                return false;
            });
            
            if (produto) {
                adicionarAoCarrinho(produto);
                showToast(`✅ ${produto.nome} adicionado ao carrinho!`, 'success', 2000);
                
                // Limpar busca e atualizar grid
                const input = document.getElementById('buscaCodigo');
                if (input) {
                    input.value = '';
                    input.style.background = '#dcfce7';
                    setTimeout(() => {
                        input.style.background = '';
                    }, 500);
                }
                termoBuscaAtual = '';
                carregarProdutosGrid(); // Mostrar produtos do carrinho
            } else {
                showToast('❌ Produto não cadastrado', 'error', 3000);
                
                // Feedback visual de erro
                const input = document.getElementById('buscaCodigo');
                if (input) {
                    input.style.background = '#fee2e2';
                    setTimeout(() => {
                        input.style.background = '';
                    }, 500);
                }
            }
            
            // Limpar buffers após processar
            bufferGlobalLeitura = '';
            capturandoLeitura = false;
        }
        
        // Variável para debounce da busca
        let timeoutBusca = null;
        
        // Buscar produto na aba de vendas (mostra resultados e adiciona ao carrinho)
        function buscarProdutoVendas(e) {
            const input = document.getElementById('buscaCodigo');
            if (!input) return;
            
            const termo = input.value.trim();
            termoBuscaAtual = termo;
            
            // Se for Enter, adicionar produto ao carrinho
            if (e.key === 'Enter') {
                if (termo) {
                    processarCodigoBarras(termo);
                    input.value = '';
                    termoBuscaAtual = '';
                    carregarProdutosGrid(); // Atualizar grid para mostrar carrinho
                }
                return;
            }
            
            // Limpar timeout anterior
            if (timeoutBusca) {
                clearTimeout(timeoutBusca);
            }
            
            // Se campo vazio, mostrar produtos do carrinho
            if (!termo) {
                termoBuscaAtual = '';
                input.style.background = '';
                input.style.borderColor = '';
                carregarProdutosGrid();
                return;
            }
            
            // Buscar após 300ms de inatividade (debounce)
            timeoutBusca = setTimeout(() => {
                buscarProdutoEmTempoReal(termo);
                carregarProdutosGrid(); // Atualizar grid com resultados
            }, 300);
        }
        
        // Buscar produto por código ou nome (digitação manual) - função antiga mantida para compatibilidade
        function buscarProduto(e) {
            buscarProdutoVendas(e);
        }
        
        // Buscar produto em tempo real enquanto digita
        function buscarProdutoEmTempoReal(termo) {
            const input = document.getElementById('buscaCodigo');
            if (!input || !termo) return;
            
            const termoLower = termo.toLowerCase();
            
            // Buscar por código (exata ou parcial) ou por nome (parcial)
            const produtoEncontrado = produtos.find(p => {
                const codigo = String(p.codigo || '').trim().toLowerCase();
                const nome = String(p.nome || '').trim().toLowerCase();
                
                // Busca por código (exata ou que comece com o termo)
                if (codigo === termoLower || codigo.startsWith(termoLower)) {
                    return true;
                }
                
                // Busca por nome (parcial)
                if (nome.includes(termoLower)) {
                    return true;
                }
                
                return false;
            });
            
            // Feedback visual
            if (produtoEncontrado) {
                // Produto encontrado - fundo verde claro
                input.style.background = '#dcfce7';
                input.style.borderColor = '#16a34a';
                
                // Mostrar toast com produto encontrado
                showToast(`✅ Produto encontrado: ${produtoEncontrado.nome}`, 'success', 2000);
            } else {
                // Produto não encontrado - fundo vermelho claro
                input.style.background = '#fee2e2';
                input.style.borderColor = '#dc2626';
                
                // Mostrar toast de não encontrado
                showToast('❌ Produto não cadastrado', 'error', 2000);
            }
        }
        
        // Atualizar status visual do leitor
        function atualizarStatusLeitor(conectado) {
            const statusEl = document.getElementById('leitorStatus');
            const iconEl = document.getElementById('leitorIcon');
            const textoEl = document.getElementById('leitorTexto');
            
            const svgIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="currentColor" d="M4 3a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4.176A2 2 0 0 1 8 10.179V9a2 2 0 0 1 1-1.732V6a2 2 0 0 1 2-2h2c.293 0 .572.063.823.177A2 2 0 0 0 12 3zm.5 9h4.344l.656.915V13h-5a.5.5 0 0 1 0-1M10 6v2a1 1 0 0 0-1 1v1.179a1 1 0 0 0 .187.582l1.313 1.833V14a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-1.406l1.309-1.8a1 1 0 0 0 .191-.588V9a1 1 0 0 0-1-1V6a1 1 0 0 0-1-1h-2a1 1 0 0 0-1 1m3 0v2h-2V6z"/></svg>';
            
            if (conectado) {
                leitorConectado = true;
                statusEl.style.background = '#dcfce7';
                statusEl.style.border = '1px solid #86efac';
                iconEl.innerHTML = svgIcon;
                iconEl.style.color = '#16a34a';
                textoEl.textContent = 'Leitor conectado - Pronto para escanear';
            } else {
                leitorConectado = false;
                statusEl.style.background = '#fef3c7';
                statusEl.style.border = '1px solid #fde047';
                iconEl.innerHTML = svgIcon;
                iconEl.style.color = '#d97706';
                textoEl.textContent = 'Aguardando conexão do leitor...';
            }
        }
        
        // Inicializar detecção do leitor (global - funciona mesmo sem campo focado)
        function inicializarLeitorUSB() {
            // Evitar inicialização múltipla
            if (leitorInicializado) return;
            
            const input = document.getElementById('buscaCodigo');
            if (!input) {
                // Tentar apenas 3 vezes, depois desistir
                let tentativas = (window._tentativasLeitor || 0);
                if (tentativas < 3) {
                    window._tentativasLeitor = tentativas + 1;
                    setTimeout(inicializarLeitorUSB, 500);
                }
                return;
            }
            window._tentativasLeitor = 0;
            
            // Adicionar listener global apenas uma vez
            document.addEventListener('keydown', detectarLeitorUSBGlobal, true);
            
            // Limpar intervalo anterior se existir
            if (intervaloLeitor) {
                clearInterval(intervaloLeitor);
            }
            
            // Verificar periodicamente se o leitor está ativo (a cada 5 segundos para melhor performance)
            intervaloLeitor = setInterval(() => {
                const agora = Date.now();
                // Se passou mais de 10 segundos sem atividade, considerar desconectado
                if (leitorConectado && tempoUltimaTecla > 0 && (agora - tempoUltimaTecla) > 10000) {
                    atualizarStatusLeitor(false);
                }
                
                // Limpar buffer se ficou muito tempo sem atividade
                if (capturandoLeitura && (agora - tempoUltimaTecla) > 1000) {
                    bufferGlobalLeitura = '';
                    capturandoLeitura = false;
                }
            }, 5000);
            
            leitorInicializado = true;
            atualizarStatusLeitor(false); // Iniciar como desconectado
        }
        
        // ============ GERENCIAMENTO DE ATALHOS DE TECLADO ============
        let atalhosInicializados = false;
        
        function inicializarAtalhosTeclado() {
            if (atalhosInicializados) return;
            
            document.addEventListener('keydown', function(e) {
                // Só funcionar na aba de vendas
                const tabVendas = document.getElementById('tab-vendas');
                if (!tabVendas || tabVendas.classList.contains('hidden')) {
                    return;
                }
                
                // Ignorar se estiver digitando em campos de formulário (exceto campo de busca quando for atalho específico)
                const tagName = e.target.tagName.toLowerCase();
                const isInput = tagName === 'input' || tagName === 'textarea';
                const inputId = e.target.id;
                
                // Se estiver em modal, não processar atalhos (exceto Escape)
                const modalPagamento = document.getElementById('modalPagamento');
                if (modalPagamento && modalPagamento.classList.contains('active')) {
                    return; // Deixar o modal gerenciar seus próprios eventos
                }
                
                // Não processar se estiver capturando leitura USB (exceto teclas de função)
                if (capturandoLeitura && !e.key.startsWith('F') && e.key !== ' ' && !e.shiftKey) {
                    return;
                }
                
                // Mapeamento de atalhos
                const key = e.key;
                const keyCode = e.keyCode || e.which;
                
                // Atalhos numéricos (só funcionam se não estiver digitando em input)
                if (!isInput || inputId === 'buscaCodigo') {
                    if (key === '1' || keyCode === 49) {
                        e.preventDefault();
                        e.stopPropagation();
                        finalizarVenda();
                        return false;
                    }
                    if (key === '2' || keyCode === 50) {
                        e.preventDefault();
                        e.stopPropagation();
                        finalizarVendaPrazo();
                        return false;
                    }
                    if (key === '3' || keyCode === 51) {
                        e.preventDefault();
                        e.stopPropagation();
                        cancelarUltimoItem();
                        return false;
                    }
                    if (key === '4' || keyCode === 52) {
                        e.preventDefault();
                        e.stopPropagation();
                        abrirCancelarVendas();
                        return false;
                    }
                    if (key === '5' || keyCode === 53) {
                        e.preventDefault();
                        e.stopPropagation();
                        consultarMercadoria();
                        return false;
                    }
                    if (key === '6' || keyCode === 54) {
                        e.preventDefault();
                        e.stopPropagation();
                        pausarCaixa();
                        return false;
                    }
                    if (key === '7' || keyCode === 55) {
                        e.preventDefault();
                        e.stopPropagation();
                        abrirOrcamentoPreco();
                        return false;
                    }
                    if (key === '8' || keyCode === 56) {
                        e.preventDefault();
                        e.stopPropagation();
                        consultarMovimentoCaixa();
                        return false;
                    }
                    if (key === '9' || keyCode === 57) {
                        e.preventDefault();
                        e.stopPropagation();
                        pegarPesoBalança();
                        return false;
                    }
                    if (key === '0' || keyCode === 48) {
                        e.preventDefault();
                        e.stopPropagation();
                        fecharTelaVendas();
                        return false;
                    }
                }
                
                // ESC - Abrir/Fechar modal de atalhos (só se não estiver em modal de pagamento)
                if (key === 'Escape' || keyCode === 27) {
                    const modalPagamento = document.getElementById('modalPagamento');
                    if (!modalPagamento || !modalPagamento.classList.contains('active')) {
                        e.preventDefault();
                        e.stopPropagation();
                        const modalAtalhos = document.getElementById('modalAtalhos');
                        if (modalAtalhos && modalAtalhos.classList.contains('active')) {
                            fecharModalAtalhos();
                        } else {
                            abrirModalAtalhos();
                        }
                        return false;
                    }
                }
                
                // Espaço - Encontrar mercadoria pelo nome (focar no campo de busca)
                if (key === ' ' && !isInput) {
                    e.preventDefault();
                    e.stopPropagation();
                    const buscaInput = document.getElementById('buscaCodigo');
                    if (buscaInput) {
                        buscaInput.focus();
                        buscaInput.select();
                    }
                    return false;
                }
                
                // Teclas de função (sempre funcionam)
                if (key === 'F1' || keyCode === 112) {
                    e.preventDefault();
                    e.stopPropagation();
                    abrirEntradaSaidaCaixa();
                    return false;
                }
                if (key === 'F2' || keyCode === 113) {
                    e.preventDefault();
                    e.stopPropagation();
                    reimprimirUltimaVenda();
                    return false;
                }
                if (key === 'F3' || keyCode === 114) {
                    e.preventDefault();
                    e.stopPropagation();
                    reimprimirUltimaVendaComAssinatura();
                    return false;
                }
                if (key === 'F5' || keyCode === 116) {
                    e.preventDefault();
                    e.stopPropagation();
                    abrirGavetaDinheiro();
                    return false;
                }
                if (key === 'F8' || keyCode === 119) {
                    e.preventDefault();
                    e.stopPropagation();
                    abrirCalculadora();
                    return false;
                }
                
                // Shift + A - Anotações
                if (e.shiftKey && (key === 'A' || key === 'a' || keyCode === 65)) {
                    e.preventDefault();
                    e.stopPropagation();
                    abrirAnotacoes();
                    return false;
                }
            }, true); // Usar capture para pegar antes de outros listeners
            
            atalhosInicializados = true;
        }
        
        // Abrir modal de atalhos - Otimizado
        function abrirModalAtalhos() {
            abrirModalOtimizado('modalAtalhos');
        }
        
        // Fechar modal de atalhos - Otimizado
        function fecharModalAtalhos() {
            fecharModalOtimizado('modalAtalhos');
        }
        
        // Funções dos atalhos
        function cancelarUltimoItem() {
            if (carrinho.length === 0) {
                showToast('Carrinho vazio!', 'warning');
                return;
            }
            
            const ultimoItem = carrinho[carrinho.length - 1];
            removerDoCarrinho(ultimoItem.id);
            showToast(`Item "${ultimoItem.nome}" removido do carrinho`, 'success');
        }
        
        function consultarMercadoria() {
            const buscaInput = document.getElementById('buscaCodigo');
            if (buscaInput) {
                buscaInput.focus();
                buscaInput.select();
                showToast('Digite o nome ou código do produto para consultar', 'info', 2000);
            }
        }
        
        function abrirOrcamentoPreco() {
            if (carrinho.length === 0) {
                showToast('Adicione produtos ao carrinho para fazer orçamento!', 'warning');
                return;
            }
            
            const subtotal = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            const desconto = parseFloat(document.getElementById('desconto').value.replace(',', '.') || 0);
            const total = subtotal - desconto;
            
            const itensTexto = carrinho.map(item => 
                `${item.nome} (${item.quantidade}x) - ${formatarMoeda(item.preco * item.quantidade)}`
            ).join('\n');
            
            const info = `ORÇAMENTO DE PREÇO\n\n` +
                        `Itens:\n${itensTexto}\n\n` +
                        `Subtotal: ${formatarMoeda(subtotal)}\n` +
                        `Desconto: ${formatarMoeda(desconto)}\n` +
                        `TOTAL: ${formatarMoeda(total)}`;
            
            showInfo('ORÇAMENTO', info);
        }
        
        function pegarPesoBalança() {
            showInfo('BALANÇA ELETRÔNICA', 'Funcionalidade de integração com balança eletrônica\n\nEm desenvolvimento...\n\nPor enquanto, digite o peso manualmente no campo de quantidade.');
        }
        
        function fecharTelaVendas() {
            // Mudar para aba de produtos
            mudaTab('produtos');
            showToast('Tela de vendas fechada', 'info', 2000);
        }
        
        function abrirGavetaDinheiro() {
            showInfo('GAVETA DO DINHEIRO', 'Funcionalidade de abertura de gaveta\n\nEm desenvolvimento...\n\nA gaveta será aberta automaticamente quando a funcionalidade estiver disponível.');
        }

        // Adicionar ao carrinho
        function adicionarAoCarrinho(produto) {
            const item = carrinho.find(i => i.id === produto.id);
            if (item) {
                item.quantidade++;
            } else {
                carrinho.push({...produto, quantidade: 1});
            }
            atualizarCarrinho();
        }

        // Remover do carrinho
        function removerDoCarrinho(id) {
            carrinho = carrinho.filter(i => i.id !== id);
            atualizarCarrinho();
        }

        // Atualizar carrinho
        function atualizarCarrinho() {
            const container = document.getElementById('carrinhoItens');
            container.innerHTML = carrinho.map(item => {
                // Buscar produto completo para pegar a foto
                const produtoCompleto = produtos.find(p => p.id === item.id) || item;
                const fotoProduto = produtoCompleto.foto || null;
                
                return `
                <div class="carrinho-item">
                    <div style="display:flex;align-items:center;gap:12px;flex:1;min-height:50px;">
                        <div class="foto-carrinho" style="width:50px;height:50px;background:#f1f5f9;border:1px solid #e2e8f0;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                            ${fotoProduto ? `
                                <img src="${fotoProduto}" alt="Foto do produto" style="width:100%;height:100%;object-fit:cover;">
                            ` : `
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="color:#94a3b8;"><path fill="currentColor" d="M4.507 6.008A3.24 3.24 0 0 0 3 8.75v6.5c0 2.9 2.35 5.25 5.25 5.25h6.5a3.25 3.25 0 0 0 2.744-1.508l-.122.006l-.122.002h-9a3.75 3.75 0 0 1-3.75-3.75v-9q0-.122.007-.242M8.75 3A3.25 3.25 0 0 0 5.5 6.25v8.5A3.25 3.25 0 0 0 8.75 18h8.5a3.25 3.25 0 0 0 3.25-3.25v-8.5A3.25 3.25 0 0 0 17.25 3zm4.68 9.137l.093.077l4.307 4.188a1.8 1.8 0 0 1-.58.098h-8.5q-.306-.002-.58-.098l4.307-4.188a.75.75 0 0 1 .954-.077M8.75 4.5h8.5c.966 0 1.75.784 1.75 1.75v8.5q-.002.315-.104.595l-4.327-4.207a2.25 2.25 0 0 0-3.003-.12l-.134.12l-4.328 4.208A1.8 1.8 0 0 1 7 14.75v-8.5c0-.966.784-1.75 1.75-1.75m1.75 2.251a1.25 1.25 0 1 0 0 2.499a1.25 1.25 0 0 0 0-2.499"/></svg>
                            `}
                        </div>
                        <div class="nome" style="display:flex;align-items:center;">${item.nome}</div>
                    </div>
                    <div class="quantidade">
                        <button onclick="alterarQuantidade(${item.id}, -1)" style="background:#e2e8f0;color:#475569;width:32px;height:32px;border-radius:6px;border:none;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;cursor:pointer;">-</button>
                        <span style="min-width:24px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:600;color:#475569;line-height:1;">${item.quantidade}</span>
                        <button onclick="alterarQuantidade(${item.id}, 1)" style="background:#059669;color:white;width:32px;height:32px;border-radius:6px;border:none;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;cursor:pointer;">+</button>
                    </div>
                    <div style="font-weight:600;color:#1e293b;display:flex;align-items:center;min-width:100px;justify-content:flex-end;font-size:20px;">${formatarMoeda(item.preco * item.quantidade)}</div>
                    <button onclick="removerDoCarrinho(${item.id})" style="display:flex;align-items:center;justify-content:center;height:100%;"><span class="material-symbols-rounded">delete</span></button>
                </div>
            `;
            }).join('');

            const subtotal = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            const descontoEl = document.getElementById('desconto');
            const desconto = descontoEl ? parseFloat(descontoEl.value || 0) : 0;
            const total = subtotal - desconto;

            document.getElementById('subtotal').textContent = formatarMoeda(subtotal);
            document.getElementById('total').textContent = formatarMoeda(total);
            
            // Atualizar grid de produtos se não houver busca ativa
            if (!termoBuscaAtual || !termoBuscaAtual.trim()) {
                carregarProdutosGrid();
            }
        }

        // Alterar quantidade
        function alterarQuantidade(id, delta) {
            const item = carrinho.find(i => i.id === id);
            if (item) {
                const novaQtd = item.quantidade + delta;
                if (novaQtd > 0) {
                    item.quantidade = novaQtd;
                    atualizarCarrinho();
                } else {
                    removerDoCarrinho(id);
                }
            }
        }

        // Funções dos atalhos
        function finalizarVendaPrazo() {
            if (carrinho.length === 0) {
                showToast('Carrinho vazio!', 'warning');
                return;
            }
            
            const total = parsearValorMonetario(document.getElementById('total').textContent);
            document.getElementById('totalPagamento').textContent = formatarMoeda(total);
            
            // Resetar campos
            document.getElementById('valorRecebido').value = '';
            document.getElementById('valorRecebido').disabled = false;
            document.getElementById('formaPagamento').disabled = false;
            
            // Definir forma de pagamento como "A Prazo"
            document.getElementById('formaPagamento').value = 'A Prazo';
            
            // Esconder campos de dinheiro
            document.getElementById('divValorRecebido').style.display = 'none';
            document.getElementById('divTroco').style.display = 'none';
            
            // Garantir que os campos estejam habilitados
            document.getElementById('formaPagamento').disabled = false;
            document.getElementById('valorRecebido').disabled = false;
            
            // Abrir modal
            document.getElementById('modalPagamento').classList.add('active');
            
            // Calcular troco para atualizar estado (vai mostrar campo de cliente)
            calcularTroco();
            
            // Carregar clientes no select
            carregarClientesNoSelect();
            
            // Adicionar listener para Enter no modal
            setTimeout(() => {
                const modalPagamento = document.getElementById('modalPagamento');
                if (modalPagamento) {
                    modalPagamento.removeEventListener('keydown', handleEnterModal, true);
                    modalPagamento.addEventListener('keydown', handleEnterModal, true);
                }
            }, 300);
        }
        
        function cancelarUltimoItem() {
            if (carrinho.length === 0) {
                showToast('Carrinho vazio!', 'warning');
                return;
            }
            const ultimoItem = carrinho[carrinho.length - 1];
            removerDoCarrinho(ultimoItem.id);
            showToast(`Item "${ultimoItem.nome}" removido do carrinho`, 'info', 2000);
        }
        
        function mostrarOrcamento() {
            if (carrinho.length === 0) {
                showToast('Carrinho vazio!', 'warning');
                return;
            }
            const subtotal = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            const desconto = parseFloat(document.getElementById('desconto').value || 0);
            const total = subtotal - desconto;
            
            const itens = carrinho.map(i => `${i.nome} (${i.quantidade}x) - ${formatarMoeda(i.preco * i.quantidade)}`).join('\n');
            showInfo('ORÇAMENTO', `Itens:\n${itens}\n\nSubtotal: ${formatarMoeda(subtotal)}\nDesconto: ${formatarMoeda(desconto)}\nTOTAL: ${formatarMoeda(total)}`);
        }
        
        function obterPesoBalança() {
            showToast('Funcionalidade de balança eletrônica - Em desenvolvimento', 'info', 3000);
            // Aqui pode ser integrado com API de balança USB se disponível
        }
        
        function buscarProdutoPorNome(nome) {
            const produtosEncontrados = produtos.filter(p => 
                p.nome.toLowerCase().includes(nome.toLowerCase())
            );
            
            if (produtosEncontrados.length === 0) {
                showToast('Nenhum produto encontrado!', 'warning');
                return;
            }
            
            if (produtosEncontrados.length === 1) {
                adicionarAoCarrinho(produtosEncontrados[0]);
                document.getElementById('buscaCodigo').value = '';
                showToast(`${produtosEncontrados[0].nome} adicionado!`, 'success');
            } else {
                // Mostrar lista de produtos encontrados
                const lista = produtosEncontrados.slice(0, 10).map((p, i) => 
                    `${i + 1}. ${p.nome} - ${formatarMoeda(p.preco)}`
                ).join('\n');
                showInfo(`Produtos encontrados (${produtosEncontrados.length}):`, lista + (produtosEncontrados.length > 10 ? '\n...' : ''));
            }
        }
        
        function abrirEntradaSaidaCaixa() {
            showInfo('ENTRADA/SAÍDA DE CAIXA', 'Funcionalidade de controle de caixa\n\nEm desenvolvimento...');
        }
        
        function abrirCancelarVendas() {
            if (vendas.length === 0) {
                showToast('Nenhuma venda encontrada!', 'warning');
                return;
            }
            carregarHistorico();
            mudaTab('historico');
            showToast('Histórico de vendas aberto. Selecione uma venda para cancelar ou reimprimir.', 'info', 4000);
        }
        
        function pausarCaixa() {
            const tabVendas = document.getElementById('tab-vendas');
            if (tabVendas && !tabVendas.classList.contains('hidden')) {
                showInfo('CAIXA PAUSADO', 'O caixa está temporariamente pausado.\n\nPressione qualquer tecla para continuar...');
            }
        }
        
        function consultarMovimentoCaixa() {
            if (vendas.length === 0) {
                showToast('Nenhuma venda registrada hoje!', 'info');
                return;
            }
            
            const hoje = new Date().toDateString();
            const vendasHoje = vendas.filter(v => new Date(v.data).toDateString() === hoje);
            const totalHoje = vendasHoje.reduce((sum, v) => sum + v.total, 0);
            const quantidadeHoje = vendasHoje.length;
            
            const info = `MOVIMENTO DO CAIXA - HOJE\n\n` +
                        `Vendas realizadas: ${quantidadeHoje}\n` +
                        `Total vendido: ${formatarMoeda(totalHoje)}\n\n` +
                        `Últimas 5 vendas:\n` +
                        vendasHoje.slice(-5).reverse().map(v => 
                            `#${v.id} - ${formatarMoeda(v.total)} - ${v.formaPagamento}`
                        ).join('\n');
            
            showInfo('CONSULTA DE MOVIMENTO', info);
        }
        
        // Reimprimir última venda (cupom normal, sem assinatura)
        async function reimprimirUltimaVenda() {
            if (vendas.length === 0) {
                showToast('Nenhuma venda encontrada!', 'warning');
                return;
            }
            
            const ultimaVenda = vendas[vendas.length - 1];
            
            // Buscar dados completos da venda
            let vendaCompleta = await ipcRenderer.invoke('venda-buscar', ultimaVenda.id);
            if (!vendaCompleta) {
                showToast('Erro ao buscar dados da venda!', 'error');
                return;
            }
            
            // Imprimir cupom normal (sem assinatura) - tipoCupom padrão é 'normal'
            await imprimirCupomFiscal(vendaCompleta, 'normal');
        }

        // Reimprimir última venda com assinatura (apenas A Prazo)
        async function reimprimirUltimaVendaComAssinatura() {
            if (vendas.length === 0) {
                showToast('Nenhuma venda encontrada!', 'warning');
                return;
            }
            
            const ultimaVenda = vendas[vendas.length - 1];
            
            // Verificar se é venda a prazo
            const formaPagamento = ultimaVenda.formaPagamento || ultimaVenda.forma_pagamento;
            if (formaPagamento !== 'A Prazo') {
                showToast('Apenas vendas a prazo podem ser impressas com assinatura!', 'warning');
                return;
            }
            
            // Buscar dados completos da venda
            let vendaCompleta = await ipcRenderer.invoke('venda-buscar', ultimaVenda.id);
            if (!vendaCompleta) {
                showToast('Erro ao buscar dados da venda!', 'error');
                return;
            }
            
            await imprimirCupomFiscal(vendaCompleta, 'assinatura');
            showToast('Comprovante com assinatura impresso!', 'success');
        }
        
        // ============ IMPRESSÃO DE CUPOM FISCAL ============
        
        // Gerar HTML do cupom fiscal para impressora térmica
        function gerarHTMLCupomFiscal(venda) {
            const numeroCupom = gerarNumeroCupom(venda.id);
            const nomeCaixa = usuarioLogado ? usuarioLogado.nome : 'Operador';
            const nomeEstabelecimento = 'COMERCIAL DOIS IRMÃO';
            const dataHora = venda.data ? new Date(venda.data).toLocaleString('pt-BR') : new Date().toLocaleString('pt-BR');
            const formaPagamento = venda.formaPagamento || venda.forma_pagamento || 'Não informado';
            const clienteNome = venda.cliente_nome || '';
            
            // Calcular totais
            const subtotal = (venda.itens || []).reduce((sum, item) => {
                const preco = item.preco || item.preco_unitario || 0;
                const qtd = item.quantidade || 1;
                return sum + (preco * qtd);
            }, 0);
            const desconto = venda.desconto || 0;
            const total = venda.total || (subtotal - desconto);
            const valorRecebido = venda.valorRecebido || total;
            const troco = venda.troco || 0;
            
            // Formatar itens
            let itensHTML = '';
            if (venda.itens && venda.itens.length > 0) {
                itensHTML = venda.itens.map(item => {
                    const nome = (item.nome || 'Produto sem nome').toUpperCase();
                    const quantidade = item.quantidade || 1;
                    const precoUnit = item.preco || item.preco_unitario || 0;
                    const subtotalItem = precoUnit * quantidade;
                    return `
                    <div style="margin-bottom:4px;">
                        <div style="font-weight:bold;">${nome}</div>
                        <div style="text-align:right;margin-top:2px;">
                            ${quantidade}x ${formatarMoeda(precoUnit)} = ${formatarMoeda(subtotalItem)}
                        </div>
                    </div>`;
                }).join('');
            }
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cupom Fiscal</title>
    <style>
        @media print {
            @page {
                size: 80mm auto;
                margin: 0;
            }
            body {
                margin: 0;
                padding: 10px;
            }
        }
        body {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            width: 80mm;
            margin: 0 auto;
            padding: 10px;
            line-height: 1.4;
        }
        .header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 2px dashed #000;
            padding-bottom: 8px;
        }
        .header h1 {
            margin: 0;
            font-size: 14px;
            font-weight: bold;
        }
        .header h2 {
            margin: 4px 0;
            font-size: 12px;
            font-weight: normal;
        }
        .separator {
            border-top: 1px dashed #000;
            margin: 8px 0;
        }
        .info {
            margin: 4px 0;
        }
        .info-label {
            font-weight: bold;
        }
        .items {
            margin: 8px 0;
        }
        .total-section {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #000;
        }
        .total-line {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }
        .total-final {
            font-weight: bold;
            font-size: 14px;
            margin-top: 6px;
        }
        .footer {
            text-align: center;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 2px dashed #000;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>${nomeEstabelecimento}</h1>
        <h2>CUPOM FISCAL</h2>
    </div>
    
    <div class="info">
        <div><span class="info-label">Venda:</span> #${venda.id}</div>
        <div><span class="info-label">Data/Hora:</span> ${dataHora}</div>
        <div><span class="info-label">Pagamento:</span> ${formaPagamento}</div>
        ${clienteNome ? `<div><span class="info-label">Cliente:</span> ${clienteNome}</div>` : ''}
    </div>
    
    <div class="separator"></div>
    
    <div class="items">
        <div style="font-weight:bold;margin-bottom:6px;">ITENS</div>
        ${itensHTML}
    </div>
    
    <div class="separator"></div>
    
    <div class="total-section">
        <div class="total-line">
            <span>Subtotal:</span>
            <span>${formatarMoeda(subtotal)}</span>
        </div>
        ${desconto > 0 ? `
        <div class="total-line">
            <span>Desconto:</span>
            <span>${formatarMoeda(desconto)}</span>
        </div>` : ''}
        ${formaPagamento === 'Dinheiro' ? `
        <div class="total-line">
            <span>Valor Recebido:</span>
            <span>${formatarMoeda(valorRecebido)}</span>
        </div>
        <div class="total-line">
            <span>Troco:</span>
            <span>${formatarMoeda(troco)}</span>
        </div>` : ''}
        <div class="total-line total-final">
            <span>TOTAL:</span>
            <span>${formatarMoeda(total)}</span>
        </div>
    </div>
    
    <div class="footer">
        <div>Caixa: ${nomeCaixa}</div>
        <div>Cupom: ${numeroCupom}</div>
        <div style="margin-top:8px;">
            <div>Obrigado pela preferência!</div>
            <div>Volte sempre!</div>
        </div>
    </div>
</body>
</html>`;
        }
        
        // Imprimir cupom fiscal usando window.print()
        async function imprimirCupomFiscal(venda, tipoCupom = 'normal') {
            return new Promise((resolve, reject) => {
                try {
                    gerarHTMLCupomFiscal(venda, tipoCupom).then(htmlCupom => {
                        // Criar janela oculta para impressão
                        const janelaImpressao = window.open('', '_blank', 'width=300,height=400');
                        if (!janelaImpressao) {
                            showToast('Erro: Não foi possível abrir a janela de impressão. Verifique se o bloqueador de pop-ups está desabilitado.', 'error');
                            reject(new Error('Não foi possível abrir janela de impressão'));
                            return;
                        }
                        
                        janelaImpressao.document.write(htmlCupom);
                        janelaImpressao.document.close();
                        
                        // Aguardar um pouco para garantir que o conteúdo foi carregado
                        const imprimir = () => {
                            setTimeout(() => {
                                janelaImpressao.print();
                                // Fechar a janela após alguns segundos (tempo para imprimir)
                                setTimeout(() => {
                                    janelaImpressao.close();
                                    resolve(); // Resolver após fechar a janela
                                }, 1000);
                            }, 100);
                        };
                        
                        if (janelaImpressao.document.readyState === 'complete') {
                            imprimir();
                        } else {
                            janelaImpressao.onload = imprimir;
                            
                            // Fallback caso onload não dispare
                            setTimeout(() => {
                                if (janelaImpressao.document.readyState === 'complete') {
                                    imprimir();
                                } else {
                                    // Se ainda não estiver pronto, tentar mesmo assim
                                    imprimir();
                                }
                            }, 500);
                        }
                    }).catch(error => {
                        console.error('Erro ao gerar HTML do cupom:', error);
                        showToast('Erro ao gerar cupom fiscal!', 'error');
                        reject(error);
                    });
                } catch (error) {
                    console.error('Erro ao imprimir cupom:', error);
                    showToast('Erro ao imprimir cupom fiscal!', 'error');
                    reject(error);
                }
            });
        }
        
        // Gerar número único do cupom
        function gerarNumeroCupom(vendaId) {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `${vendaId}${timestamp.toString().slice(-6)}${random.toString().padStart(3, '0')}T1`;
        }
        
        // Calcular saldo total em aberto (vendas a prazo não pagas)
        async function calcularSaldoAberto(clienteId) {
            if (!clienteId) return 0;
            
            // Buscar todas as vendas a prazo do cliente
            const todasVendas = await ipcRenderer.invoke('vendas-listar');
            const vendasPrazo = todasVendas.filter(v => 
                (v.formaPagamento === 'A Prazo' || v.forma_pagamento === 'A Prazo') && 
                (v.cliente_id === clienteId || v.clienteId === clienteId)
            );
            
            return vendasPrazo.reduce((sum, v) => sum + (parseFloat(v.total) || 0), 0);
        }
        
        // Formatar data para vencimento (30 dias após a venda)
        function calcularVencimento(dataVenda) {
            const data = dataVenda ? new Date(dataVenda) : new Date();
            data.setDate(data.getDate() + 30);
            return data.toLocaleDateString('pt-BR');
        }
        
        // Formatar data por extenso
        function formatarDataExtenso(data) {
            const dataObj = data ? new Date(data) : new Date();
            const diasSemana = ['DOMINGO', 'SEGUNDA-FEIRA', 'TERÇA-FEIRA', 'QUARTA-FEIRA', 'QUINTA-FEIRA', 'SEXTA-FEIRA', 'SÁBADO'];
            const meses = ['JANEIRO', 'FEVEREIRO', 'MARÇO', 'ABRIL', 'MAIO', 'JUNHO', 'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'];
            
            const diaSemana = diasSemana[dataObj.getDay()];
            const dia = dataObj.getDate();
            const mes = meses[dataObj.getMonth()];
            const ano = dataObj.getFullYear();
            
            return `${diaSemana}, ${dia} DE ${mes} DE ${ano}`;
        }
        
        async function gerarHTMLCupomFiscal(venda, tipoCupom = 'normal') {
            console.log('📄 [HTML] gerarHTMLCupomFiscal chamado');
            console.log('📄 [HTML] Dados da venda recebidos:', {
                id: venda.id,
                temItens: !!venda.itens,
                quantidadeItens: venda.itens ? venda.itens.length : 0,
                total: venda.total,
                formaPagamento: venda.formaPagamento || venda.forma_pagamento
            });
            
            const dataHora = venda.data ? new Date(venda.data).toLocaleString('pt-BR') : new Date().toLocaleString('pt-BR');
            const formaPagamento = venda.formaPagamento || venda.forma_pagamento || 'Não informado';
            const clienteNome = venda.cliente_nome || 'Cliente não informado';
            let clienteCpf = venda.cliente_cpf || '';
            // Formatar CPF se não estiver formatado
            if (clienteCpf && !clienteCpf.includes('.')) {
                clienteCpf = clienteCpf.replace(/\D/g, '');
                if (clienteCpf.length === 11) {
                    clienteCpf = clienteCpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                }
            }
            const numeroCupom = gerarNumeroCupom(venda.id);
            const nomeCaixa = usuarioLogado ? usuarioLogado.nome : 'Operador';
            const nomeEstabelecimento = 'COMERCIAL DOIS IRMÃO'; // Pode ser configurável no futuro
            
            // Calcular totais
            const subtotal = (venda.itens || []).reduce((sum, item) => {
                const preco = item.preco || item.preco_unitario || 0;
                const qtd = item.quantidade || 1;
                return sum + (preco * qtd);
            }, 0);
            const desconto = venda.desconto || 0;
            const total = venda.total || (subtotal - desconto);
            
            // Se for A Prazo com assinatura, gerar comprovante especial
            if (tipoCupom === 'assinatura' && formaPagamento === 'A Prazo') {
                return await gerarComprovanteAssinatura(venda, nomeEstabelecimento, numeroCupom, nomeCaixa, total);
            }
            
            // Formatar itens conforme modelo exato
            let itensHTML = '';
            if (venda.itens && venda.itens.length > 0) {
                itensHTML = venda.itens.map(item => {
                    const nome = (item.nome || 'Produto sem nome').toUpperCase();
                    const quantidade = item.quantidade || 1;
                    const precoUnit = item.preco || item.preco_unitario || 0;
                    const subtotalItem = precoUnit * quantidade;
                    const unidade = quantidade === 1 ? 'UN' : `${quantidade}UN`;
                    const precoFormatado = formatarMoeda(precoUnit).replace('R$ ', '').replace('.', ',');
                    const subtotalFormatado = formatarMoeda(subtotalItem).replace('R$ ', '').replace('.', ',');
                    
                    // Formatar conforme modelo exato: Nome + espaços + quantidade x preço = subtotal
                    // Exemplo: "Amstel Unidade                             1UN x 4,00 = 4,00"
                    // Usar padding para alinhar à direita
                    const infoDireita = `${unidade} x ${precoFormatado} = ${subtotalFormatado}`;
                    const larguraTotal = 42; // Largura total da linha em caracteres
                    const espacos = ' '.repeat(Math.max(1, larguraTotal - nome.length - infoDireita.length));
                    return `${nome}${espacos}${infoDireita}`;
                }).join('\n');
            }
            
            // Se for A Prazo, gerar cupom a prazo
            if (formaPagamento === 'A Prazo') {
                console.log('📄 [HTML] Gerando cupom A PRAZO');
                const vencimento = calcularVencimento(venda.data);
                const saldoAberto = await calcularSaldoAberto(venda.cliente_id || venda.clienteId);
                const subtotalFormatado = formatarMoeda(subtotal).replace('R$ ', '').replace('.', ',');
                const totalFormatado = formatarMoeda(total).replace('R$ ', '').replace('.', ',');
                const saldoFormatado = formatarMoeda(saldoAberto).replace('R$ ', '').replace('.', ',');
                console.log('📄 [HTML] Cupom A Prazo gerado, retornando HTML...');
                
                return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @media print {
            @page {
                size: 80mm auto;
                margin: 0;
            }
            body {
                margin: 0;
                padding: 8px;
                visibility: visible !important;
                display: block !important;
            }
            * {
                visibility: visible !important;
            }
        }
        body {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            width: 80mm;
            margin: 0 auto;
            padding: 8px;
            line-height: 1.4;
            visibility: visible;
            display: block;
            color: #000 !important;
            background: #fff !important;
            white-space: pre-wrap;
        }
        * {
            font-weight: bold;
            color: #000 !important;
        }
    </style>
</head>
<body>
         ${nomeEstabelecimento}
    Data/Hora: ${dataHora}
    --------------------------------------
${itensHTML}
--------------------------------------
             SUB-TOTAL:          ${subtotalFormatado}
                 TOTAL:          ${totalFormatado}
 Vencimento: ${vencimento}
--------------------------------------
 SALDO TOTAL EM ABERTO HOJE: R$ ${saldoFormatado}
--------------------------------------
Cliente: ${clienteNome.toUpperCase()}
${clienteCpf ? `CPF/CNPJ: ${clienteCpf}` : ''}
Comprador: _o Mesmo
Caixa: ${nomeCaixa} - Cupom: ${numeroCupom}
--------------------------------------
       Agradecemos a Preferência
</body>
</html>
                `;
            }
            
            // Cupom à vista (Dinheiro, PIX, Débito, Crédito, etc.)
            console.log('📄 [HTML] Gerando cupom À VISTA - Forma de pagamento:', formaPagamento);
            // Buscar valor recebido e troco da venda se disponível
            const valorRecebido = venda.valorRecebido || total;
            const troco = formaPagamento === 'Dinheiro' ? (parseFloat(valorRecebido) - parseFloat(total)) : 0;
            const totalFormatado = formatarMoeda(total).replace('R$ ', '').replace('.', ',');
            const valorRecebidoFormatado = formatarMoeda(valorRecebido).replace('R$ ', '').replace('.', ',');
            const trocoFormatado = formatarMoeda(Math.max(0, troco)).replace('R$ ', '').replace('.', ',');
            console.log('📄 [HTML] Cupom à vista gerado, retornando HTML. Total:', totalFormatado, 'Valor recebido:', valorRecebidoFormatado);
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @media print {
            @page {
                size: 80mm auto;
                margin: 0;
            }
            body {
                margin: 0;
                padding: 8px;
                visibility: visible !important;
                display: block !important;
            }
            * {
                visibility: visible !important;
            }
        }
        body {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            width: 80mm;
            margin: 0 auto;
            padding: 8px;
            line-height: 1.4;
            visibility: visible;
            display: block;
            color: #000 !important;
            background: #fff !important;
            white-space: pre-wrap;
        }
        * {
            font-weight: bold;
            color: #000 !important;
        }
    </style>
</head>
<body>
         ${nomeEstabelecimento}
    Data/Hora: ${dataHora}
    --------------------------------------
${itensHTML}
--------------------------------------
                           TOTAL: ${totalFormatado}
${formaPagamento}:       ${valorRecebidoFormatado}
${formaPagamento === 'Dinheiro' ? `Troco:          ${trocoFormatado}` : ''}
--------------------------------------
Caixa: ${nomeCaixa} - Cupom: ${numeroCupom}
--------------------------------------
       Agradecemos a Preferência
</body>
</html>
            `;
        }
        
        // Gerar comprovante com assinatura para venda a prazo
        async function gerarComprovanteAssinatura(venda, nomeEstabelecimento, numeroCupom, nomeCaixa, total) {
            const dataCompra = venda.data ? new Date(venda.data).toLocaleString('pt-BR') : new Date().toLocaleString('pt-BR');
            const vencimento = calcularVencimento(venda.data);
            const dataExtenso = formatarDataExtenso(venda.data);
            const clienteNome = venda.cliente_nome || 'Cliente não informado';
            let clienteCpf = venda.cliente_cpf || '';
            // Formatar CPF se não estiver formatado
            if (clienteCpf && !clienteCpf.includes('.')) {
                clienteCpf = clienteCpf.replace(/\D/g, '');
                if (clienteCpf.length === 11) {
                    clienteCpf = clienteCpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                }
            }
            const saldoAberto = await calcularSaldoAberto(venda.cliente_id);
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @media print {
            @page {
                size: 80mm auto;
                margin: 0;
            }
            body {
                margin: 0;
                padding: 8px;
                visibility: visible !important;
                display: block !important;
            }
            * {
                visibility: visible !important;
            }
        }
        body {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            font-weight: bold;
            width: 80mm;
            margin: 0 auto;
            padding: 8px;
            line-height: 1.3;
            visibility: visible;
            display: block;
            color: #000 !important;
            background: #fff !important;
        }
        * {
            font-weight: bold !important;
            color: #000 !important;
        }
        .header {
            text-align: center;
            margin-bottom: 8px;
            font-weight: bold;
            visibility: visible;
            display: block;
        }
        .separator {
            border-top: 1px dashed #000;
            margin: 6px 0;
        }
        .text-center {
            text-align: center;
        }
        .signature-line {
            border-top: 1px solid #000;
            margin-top: 40px;
            padding-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        COMPROVANTE DE VENDA A PRAZO (ACEITE)
    </div>
    
    <div style="margin:4px 0;">
        <div>Data da compra: ${dataCompra}</div>
        <div>Caixa: ${nomeCaixa} - Cupom: ${numeroCupom}</div>
        <div>Valor Total: ${formatarMoeda(total).replace('R$ ', '')}</div>
        <div>Vencimento: ${vencimento}</div>
    </div>
    
    <div style="margin:4px 0;">
        <div>SALDO TOTAL EM ABERTO HOJE:</div>
        <div style="font-weight:bold;">R$ ${formatarMoeda(saldoAberto).replace('R$ ', '').replace('.', ',')}</div>
    </div>
    
    <div style="margin:8px 0;font-size:9px;">
        <div>RECONHECO E ACEITO O VALOR DO DEBITO</div>
        <div>O QUAL SERA PAGO CONFORME CLAUSULAS</div>
        <div>CONTRATUAIS DO CREDIARIO.</div>
    </div>
    
    <div style="margin:8px 0;text-align:center;font-weight:bold;">
        ${dataExtenso}
    </div>
    
    <div style="border-top:1px solid #000;margin:20px 0;padding-top:5px;text-align:center;">
        NUTROSTE NUTRIÇÃO ANIMAL LTDA
        CPF/CNPJ: 25.134.487/0009-83
    </div>
</body>
</html>
            `;
        }
        
        // ========== FUNÇÕES HELPER PARA IMPRESSÃO ESC/POS ==========
        // Largura padrão para impressora térmica 80mm = 80 caracteres
        // Aumentada para 80 caracteres para que o texto apareça menor e mais compacto no papel
        const LARGURA_CUPOM = 80;
        
        // Função helper: criar linha separadora
        function linhaSeparadora() {
            return '-'.repeat(LARGURA_CUPOM);
        }
        
        // Função helper: formatar linha limitando a largura
        function formatarLinha(texto, alinhamento = 'esquerda') {
            const textoLimpo = texto.trim();
            if (textoLimpo.length <= LARGURA_CUPOM) {
                if (alinhamento === 'direita') {
                    return textoLimpo.padStart(LARGURA_CUPOM);
                } else if (alinhamento === 'centro') {
                    const espacos = LARGURA_CUPOM - textoLimpo.length;
                    const espacoEsquerda = Math.floor(espacos / 2);
                    return ' '.repeat(espacoEsquerda) + textoLimpo;
                }
                return textoLimpo;
            }
            // Se exceder, retornar truncado
            return textoLimpo.substring(0, LARGURA_CUPOM);
        }
        
        // Função helper: limpar texto final (remover quebras de linha excessivas)
        // IMPORTANTE: Para impressora térmica ESC/POS (ELGIN i7), cada \n causa avanço físico de papel
        // Portanto, REMOVEMOS TODAS as quebras no final para evitar avanço excessivo
        function limparTextoFinal(texto) {
            return texto
                .replace(/\r\n/g, '\n')  // Normalizar quebras de linha (CRLF → LF)
                .replace(/\n{3,}/g, '\n\n')  // Máximo 2 quebras consecutivas
                .replace(/^\n+/, '')  // Remover quebras no início
                .replace(/\s+$/, '')  // Remover TODOS os espaços em branco no final (incluindo \n)
                .trimEnd();  // Garantir que não há espaços/quebras no final
        }
        
        // Gerar comprovante de assinatura em texto simples
        async function gerarTextoCupomAssinatura(venda, nomeEstabelecimento, numeroCupom, nomeCaixa, total) {
            const dataCompra = venda.data ? new Date(venda.data).toLocaleString('pt-BR') : new Date().toLocaleString('pt-BR');
            const vencimento = calcularVencimento(venda.data);
            const dataExtenso = formatarDataExtenso(venda.data);
            const saldoAberto = await calcularSaldoAberto(venda.cliente_id || venda.clienteId);
            const totalFormatado = formatarMoeda(total).replace('R$ ', '').replace('.', ',');
            const saldoFormatado = formatarMoeda(saldoAberto).replace('R$ ', '').replace('.', ',');
            const clienteNome = venda.cliente_nome || 'Cliente não informado';
            let clienteCpf = venda.cliente_cpf || '';
            if (clienteCpf && !clienteCpf.includes('.')) {
                clienteCpf = clienteCpf.replace(/\D/g, '');
                if (clienteCpf.length === 11) {
                    clienteCpf = clienteCpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                } else if (clienteCpf.length === 14) {
                    clienteCpf = clienteCpf.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                }
            }
            
            const texto = `COMPROVANTE DE VENDA A PRAZO (ACEITE)
${formatarLinha(`Data da compra: ${dataCompra}`)}
${formatarLinha(`Caixa: ${nomeCaixa} - Cupom: ${numeroCupom}`)}
${formatarLinha(`Valor Total: ${totalFormatado}`)}
${formatarLinha(`Vencimento: ${vencimento}`)}
${formatarLinha(`SALDO TOTAL EM ABERTO HOJE: R$ ${saldoFormatado}`)}
${formatarLinha('RECONHECO E ACEITO O VALOR DO DEBITO')}
${formatarLinha('O QUAL SERA PAGO CONFORME CLAUSULAS')}
${formatarLinha('CONTRATUAIS DO CREDIARIO.')}
${formatarLinha(dataExtenso, 'centro')}
${linhaSeparadora()}
${formatarLinha(nomeEstabelecimento, 'centro')}
${formatarLinha(`CPF/CNPJ: ${clienteCpf || '25.134.487/0009-83'}`)}`;
            
            return limparTextoFinal(texto);
        }
        
        function abrirGavetaDinheiro() {
            showToast('Abrindo gaveta do dinheiro...', 'info', 2000);
            // Aqui pode ser integrado com comando de abertura de gaveta USB
        }
        
        function abrirCalculadora() {
            // Abrir calculadora do sistema
            if (navigator && navigator.clipboard) {
                showToast('Calculadora do sistema - Use a calculadora do Windows', 'info', 3000);
            } else {
                showInfo('CALCULADORA', 'Use a calculadora do sistema operacional\n\nWindows: Pressione Win+R e digite "calc"');
            }
        }
        
        function abrirRecebimentoContas() {
            if (vendas.length === 0) {
                showToast('Nenhuma venda a prazo encontrada!', 'info');
                return;
            }
            
            const vendasPrazo = vendas.filter(v => v.formaPagamento === 'A Prazo');
            if (vendasPrazo.length === 0) {
                showToast('Nenhuma venda a prazo encontrada!', 'info');
                return;
            }
            
            showInfo('RECEBIMENTO DE CONTAS', 
                `Vendas a prazo pendentes: ${vendasPrazo.length}\n\n` +
                vendasPrazo.slice(0, 10).map(v => 
                    `Venda #${v.id} - ${formatarMoeda(v.total)} - ${new Date(v.data).toLocaleDateString('pt-BR')}`
                ).join('\n') +
                (vendasPrazo.length > 10 ? '\n...' : '')
            );
        }
        
        function abrirAnotacoes() {
            showInfo('ANOTAÇÕES', 'Sistema de anotações\n\nEm desenvolvimento...');
        }
        
        // Limpar carrinho
        async function limparCarrinho() {
            const ok = await showConfirm('Deseja limpar o carrinho?');
            if (!ok) return;
            carrinho = [];
            document.getElementById('desconto').value = 0;
            atualizarCarrinho();
            showToast('Carrinho limpo', 'success');
        }

        // Finalizar venda
        function finalizarVenda() {
            if (carrinho.length === 0) {
                showToast('Carrinho vazio!', 'warning');
                return;
            }

            const total = parsearValorMonetario(document.getElementById('total').textContent);
            document.getElementById('totalPagamento').textContent = formatarMoeda(total);
            
            // Resetar completamente todos os campos do modal
            const formaSelect = document.getElementById('formaPagamento');
            const valorRecebidoInput = document.getElementById('valorRecebido');
            const divValorRecebido = document.getElementById('divValorRecebido');
            const divTroco = document.getElementById('divTroco');
            
            // Limpar valores e resetar para estado inicial
            formaSelect.value = '';
            valorRecebidoInput.value = '';
            
            // Habilitar campos (garantir que não estejam desabilitados)
            formaSelect.disabled = false;
            valorRecebidoInput.disabled = false;
            
            // Remover estilos de erro
            formaSelect.style.borderColor = '#cbd5e1';
            valorRecebidoInput.style.borderColor = '#cbd5e1';
            formaSelect.style.backgroundColor = 'white';
            valorRecebidoInput.style.backgroundColor = 'white';
            
            // Esconder campos de valor recebido, troco e cliente inicialmente
            divValorRecebido.style.display = 'none';
            divTroco.style.display = 'none';
            const divClientePrazo = document.getElementById('divClientePrazo');
            const selectClientePrazo = document.getElementById('clientePrazo');
            if (divClientePrazo) divClientePrazo.style.display = 'none';
            if (selectClientePrazo) {
                selectClientePrazo.required = false;
                selectClientePrazo.value = '';
            }
            
            // Remover required do valor recebido inicialmente
            valorRecebidoInput.required = false;
            valorRecebidoInput.removeAttribute('required');
            
            // Abrir modal
            document.getElementById('modalPagamento').classList.add('active');
            
            // Focar imediatamente no campo de forma de pagamento
            formaSelect.disabled = false;
            formaSelect.focus();
            
            // Adicionar listener para Enter no modal
            const modalPagamento = document.getElementById('modalPagamento');
            if (modalPagamento) {
                // Remover listener anterior se existir (usando capture para garantir)
                modalPagamento.removeEventListener('keydown', handleEnterModal, true);
                // Adicionar novo listener com capture para pegar antes de outros handlers
                modalPagamento.addEventListener('keydown', handleEnterModal, true);
            }
        }
        
        // Handler para Enter no modal de pagamento
        function handleEnterModal(e) {
            // Só processar se for Enter
            if (e.key !== 'Enter' && e.keyCode !== 13) {
                return;
            }
            
            const inputId = e.target.id;
            const tagName = e.target.tagName.toLowerCase();
            
            // Se estiver digitando no campo de valor recebido, verificar se pode confirmar
            if (inputId === 'valorRecebido') {
                const valorRecebido = parseFloat(e.target.value || 0);
                const total = parsearValorMonetario(document.getElementById('totalPagamento').textContent);
                
                calcularTroco();
                
                // Se o valor recebido for suficiente, confirmar venda
                if (valorRecebido >= total && valorRecebido > 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    confirmarVenda();
                    return false;
                }
                
                // Se não for suficiente, apenas calcular troco (não confirmar ainda)
                // Mas ainda permite que o usuário continue digitando
                return;
            }
            
            // Para qualquer outro campo ou lugar do modal, confirmar venda diretamente
            e.preventDefault();
            e.stopPropagation();
            confirmarVenda();
            return false;
        }

        // Calcular troco
        function calcularTroco() {
            const forma = document.getElementById('formaPagamento').value;
            const divRecebido = document.getElementById('divValorRecebido');
            const divTroco = document.getElementById('divTroco');
            const divClientePrazo = document.getElementById('divClientePrazo');
            const selectClientePrazo = document.getElementById('clientePrazo');
            const inputValorRecebido = document.getElementById('valorRecebido');

            if (forma === 'Dinheiro') {
                // Mostrar e habilitar campo de valor recebido
                divRecebido.style.display = 'block';
                divTroco.style.display = 'none';
                divClientePrazo.style.display = 'none';
                inputValorRecebido.disabled = false;
                inputValorRecebido.required = true;
                if (selectClientePrazo) selectClientePrazo.required = false;
                
                const total = parsearValorMonetario(document.getElementById('totalPagamento').textContent);
                const recebido = parseFloat(inputValorRecebido.value || 0);
                const troco = recebido - total;
                
                if (recebido > 0 && troco >= 0) {
                    divTroco.style.display = 'block';
                    document.getElementById('troco').textContent = formatarMoeda(troco);
                }
            } else if (forma === 'A Prazo') {
                // Para "A Prazo", mostrar campo de seleção de cliente
                divRecebido.style.display = 'none';
                divTroco.style.display = 'none';
                divClientePrazo.style.display = 'block';
                inputValorRecebido.required = false;
                inputValorRecebido.value = '';
                inputValorRecebido.disabled = false;
                if (selectClientePrazo) {
                    selectClientePrazo.required = true;
                    // Carregar clientes no select se ainda não estiverem carregados
                    if (selectClientePrazo.options.length <= 1) {
                        carregarClientesNoSelect();
                    }
                }
            } else if (forma && forma !== 'Dinheiro' && forma !== 'A Prazo') {
                // Para outras formas de pagamento (Débito, Crédito, PIX), esconder tudo
                divRecebido.style.display = 'none';
                divTroco.style.display = 'none';
                divClientePrazo.style.display = 'none';
                inputValorRecebido.required = false;
                inputValorRecebido.value = '';
                inputValorRecebido.disabled = false;
                if (selectClientePrazo) selectClientePrazo.required = false;
            } else {
                // Se nenhuma forma foi selecionada, esconder tudo
                divRecebido.style.display = 'none';
                divTroco.style.display = 'none';
                divClientePrazo.style.display = 'none';
                inputValorRecebido.required = false;
                inputValorRecebido.value = '';
                if (selectClientePrazo) selectClientePrazo.required = false;
            }
        }
        
        // Carregar clientes no select do modal de pagamento
        async function carregarClientesNoSelect() {
            const selectClientePrazo = document.getElementById('clientePrazo');
            if (!selectClientePrazo) return;
            
            // Se clientes já estiverem carregados, usar eles
            if (clientes && clientes.length > 0) {
                selectClientePrazo.innerHTML = '<option value="">Selecione o cliente</option>' +
                    clientes.map(c => `<option value="${c.id}">${c.nome} - ${formatarCPF(c.cpf)}</option>`).join('');
            } else {
                // Carregar clientes
                const clientesLista = await ipcRenderer.invoke('clientes-listar');
                selectClientePrazo.innerHTML = '<option value="">Selecione o cliente</option>' +
                    clientesLista.map(c => `<option value="${c.id}">${c.nome} - ${formatarCPF(c.cpf)}</option>`).join('');
            }
        }

        // Confirmar venda
        async function confirmarVenda() {
            const btnConfirmar = document.getElementById('btnConfirmarVenda');
            const btnLabel = document.getElementById('btnConfirmarVendaLabel');
            const btnSpinner = document.getElementById('btnConfirmarVendaSpinner');

            try {
                if (btnConfirmar) {
                    btnConfirmar.disabled = true;
                    btnConfirmar.classList.add('btn-loading');
                }
                if (btnLabel) btnLabel.style.display = 'none';
                if (btnSpinner) btnSpinner.style.display = 'inline-block';

                const formaSelect = document.getElementById('formaPagamento');
            const valorRecebidoInput = document.getElementById('valorRecebido');
            
            // Remover estilos de erro anteriores
            formaSelect.style.borderColor = '#cbd5e1';
            valorRecebidoInput.style.borderColor = '#cbd5e1';
            
            // Forma de pagamento (opcional)
            const forma = formaSelect.value || 'Não informado';

            const total = parsearValorMonetario(document.getElementById('totalPagamento').textContent);
            const desconto = parseFloat(document.getElementById('desconto').value.replace(',', '.') || 0);

            // Validar valor recebido se for dinheiro
            if (forma === 'Dinheiro') {
                const recebido = parseFloat(String(valorRecebidoInput.value || 0).replace(',', '.'));
                
                if (!valorRecebidoInput.value || valorRecebidoInput.value.trim() === '' || recebido <= 0) {
                    showToast('Informe o valor recebido!', 'error');
                    valorRecebidoInput.style.borderColor = '#dc2626';
                    valorRecebidoInput.focus();
                    if (btnConfirmar) {
                        btnConfirmar.disabled = false;
                        btnConfirmar.classList.remove('btn-loading');
                    }
                    if (btnLabel) btnLabel.style.display = 'inline-flex';
                    if (btnSpinner) btnSpinner.style.display = 'none';
                    return;
                }
                
                if (recebido < total) {
                    showToast(`Valor recebido insuficiente! Faltam ${formatarMoeda(total - recebido)}`, 'error');
                    valorRecebidoInput.style.borderColor = '#dc2626';
                    valorRecebidoInput.focus();
                    if (btnConfirmar) {
                        btnConfirmar.disabled = false;
                        btnConfirmar.classList.remove('btn-loading');
                    }
                    if (btnLabel) btnLabel.style.display = 'inline-flex';
                    if (btnSpinner) btnSpinner.style.display = 'none';
                    return;
                }
            }
            
            // Validar cliente se for A Prazo
            let clienteId = null;
            if (forma === 'A Prazo') {
                const selectClientePrazo = document.getElementById('clientePrazo');
                if (!selectClientePrazo || !selectClientePrazo.value) {
                    showToast('Selecione o cliente para finalizar a venda a prazo!', 'error');
                    if (selectClientePrazo) {
                        selectClientePrazo.style.borderColor = '#dc2626';
                        selectClientePrazo.focus();
                    }
                    if (btnConfirmar) {
                        btnConfirmar.disabled = false;
                        btnConfirmar.classList.remove('btn-loading');
                    }
                    if (btnLabel) btnLabel.style.display = 'inline-flex';
                    if (btnSpinner) btnSpinner.style.display = 'none';
                    return;
                }
                clienteId = parseInt(selectClientePrazo.value);
            }
            
            // Se chegou aqui, validações passaram - remover estilos de erro
            formaSelect.style.borderColor = '#cbd5e1';
            valorRecebidoInput.style.borderColor = '#cbd5e1';
            const selectClientePrazo = document.getElementById('clientePrazo');
            if (selectClientePrazo) selectClientePrazo.style.borderColor = '#cbd5e1';

            // Calcular valor recebido e troco
            const valorRecebido = forma === 'Dinheiro' ? parseFloat(String(valorRecebidoInput.value || 0).replace(',', '.')) : total;
            const troco = forma === 'Dinheiro' ? Math.max(0, valorRecebido - total) : 0;
            
            const venda = {
                total: total,
                desconto: desconto,
                forma_pagamento: forma,
                cliente_id: clienteId,
                valorRecebido: valorRecebido,
                troco: troco
            };

            const itens = carrinho.map(i => ({
                id: i.id,
                quantidade: i.quantidade,
                preco: i.preco
            }));

            const result = await ipcRenderer.invoke('venda-criar', { venda, itens });

            if (result.success) {
                console.log('✅ Venda criada com sucesso, ID:', result.id);
                console.log('🔍 [IMPRESSÃO] Iniciando processo de impressão para venda ID:', result.id);
                
                // Recarregar vendas do banco
                console.log('🔍 [IMPRESSÃO] Recarregando lista de vendas...');
                vendas = await ipcRenderer.invoke('vendas-listar');
                console.log('🔍 [IMPRESSÃO] Vendas carregadas:', vendas.length, 'vendas encontradas');
                
                // Buscar dados completos da venda para impressão
                let vendaCompleta = vendas.find(v => v.id === result.id);
                console.log('🔍 [IMPRESSÃO] Venda encontrada na lista?', vendaCompleta ? 'SIM' : 'NÃO');
                if (vendaCompleta) {
                    console.log('🔍 [IMPRESSÃO] Dados da venda:', {
                        id: vendaCompleta.id,
                        temItens: !!vendaCompleta.itens,
                        quantidadeItens: vendaCompleta.itens ? vendaCompleta.itens.length : 0,
                        total: vendaCompleta.total,
                        formaPagamento: vendaCompleta.formaPagamento || vendaCompleta.forma_pagamento
                    });
                }
                
                // Se não encontrou com itens, buscar do banco
                if (!vendaCompleta || !vendaCompleta.itens || vendaCompleta.itens.length === 0) {
                    console.log('🔍 [IMPRESSÃO] Buscando venda completa do banco de dados...');
                    vendaCompleta = await ipcRenderer.invoke('venda-buscar', result.id);
                    console.log('🔍 [IMPRESSÃO] Venda do banco:', vendaCompleta ? 'ENCONTRADA' : 'NÃO ENCONTRADA');
                    if (vendaCompleta) {
                        console.log('🔍 [IMPRESSÃO] Dados da venda do banco:', {
                            id: vendaCompleta.id,
                            temItens: !!vendaCompleta.itens,
                            quantidadeItens: vendaCompleta.itens ? vendaCompleta.itens.length : 0,
                            total: vendaCompleta.total,
                            formaPagamento: vendaCompleta.formaPagamento || vendaCompleta.forma_pagamento
                        });
                    }
                }
                
                // Imprimir cupom fiscal
                if (vendaCompleta) {
                    console.log('🔍 [IMPRESSÃO] Preparando venda para impressão...');
                    // Usar dados do carrinho se a venda ainda não tiver itens carregados
                    if (!vendaCompleta.itens || vendaCompleta.itens.length === 0) {
                        console.log('🔍 [IMPRESSÃO] Venda sem itens, usando dados do carrinho. Itens no carrinho:', carrinho.length);
                        vendaCompleta.itens = carrinho.map(item => ({
                            nome: item.nome,
                            quantidade: item.quantidade,
                            preco: item.preco,
                            preco_unitario: item.preco
                        }));
                    }
                    // Adicionar valorRecebido e troco à venda completa
                    vendaCompleta.valorRecebido = valorRecebido;
                    vendaCompleta.troco = troco;
                    console.log('🔍 [IMPRESSÃO] Chamando imprimirCupomFiscal com:', {
                        id: vendaCompleta.id,
                        itens: vendaCompleta.itens.length,
                        total: vendaCompleta.total,
                        valorRecebido: vendaCompleta.valorRecebido,
                        troco: vendaCompleta.troco
                    });
                    
                    // Imprimir cupom fiscal
                    await imprimirCupomFiscal(vendaCompleta);
                    
                    // Se for venda a prazo, imprimir também o comprovante com assinatura
                    if (forma === 'A Prazo') {
                        console.log('🔍 [IMPRESSÃO] Venda a prazo detectada, imprimindo comprovante com assinatura...');
                        await imprimirCupomFiscal(vendaCompleta, 'assinatura');
                    }
                } else {
                    console.error('❌ [VENDA] ERRO: vendaCompleta é null/undefined!');
                }
                
                // Desabilitar spinner ANTES de fechar o modal e fazer outras operações
                if (btnConfirmar) {
                    btnConfirmar.disabled = false;
                    btnConfirmar.classList.remove('btn-loading');
                }
                if (btnLabel) btnLabel.style.display = 'inline-flex';
                if (btnSpinner) btnSpinner.style.display = 'none';
                
                // Fechar modal APÓS desabilitar spinner
                fecharModalPagamento();
                
                showToast('Venda realizada com sucesso!', 'success');
                carrinho = [];
                document.getElementById('desconto').value = 0;
                atualizarCarrinho();
                atualizarEstatisticas();
                carregarProdutosGrid();
                
                // Sempre atualizar histórico (mesmo que não esteja visível, para quando abrir)
                carregarHistorico();
                
                // Se a aba de histórico estiver aberta, garantir que está visível
                const tabHistorico = document.getElementById('tab-historico');
                if (tabHistorico && !tabHistorico.classList.contains('hidden')) {
                    // Já foi atualizado acima, mas garantir que está correto
                    console.log('📋 Histórico atualizado (aba aberta)');
                }
                
                // Atualizar valor do cliente se for venda a prazo
                if (forma === 'A Prazo' && clienteId) {
                    try {
                        console.log('👤 [CLIENTE] Atualizando valor do cliente ID:', clienteId);
                        const clienteAtual = await ipcRenderer.invoke('cliente-buscar', clienteId);
                        if (clienteAtual) {
                            const valorAtual = parseFloat(clienteAtual.status) || 0;
                            const valorVenda = parseFloat(total) || 0;

                            // Sempre somar o valor da venda ao valor atual (acumulativo)
                            const novoValor = valorAtual + valorVenda;
                            console.log('👤 [CLIENTE] Atualizando valor do cliente:');
                            console.log('👤 [CLIENTE] Valor atual:', valorAtual);
                            console.log('👤 [CLIENTE] Valor da venda:', valorVenda);
                            console.log('👤 [CLIENTE] Novo valor acumulado:', novoValor);

                            // Atualizar cliente (incluindo data de cadastro com a data atual)
                            const agora = new Date();
                            const diaAtual = agora.getDate();
                            const mesAtual = agora.getMonth() + 1; // getMonth() retorna 0-11, então +1 para 1-12
                            
                            const resultadoAtualizacao = await ipcRenderer.invoke('cliente-atualizar', {
                                id: clienteId,
                                cliente: {
                                    nome: clienteAtual.nome,
                                    cpf: clienteAtual.cpf,
                                    status: novoValor.toString(),
                                    dia_cadastro: diaAtual,
                                    mes_cadastro: mesAtual
                                }
                            });
                            
                            if (resultadoAtualizacao.success) {
                                console.log('✅ [CLIENTE] Cliente atualizado com sucesso. Novo valor:', novoValor);
                                // Recarregar clientes se a aba estiver aberta
                                const tabClientes = document.getElementById('tab-clientes');
                                if (tabClientes && !tabClientes.classList.contains('hidden')) {
                                    await carregarClientes();
                                    console.log('👤 [CLIENTE] Lista de clientes recarregada');
                                }
                            } else {
                                console.error('❌ [CLIENTE] Erro ao atualizar cliente:', resultadoAtualizacao.error);
                            }
                        } else {
                            console.error('❌ [CLIENTE] Cliente não encontrado com ID:', clienteId);
                        }
                    } catch (error) {
                        console.error('❌ [CLIENTE] Erro ao atualizar valor do cliente:', error);
                    }
                }
            } else {
                console.error('❌ Erro ao salvar venda:', result.error);
                showToast('Erro ao salvar venda: ' + (result.error || 'Erro desconhecido'), 'error');
                
                // Desabilitar spinner em caso de erro também
                if (btnConfirmar) {
                    btnConfirmar.disabled = false;
                    btnConfirmar.classList.remove('btn-loading');
                }
                if (btnLabel) btnLabel.style.display = 'inline-flex';
                if (btnSpinner) btnSpinner.style.display = 'none';
            }
        } catch (error) {
            console.error('❌ Erro ao confirmar venda:', error);
            showToast('Erro ao confirmar venda: ' + (error.message || 'Erro desconhecido'), 'error');
            
            // Desabilitar spinner em caso de exceção também
            const btnConfirmar = document.getElementById('btnConfirmarVenda');
            const btnLabel = document.getElementById('btnConfirmarVendaLabel');
            const btnSpinner = document.getElementById('btnConfirmarVendaSpinner');
            
            if (btnConfirmar) {
                btnConfirmar.disabled = false;
                btnConfirmar.classList.remove('btn-loading');
            }
            if (btnLabel) btnLabel.style.display = 'inline-flex';
            if (btnSpinner) btnSpinner.style.display = 'none';
        }
        }

        // Fechar modal pagamento
        function fecharModalPagamento() {
            // Fechar modal primeiro
            const modalPagamento = document.getElementById('modalPagamento');
            modalPagamento.classList.remove('active');
            
            // Remover listener de Enter ao fechar (usando capture para garantir)
            modalPagamento.removeEventListener('keydown', handleEnterModal, true);
            
            // Resetar completamente todos os campos ao fechar
            const formaSelect = document.getElementById('formaPagamento');
            const valorRecebidoInput = document.getElementById('valorRecebido');
            const divValorRecebido = document.getElementById('divValorRecebido');
            const divTroco = document.getElementById('divTroco');
            
            // Limpar valores
            formaSelect.value = '';
            valorRecebidoInput.value = '';
            
            // Habilitar campos
            formaSelect.disabled = false;
            valorRecebidoInput.disabled = false;
            
            // Remover estilos
            formaSelect.style.borderColor = '#cbd5e1';
            valorRecebidoInput.style.borderColor = '#cbd5e1';
            formaSelect.style.backgroundColor = 'white';
            valorRecebidoInput.style.backgroundColor = 'white';
            
            // Esconder campos
            divValorRecebido.style.display = 'none';
            divTroco.style.display = 'none';
            const divClientePrazo = document.getElementById('divClientePrazo');
            const selectClientePrazo = document.getElementById('clientePrazo');
            if (divClientePrazo) divClientePrazo.style.display = 'none';
            if (selectClientePrazo) {
                selectClientePrazo.value = '';
                selectClientePrazo.required = false;
                selectClientePrazo.style.borderColor = '#cbd5e1';
            }
            
            // Remover required
            valorRecebidoInput.required = false;
            valorRecebidoInput.removeAttribute('required');
        }

        // Estatísticas
        async function atualizarEstatisticas() {
            const stats = await ipcRenderer.invoke('vendas-estatisticas');
            
            document.getElementById('vendasHoje').textContent = formatarMoeda(stats.vendasHoje);
            document.getElementById('vendasMes').textContent = formatarMoeda(stats.vendasMes);
            document.getElementById('totalProdutos').textContent = stats.totalProdutos;
        }

        // Variável para produtos selecionados
        let produtosSelecionados = new Set();

        // Produtos - Otimizado com paginação para grandes volumes
        function carregarProdutos() {
            const tbody = document.getElementById('tabelaProdutos');
            const termoBusca = document.getElementById('buscaProdutos')?.value?.trim().toLowerCase() || '';
            
            // Estado vazio - nenhum produto cadastrado
            if (!produtos || produtos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 60px 20px;">
                            <div style="text-align: center; color: #64748b;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" style="display: block; margin: 0 auto 16px; opacity: 0.5;">
                                    <path fill="currentColor" d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67l-.5-.68C10.96 2.54 10 2 9 2C7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2m-5-2c.55 0 1 .45 1 1s-.45 1-1 1s-1-.45-1-1s.45-1 1-1M9 4c.55 0 1 .45 1 1s-.45 1-1 1s-1-.45-1-1s.45-1 1-1m11 15H4v-2h16zm0-5H4V8h5.08L7 10.83L8.62 12L11 8.76l1-1.36l4 5.6H20z"/>
                                </svg>
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #475569;">Nenhum produto cadastrado</h3>
                                <p style="font-size: 14px; margin-bottom: 24px;">Comece cadastrando seus produtos para gerenciar seu estoque</p>
                                <button class="btn btn-primary" onclick="abrirModalProduto()" style="display: inline-flex; align-items: center; gap: 8px;">
                                    <span class="material-symbols-rounded">add_circle</span>
                                    Adicionar Produto
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                atualizarCheckTodos();
                const btnRemover = document.getElementById('btnRemoverProdutos');
                if (btnRemover) {
                    btnRemover.disabled = true;
                }
                return;
            }
            
            // Filtrar produtos se houver busca
            let produtosFiltrados = produtos;
            if (termoBusca) {
                produtosFiltrados = produtos.filter(p => {
                    const codigo = String(p.codigo || '').trim().toLowerCase();
                    const nome = String(p.nome || '').trim().toLowerCase();
                    const categoria = String(p.categoria || '').trim().toLowerCase();
                    return codigo.includes(termoBusca) || nome.includes(termoBusca) || categoria.includes(termoBusca);
                });
            }
            
            // Resetar página se necessário
            const totalPaginas = Math.ceil(produtosFiltrados.length / ITENS_POR_PAGINA_TABELA);
            if (paginaAtualTabela > totalPaginas && totalPaginas > 0) {
                paginaAtualTabela = totalPaginas;
            }
            
            // Calcular itens da página atual
            const inicio = (paginaAtualTabela - 1) * ITENS_POR_PAGINA_TABELA;
            const fim = inicio + ITENS_POR_PAGINA_TABELA;
            const produtosPagina = produtosFiltrados.slice(inicio, fim);
            produtosVisiveis = produtosPagina;
            
            // Usar DocumentFragment para inserção mais eficiente
            const fragment = document.createDocumentFragment();
            
            // Limpar tbody
            tbody.innerHTML = '';
            
            // Renderizar produtos da página atual
            produtosPagina.forEach(p => {
                const tr = document.createElement('tr');
                // Verificar se o produto já está selecionado (para manter seleção entre páginas)
                const estaSelecionado = produtosSelecionados.has(p.id);
                tr.innerHTML = `
                    <td><input type="checkbox" class="check-produto" value="${p.id}" ${estaSelecionado ? 'checked' : ''} onchange="atualizarSelecaoProdutos()"></td>
                    <td><strong>${p.codigo}</strong></td>
                    <td>
                        <div class="foto-produto-container" onclick="abrirUploadFoto(${p.id})" style="width:60px;height:60px;border-radius:8px;background:#f1f5f9;border:2px dashed #cbd5e1;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;transition:all 0.2s;">
                            ${p.foto ? `
                                <img src="${p.foto}" alt="Foto do produto" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">
                                <div class="foto-overlay" style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;border-radius:6px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="color:white;"><path fill="currentColor" fill-rule="evenodd" d="M12 3a1 1 0 0 1 .78.375l4 5a1 1 0 1 1-1.56 1.25L13 6.85V14a1 1 0 1 1-2 0V6.85L8.78 9.626a1 1 0 1 1-1.56-1.25l4-5A1 1 0 0 1 12 3M9 14v-1H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2h-4v1a3 3 0 1 1-6 0m8 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2z" clip-rule="evenodd"/></svg>
                                </div>
                            ` : `
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="color:#94a3b8;"><path fill="currentColor" fill-rule="evenodd" d="M12 3a1 1 0 0 1 .78.375l4 5a1 1 0 1 1-1.56 1.25L13 6.85V14a1 1 0 1 1-2 0V6.85L8.78 9.626a1 1 0 1 1-1.56-1.25l4-5A1 1 0 0 1 12 3M9 14v-1H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2h-4v1a3 3 0 1 1-6 0m8 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2z" clip-rule="evenodd"/></svg>
                            `}
                        </div>
                        <input type="file" id="fotoProduto_${p.id}" accept="image/*" style="display:none;" onchange="uploadFotoProduto(${p.id}, this.files[0])">
                    </td>
                    <td>${p.nome}</td>
                    <td>${p.categoria || '-'}</td>
                    <td style="font-weight:600;color:#059669;">${formatarMoeda(p.preco)}</td>
                    <td>
                        <button class="btn btn-primary" style="padding:8px 14px;margin-right:5px;font-size:13px;display:inline-flex;align-items:center;justify-content:center;gap:4px;min-width:90px;height:36px;box-sizing:border-box;" onclick="editarProduto(${p.id})"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle;flex-shrink:0;"><path fill="currentColor" d="m7 17.013l4.413-.015l9.632-9.54c.378-.378.586-.88.586-1.414s-.208-1.036-.586-1.414l-1.586-1.586c-.756-.756-2.075-.752-2.825-.003L7 12.583zM18.045 4.458l1.589 1.583l-1.597 1.582l-1.586-1.585zM9 13.417l6.03-5.973l1.586 1.586l-6.029 5.971L9 15.006z"/><path fill="currentColor" d="M5 21h14c1.103 0 2-.897 2-2v-8.668l-2 2V19H8.158c-.026 0-.053.01-.079.01c-.033 0-.066-.009-.1-.01H5V5h6.847l2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2"/></svg> Editar</button>
                        <button class="btn" style="padding:8px 14px;background:#dc2626;color:white;font-size:13px;display:inline-flex;align-items:center;justify-content:center;gap:4px;min-width:90px;height:36px;box-sizing:border-box;" onclick="deletarProduto(${p.id})"><span class="material-symbols-rounded" style="font-size:18px;flex-shrink:0;">delete</span> Excluir</button>
                    </td>
                `;
                fragment.appendChild(tr);
            });
            
            // Adicionar controles de paginação se necessário
            if (produtosFiltrados.length > ITENS_POR_PAGINA_TABELA) {
                const trPagina = document.createElement('tr');
                trPagina.innerHTML = `
                    <td colspan="7" style="padding: 20px; background: #f8fafc; border-top: 2px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                            <div style="color: #64748b; font-size: 14px;">
                                Mostrando ${inicio + 1}-${Math.min(fim, produtosFiltrados.length)} de ${produtosFiltrados.length} produtos
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="btn btn-secondary" onclick="irParaPaginaTabela(${paginaAtualTabela - 1})" ${paginaAtualTabela <= 1 ? 'disabled' : ''} style="padding: 8px 16px; font-size: 13px;">
                                    <span class="material-symbols-rounded" style="font-size:18px;">chevron_left</span>
                                </button>
                                <span style="color: #475569; font-weight: 600; min-width: 80px; text-align: center;">
                                    Página ${paginaAtualTabela} de ${totalPaginas}
                                </span>
                                <button class="btn btn-secondary" onclick="irParaPaginaTabela(${paginaAtualTabela + 1})" ${paginaAtualTabela >= totalPaginas ? 'disabled' : ''} style="padding: 8px 16px; font-size: 13px;">
                                    <span class="material-symbols-rounded" style="font-size:18px;">chevron_right</span>
                                </button>
                            </div>
                        </div>
                    </td>
                `;
                fragment.appendChild(trPagina);
            }
            
            // Inserir tudo de uma vez (mais eficiente)
            tbody.appendChild(fragment);
            
            // Usar requestAnimationFrame para eventos de hover (melhor performance)
            requestAnimationFrame(() => {
                // Adicionar event listeners para hover nas fotos (apenas nos visíveis)
                document.querySelectorAll('.foto-produto-container').forEach(container => {
                    const overlay = container.querySelector('.foto-overlay');
                    if (overlay) {
                        container.addEventListener('mouseenter', () => {
                            overlay.style.display = 'flex';
                        }, { passive: true });
                        container.addEventListener('mouseleave', () => {
                            overlay.style.display = 'none';
                        }, { passive: true });
                    }
                });
            });
            
            atualizarCheckTodos();
            // Atualizar estado do botão de remover produtos
            const btnRemover = document.getElementById('btnRemoverProdutos');
            if (btnRemover) {
                btnRemover.disabled = produtosSelecionados.size === 0;
            }
            
            // Adicionar event listeners para hover nas fotos
            document.querySelectorAll('.foto-produto-container').forEach(container => {
                const overlay = container.querySelector('.foto-overlay');
                if (overlay) {
                    container.addEventListener('mouseenter', () => {
                        overlay.style.display = 'flex';
                    });
                    container.addEventListener('mouseleave', () => {
                        overlay.style.display = 'none';
                    });
                }
            });
        }

        // Atualizar seleção de produtos - Mantém seleção entre páginas
        function atualizarSelecaoProdutos() {
            // Atualizar apenas os checkboxes visíveis (não limpar toda a seleção)
            // Isso mantém a seleção quando o usuário navega entre páginas
            document.querySelectorAll('.check-produto').forEach(cb => {
                const produtoId = parseInt(cb.value);
                if (cb.checked) {
                    produtosSelecionados.add(produtoId);
                } else {
                    produtosSelecionados.delete(produtoId);
                }
            });
            
            atualizarCheckTodos();
            
            // Atualizar estado do botão de remover
            const btnRemover = document.getElementById('btnRemoverProdutos');
            if (btnRemover) {
                btnRemover.disabled = produtosSelecionados.size === 0;
                // Atualizar texto do botão com quantidade selecionada
                if (produtosSelecionados.size > 0) {
                    const btnText = btnRemover.querySelector('span') || btnRemover;
                    if (btnText && btnText.textContent) {
                        btnText.textContent = `Remover ${produtosSelecionados.size} Selecionado(s)`;
                    }
                } else {
                    const btnText = btnRemover.querySelector('span') || btnRemover;
                    if (btnText && btnText.innerHTML) {
                        btnRemover.innerHTML = '<span class="material-symbols-rounded">delete_sweep</span> Remover Selecionados';
                    }
                }
            }
        }

        // Selecionar todos os produtos (toggle) - Seleciona TODOS os produtos, não apenas os visíveis
        function selecionarTodosProdutos() {
            const termoBusca = document.getElementById('buscaProdutos')?.value?.trim().toLowerCase() || '';
            
            // Filtrar produtos se houver busca
            let produtosParaSelecionar = produtos;
            if (termoBusca) {
                produtosParaSelecionar = produtos.filter(p => {
                    const codigo = String(p.codigo || '').trim().toLowerCase();
                    const nome = String(p.nome || '').trim().toLowerCase();
                    const categoria = String(p.categoria || '').trim().toLowerCase();
                    return codigo.includes(termoBusca) || nome.includes(termoBusca) || categoria.includes(termoBusca);
                });
            }
            
            // Verificar se todos já estão selecionados
            const todosJaSelecionados = produtosParaSelecionar.length > 0 && 
                produtosParaSelecionar.every(p => produtosSelecionados.has(p.id));
            
            if (todosJaSelecionados) {
                // Desmarcar todos
                produtosParaSelecionar.forEach(p => {
                    produtosSelecionados.delete(p.id);
                });
            } else {
                // Selecionar todos
                produtosParaSelecionar.forEach(p => {
                    produtosSelecionados.add(p.id);
                });
            }
            
            // Atualizar checkboxes visíveis na página atual
            document.querySelectorAll('.check-produto').forEach(cb => {
                const produtoId = parseInt(cb.value);
                cb.checked = produtosSelecionados.has(produtoId);
            });
            
            atualizarCheckTodos();
            
            // Atualizar estado do botão de remover
            const btnRemover = document.getElementById('btnRemoverProdutos');
            if (btnRemover) {
                btnRemover.disabled = produtosSelecionados.size === 0;
            }
        }

        // Toggle todos os produtos - Seleciona TODOS os produtos, não apenas os visíveis
        function toggleTodosProdutos(checked) {
            const termoBusca = document.getElementById('buscaProdutos')?.value?.trim().toLowerCase() || '';
            
            // Filtrar produtos se houver busca
            let produtosParaSelecionar = produtos;
            if (termoBusca) {
                produtosParaSelecionar = produtos.filter(p => {
                    const codigo = String(p.codigo || '').trim().toLowerCase();
                    const nome = String(p.nome || '').trim().toLowerCase();
                    const categoria = String(p.categoria || '').trim().toLowerCase();
                    return codigo.includes(termoBusca) || nome.includes(termoBusca) || categoria.includes(termoBusca);
                });
            }
            
            if (checked) {
                // Selecionar todos os produtos filtrados
                produtosParaSelecionar.forEach(p => {
                    produtosSelecionados.add(p.id);
                });
            } else {
                // Desmarcar todos os produtos filtrados
                produtosParaSelecionar.forEach(p => {
                    produtosSelecionados.delete(p.id);
                });
            }
            
            // Atualizar checkboxes visíveis na página atual
            document.querySelectorAll('.check-produto').forEach(cb => {
                const produtoId = parseInt(cb.value);
                cb.checked = produtosSelecionados.has(produtoId);
            });
            
            atualizarCheckTodos();
            
            // Atualizar estado do botão de remover
            const btnRemover = document.getElementById('btnRemoverProdutos');
            if (btnRemover) {
                btnRemover.disabled = produtosSelecionados.size === 0;
            }
        }

        // Atualizar checkbox "selecionar todos" - Considera TODOS os produtos, não apenas os visíveis
        function atualizarCheckTodos() {
            const checkTodos = document.getElementById('checkTodos');
            if (!checkTodos) return;
            
            const termoBusca = document.getElementById('buscaProdutos')?.value?.trim().toLowerCase() || '';
            
            // Filtrar produtos se houver busca
            let produtosFiltrados = produtos;
            if (termoBusca) {
                produtosFiltrados = produtos.filter(p => {
                    const codigo = String(p.codigo || '').trim().toLowerCase();
                    const nome = String(p.nome || '').trim().toLowerCase();
                    const categoria = String(p.categoria || '').trim().toLowerCase();
                    return codigo.includes(termoBusca) || nome.includes(termoBusca) || categoria.includes(termoBusca);
                });
            }
            
            // Verificar quantos produtos filtrados estão selecionados
            const totalProdutosFiltrados = produtosFiltrados.length;
            const produtosSelecionadosFiltrados = produtosFiltrados.filter(p => produtosSelecionados.has(p.id)).length;
            
            checkTodos.checked = totalProdutosFiltrados > 0 && produtosSelecionadosFiltrados === totalProdutosFiltrados;
            checkTodos.indeterminate = produtosSelecionadosFiltrados > 0 && produtosSelecionadosFiltrados < totalProdutosFiltrados;
        }

        // Remover produtos selecionados - Remove TODOS os selecionados de uma vez
        async function removerProdutosSelecionados() {
            if (produtosSelecionados.size === 0) {
                showToast('Nenhum produto selecionado!', 'warning');
                return;
            }

            const quantidade = produtosSelecionados.size;
            const ok = await showConfirm(`Deseja realmente excluir ${quantidade} produto(s) selecionado(s)? Esta ação não pode ser desfeita.`);
            if (!ok) return;

            // Converter Set para Array para processar
            const idsParaExcluir = Array.from(produtosSelecionados);
            
            // Desabilitar botão durante exclusão
            const btnRemover = document.getElementById('btnRemoverProdutos');
            if (btnRemover) {
                btnRemover.disabled = true;
                btnRemover.textContent = `Excluindo ${quantidade} produto(s)...`;
            }
            
            // Mostrar toast de progresso
            showToast(`Excluindo ${quantidade} produto(s)...`, 'info', 5000);

            let sucessos = 0;
            let erros = 0;

            // Processar exclusões em lote (mais eficiente)
            // Processar em chunks de 50 para não sobrecarregar
            const chunkSize = 50;
            for (let i = 0; i < idsParaExcluir.length; i += chunkSize) {
                const chunk = idsParaExcluir.slice(i, i + chunkSize);
                
                // Processar chunk em paralelo
                const promises = chunk.map(id => 
                    ipcRenderer.invoke('produto-deletar', id)
                        .then(result => ({ id, success: result.success }))
                        .catch(() => ({ id, success: false }))
                );
                
                const results = await Promise.all(promises);
                
                results.forEach(({ id, success }) => {
                    if (success) {
                        produtos = produtos.filter(p => p.id !== id);
                        sucessos++;
                    } else {
                        erros++;
                    }
                });
                
                // Atualizar interface a cada chunk (feedback visual)
                if (btnRemover) {
                    btnRemover.textContent = `Excluindo ${sucessos + erros} de ${quantidade}...`;
                }
            }

            // Limpar seleção
            produtosSelecionados.clear();
            
            // Resetar para primeira página após exclusão
            paginaAtualTabela = 1;
            
            // Recarregar produtos
            carregarProdutos();
            carregarProdutosGrid();

            // Restaurar botão
            if (btnRemover) {
                btnRemover.disabled = true; // Desabilitar se não houver mais selecionados
                btnRemover.innerHTML = '<span class="material-symbols-rounded">delete_sweep</span> Remover Selecionados';
            }

            if (sucessos > 0) {
                showToast(`${sucessos} produto(s) excluído(s) com sucesso!`, 'success', 3000);
            }
            if (erros > 0) {
                showToast(`${erros} produto(s) não puderam ser excluídos`, 'error', 5000);
            }
        }

        function abrirModalProduto() {
            editandoId = null;
            document.getElementById('modalTitle').textContent = 'Adicionar Produto';
            document.getElementById('produtoCodigo').value = '';
            document.getElementById('produtoNome').value = '';
            document.getElementById('produtoCategoria').value = '';
            document.getElementById('produtoPreco').value = '';
            // Usar função otimizada para abrir modal
            abrirModalOtimizado('modalProduto');
        }

        function editarProduto(id) {
            const produto = produtos.find(p => p.id === id);
            editandoId = id;
            document.getElementById('modalTitle').textContent = 'Editar Produto';
            document.getElementById('produtoCodigo').value = produto.codigo;
            document.getElementById('produtoNome').value = produto.nome;
            document.getElementById('produtoCategoria').value = produto.categoria;
            document.getElementById('produtoPreco').value = produto.preco;
            // Usar função otimizada para abrir modal
            abrirModalOtimizado('modalProduto');
        }

        async function salvarProduto(e) {
            e.preventDefault();
            
            const btnSalvar = document.getElementById('btnSalvarProduto');
            const btnLabel = document.getElementById('btnSalvarProdutoLabel');
            const btnSpinner = document.getElementById('btnSalvarProdutoSpinner');

            if (btnSalvar) {
                btnSalvar.disabled = true;
                btnSalvar.classList.add('btn-loading');
            }
            if (btnLabel) btnLabel.style.display = 'none';
            if (btnSpinner) btnSpinner.style.display = 'inline-block';

            const produto = {
                codigo: document.getElementById('produtoCodigo').value,
                nome: document.getElementById('produtoNome').value,
                categoria: document.getElementById('produtoCategoria').value,
                preco: parseFloat(document.getElementById('produtoPreco').value),
                estoque: 0
            };

            let result;
            if (editandoId) {
                result = await ipcRenderer.invoke('produto-atualizar', { id: editandoId, produto });
                if (result.success) {
                    const p = produtos.find(p => p.id === editandoId);
                    Object.assign(p, produto);
                }
            } else {
                result = await ipcRenderer.invoke('produto-criar', produto);
                if (result.success) {
                    produto.id = result.id;
                    produtos.push(produto);
                }
            }

            if (result.success) {
                carregarProdutos();
                carregarProdutosGrid();
                fecharModal();
            } else {
                showToast('Erro ao salvar produto: ' + (result.error || 'Código já existe?'), 'error');
            }

            if (btnSalvar) {
                btnSalvar.disabled = false;
                btnSalvar.classList.remove('btn-loading');
            }
            if (btnLabel) btnLabel.style.display = 'inline-flex';
            if (btnSpinner) btnSpinner.style.display = 'none';
        }

        async function deletarProduto(id) {
            const ok = await showConfirm('Deseja realmente excluir este produto?');
            if (!ok) return;
            const result = await ipcRenderer.invoke('produto-deletar', id);
            if (result.success) {
                produtos = produtos.filter(p => p.id !== id);
                carregarProdutos();
                carregarProdutosGrid();
                showToast('Produto excluído', 'success');
            }
        }

        // Função para abrir o seletor de arquivo de foto
        function abrirUploadFoto(produtoId) {
            const input = document.getElementById(`fotoProduto_${produtoId}`);
            if (input) {
                input.click();
            }
        }

        // Função para fazer upload da foto do produto
        async function uploadFotoProduto(produtoId, file) {
            if (!file) return;
            
            // Validar se é imagem
            if (!file.type.startsWith('image/')) {
                showToast('Por favor, selecione apenas arquivos de imagem!', 'error');
                return;
            }
            
            // Validar tamanho (máximo 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('A imagem deve ter no máximo 5MB!', 'error');
                return;
            }
            
            // Converter para base64
            const reader = new FileReader();
            reader.onload = async function(e) {
                const fotoBase64 = e.target.result;
                
                // Atualizar produto no array local
                const produto = produtos.find(p => p.id === produtoId);
                if (produto) {
                    produto.foto = fotoBase64;
                }
                
                // Salvar no banco de dados
                const result = await ipcRenderer.invoke('produto-atualizar', {
                    id: produtoId,
                    produto: {
                        ...produto,
                        foto: fotoBase64
                    }
                });
                
                if (result.success) {
                    showToast('Foto atualizada com sucesso!', 'success');
                    carregarProdutos();
                } else {
                    showToast('Erro ao salvar foto: ' + (result.error || 'Erro desconhecido'), 'error');
                }
            };
            
            reader.onerror = function() {
                showToast('Erro ao ler o arquivo!', 'error');
            };
            
            reader.readAsDataURL(file);
        }

        // Função auxiliar para detectar índice de coluna por nome
        function encontrarIndiceColuna(headers, termos) {
            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i] || '').trim().toLowerCase();
                for (const termo of termos) {
                    if (header.includes(termo)) return i;
                }
            }
            return -1;
        }

        // Função para encontrar coluna de preço priorizando "venda"
        function encontrarColunaPreco(headers) {
            // Primeiro tenta encontrar exatamente "venda" (match exato tem prioridade)
            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i] || '').trim().toLowerCase();
                // Match exato para "venda" (tem prioridade máxima)
                if (header === 'venda' || header === 'preço venda' || header === 'preco venda') {
                    return i;
                }
            }
            
            // Depois procura por termos que contenham "venda"
            const termosVenda = ['preco venda', 'preço venda', 'price venda', 'valor venda', 'vlr venda', 'preço de venda', 'preco de venda'];
            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i] || '').trim().toLowerCase();
                for (const termo of termosVenda) {
                    if (header.includes(termo)) {
                        return i;
                    }
                }
            }
            
            // Procura apenas por "venda" (pode estar sozinho ou com outras palavras)
            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i] || '').trim().toLowerCase();
                // Verifica se contém "venda" (mas não outros termos de preço para evitar conflito)
                if (header.includes('venda') && !header.includes('compra') && !header.includes('custo')) {
                    return i;
                }
            }
            
            // Se não encontrou com "venda", procura preço normal
            return encontrarIndiceColuna(headers, ['preco', 'preço', 'price', 'valor', 'vlr']);
        }

        // Gerar skeleton loader para tabela de produtos
        function gerarSkeletonProdutos(quantidade = 10) {
            const tbody = document.getElementById('tabelaProdutos');
            if (!tbody) return;
            
            tbody.innerHTML = Array.from({ length: quantidade }, () => `
                <tr class="skeleton-loader">
                    <td><div class="skeleton-cell" style="width:20px;height:20px;margin:0 auto;"></div></td>
                    <td><div class="skeleton-cell skeleton-cell-small"></div></td>
                    <td><div class="skeleton-cell skeleton-cell-photo"></div></td>
                    <td><div class="skeleton-cell skeleton-cell-large"></div></td>
                    <td><div class="skeleton-cell skeleton-cell-medium"></div></td>
                    <td><div class="skeleton-cell skeleton-cell-small"></div></td>
                    <td>
                        <div style="display:flex;gap:5px;">
                            <div class="skeleton-cell" style="width:90px;height:36px;"></div>
                            <div class="skeleton-cell" style="width:90px;height:36px;"></div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Importar produtos de planilha
        async function importarProdutos(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Limpar o input para permitir selecionar o mesmo arquivo novamente
            event.target.value = '';

            try {
                showToast('Processando arquivo...', 'info', 2000);
                
                const fileExtension = file.name.split('.').pop().toLowerCase();
                let dados = [];
                let jsonData = [];

                if (fileExtension === 'csv') {
                    // Processar CSV - suporta vírgula e ponto-e-vírgula
                    const text = await file.text();
                    const lines = text.split('\n').filter(line => line.trim());
                    if (lines.length < 2) {
                        showToast('Arquivo CSV vazio ou sem dados!', 'error');
                        return;
                    }
                    
                    // Detectar delimitador (vírgula ou ponto-e-vírgula)
                    const delimiter = lines[0].includes(';') ? ';' : ',';
                    const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase());
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(delimiter).map(v => v.trim().replace(/^["']|["']$/g, ''));
                        if (values.length === 0 || !values[0]) continue;
                        
                        const produto = {};
                        
                        // Detectar colunas automaticamente
                        const idxCodigo = encontrarIndiceColuna(headers, ['codigo', 'código', 'code', 'id']);
                        const idxNome = encontrarIndiceColuna(headers, ['nome', 'name', 'produto', 'product', 'descricao', 'descrição']);
                        const idxCategoria = encontrarIndiceColuna(headers, ['categoria', 'category', 'categ']);
                        const idxPreco = encontrarColunaPreco(headers);
                        
                        if (idxCodigo >= 0) produto.codigo = String(values[idxCodigo] || '').trim();
                        if (idxNome >= 0) produto.nome = String(values[idxNome] || '').trim();
                        if (idxCategoria >= 0) produto.categoria = String(values[idxCategoria] || '').trim();
                        if (idxPreco >= 0) {
                            const precoStr = String(values[idxPreco] || '0').replace(/[^\d,.-]/g, '').replace(',', '.');
                            // Garantir precisão de 2 casas decimais
                            produto.preco = Math.round(parseFloat(precoStr) * 100) / 100 || 0;
                        }
                        // Estoque sempre será 0 (não importa da planilha)
                        produto.estoque = 0;
                        
                        // Se não encontrou por nome, tenta por posição (A=código, B=nome, C=categoria, D=preço)
                        if (!produto.codigo && values[0]) produto.codigo = String(values[0]).trim();
                        if (!produto.nome && values[1]) produto.nome = String(values[1]).trim();
                        if (!produto.categoria && values[2]) produto.categoria = String(values[2]).trim();
                        if (!produto.preco && values[3]) {
                            const precoStr = String(values[3]).replace(/[^\d,.-]/g, '').replace(',', '.');
                            produto.preco = parseFloat(precoStr) || 0;
                        }
                        
                        if (produto.codigo && produto.nome) {
                            dados.push(produto);
                        }
                    }
                } else {
                    // Processar Excel (xlsx, xls) usando biblioteca local (require)
                    if (!XLSX || typeof XLSX.read !== 'function') {
                        showToast('Erro ao carregar biblioteca XLSX. Reinstale o sistema.', 'error');
                        console.error('XLSX inválido:', XLSX);
                        return;
                    }

                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, { type: 'array', cellDates: false, cellNF: false });

                        if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                            showToast('Erro ao ler a planilha. Verifique se o arquivo está correto.', 'error');
                            return;
                        }

                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                    } catch (xlsxError) {
                        console.error('Erro ao processar Excel:', xlsxError);
                        showToast('Erro ao processar arquivo Excel: ' + xlsxError.message, 'error');
                        return;
                    }

                    if (jsonData.length < 2) {
                        showToast('Planilha vazia ou sem dados!', 'error');
                        return;
                    }
                    
                    // Primeira linha são os cabeçalhos (ou pode não ter cabeçalho)
                    const firstRow = jsonData[0].map(h => String(h || '').trim());
                    const temCabecalho = firstRow.some(h => {
                        const hLower = h.toLowerCase();
                        return hLower.includes('codigo') || hLower.includes('nome') || hLower.includes('preco') || 
                               hLower.includes('código') || hLower.includes('preço') || hLower.includes('estoque') ||
                               hLower.includes('venda') || hLower.includes('categoria') || hLower.includes('product');
                    });
                    
                    let startRow = temCabecalho ? 1 : 0;
                    const headers = temCabecalho ? firstRow.map(h => String(h || '').trim().toLowerCase()) : [];
                    
                    // Detectar índices das colunas
                    const idxCodigo = temCabecalho ? encontrarIndiceColuna(headers, ['codigo', 'código', 'code', 'id']) : 0;
                    const idxNome = temCabecalho ? encontrarIndiceColuna(headers, ['nome', 'name', 'produto', 'product', 'descricao', 'descrição']) : 1;
                    const idxCategoria = temCabecalho ? encontrarIndiceColuna(headers, ['categoria', 'category', 'categ']) : 2;
                    const idxPreco = temCabecalho ? encontrarColunaPreco(headers) : 3;
                    
                    for (let i = startRow; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;
                        
                        // Pular linhas vazias
                        const firstCell = String(row[0] || '').trim();
                        if (!firstCell) continue;
                        
                        const produto = {};
                        
                        // Extrair valores das colunas detectadas
                        if (idxCodigo >= 0 && row[idxCodigo] !== undefined && row[idxCodigo] !== null && row[idxCodigo] !== '') {
                            produto.codigo = String(row[idxCodigo]).trim();
                        }
                        if (idxNome >= 0 && row[idxNome] !== undefined && row[idxNome] !== null && row[idxNome] !== '') {
                            produto.nome = String(row[idxNome]).trim();
                        }
                        if (idxCategoria >= 0 && row[idxCategoria] !== undefined && row[idxCategoria] !== null && row[idxCategoria] !== '') {
                            produto.categoria = String(row[idxCategoria]).trim();
                        }
                        if (idxPreco >= 0 && row[idxPreco] !== undefined && row[idxPreco] !== null && row[idxPreco] !== '') {
                            const precoValue = row[idxPreco];
                            let precoStr = String(precoValue);
                            // Remover formatação de moeda e converter vírgula para ponto
                            precoStr = precoStr.replace(/[^\d,.-]/g, '').replace(',', '.');
                            // Garantir precisão de 2 casas decimais
                            produto.preco = Math.round(parseFloat(precoStr) * 100) / 100 || 0;
                        }
                        // Estoque sempre será 0 (não importa da planilha)
                        produto.estoque = 0;
                        
                        // Se não encontrou por nome e não tem cabeçalho, usa posição padrão
                        if (!produto.codigo && row[0]) produto.codigo = String(row[0]).trim();
                        if (!produto.nome && row[1]) produto.nome = String(row[1]).trim();
                        if (!produto.categoria && row[2]) produto.categoria = String(row[2]).trim();
                        if (produto.preco === undefined && row[3]) {
                            const precoStr = String(row[3]).replace(/[^\d,.-]/g, '').replace(',', '.');
                            produto.preco = parseFloat(precoStr) || 0;
                        }
                        
                        if (produto.codigo && produto.nome) {
                            dados.push(produto);
                        }
                    }
                }

                if (dados.length === 0) {
                    showToast('Nenhum produto válido encontrado na planilha! Verifique se há colunas: Código, Nome, e Venda (ou Preço/Preço Venda)', 'warning', 5000);
                    return;
                }

                // Validar e adicionar produtos (processamento otimizado em lotes para planilhas grandes)
                let sucessos = 0;
                let erros = 0;
                const errosDetalhes = [];
                
                // Otimizar: criar Set de códigos existentes para busca O(1) em vez de O(n)
                const codigosExistentes = new Set(produtos.map(p => String(p.codigo || '').trim()));
                
                // Normalizar e validar dados primeiro (preparação rápida)
                const dadosValidados = [];
                for (const produto of dados) {
                    if (!produto.codigo || !produto.nome) {
                        erros++;
                        continue;
                    }
                    
                    // Normalizar valores
                    produto.codigo = String(produto.codigo).trim();
                    produto.nome = String(produto.nome).trim();
                    produto.categoria = produto.categoria ? String(produto.categoria).trim() : '';
                    
                    // Garantir que o preço seja um número válido com 2 casas decimais
                    if (produto.preco && produto.preco > 0) {
                        produto.preco = Math.round(produto.preco * 100) / 100;
                    } else {
                        produto.preco = 0;
                    }
                    
                    produto.estoque = 0;
                    
                    // Verificar duplicata usando Set (muito mais rápido)
                    if (codigosExistentes.has(produto.codigo)) {
                        erros++;
                        errosDetalhes.push(`Código ${produto.codigo} já existe`);
                        continue; // Não adiciona produtos já cadastrados
                    }
                    
                    dadosValidados.push(produto);
                    codigosExistentes.add(produto.codigo); // Prevenir duplicatas dentro da importação
                }
                
                // Se não houver produtos novos para importar, apenas mostrar mensagem
                if (dadosValidados.length === 0) {
                    if (erros > 0) {
                        showToast('Todos os produtos da planilha já estão cadastrados no sistema!', 'warning', 5000);
                    } else {
                        showToast('Nenhum produto válido para importar!', 'warning', 5000);
                    }
                    return;
                }
                
                // Mostrar skeleton loader APENAS para produtos novos (não duplicados)
                gerarSkeletonProdutos(Math.min(15, dadosValidados.length));
                
                // Processar em lotes para não bloquear a UI (50 produtos por lote)
                const TAMANHO_LOTE = 50;
                const totalProdutos = dadosValidados.length;
                showToast(`Importando ${totalProdutos} produto(s) novo(s) em lotes...`, 'info', 3000);
                
                // Atualizar skeleton com progresso
                let produtosProcessados = 0;
                
                for (let i = 0; i < dadosValidados.length; i += TAMANHO_LOTE) {
                    const lote = dadosValidados.slice(i, i + TAMANHO_LOTE);
                    const indiceLote = Math.floor(i / TAMANHO_LOTE) + 1;
                    const totalLotes = Math.ceil(dadosValidados.length / TAMANHO_LOTE);
                    
                    // Processar lote atual
                    for (const produto of lote) {
                        try {
                            const result = await ipcRenderer.invoke('produto-criar', produto);
                            
                            if (result.success) {
                                produto.id = result.id;
                                produtos.push(produto);
                                sucessos++;
                            } else {
                                erros++;
                                errosDetalhes.push(`${produto.codigo}: ${result.error || 'Erro desconhecido'}`);
                            }
                            
                            produtosProcessados++;
                            
                            // Atualizar skeleton progressivamente (a cada 10 produtos)
                            // Não atualizar no último produto para evitar flicker
                            if (produtosProcessados % 10 === 0 && produtosProcessados < totalProdutos) {
                                const progresso = Math.min(Math.floor((produtosProcessados / totalProdutos) * 15), 15);
                                const linhasRestantes = Math.max(15 - progresso, 3);
                                gerarSkeletonProdutos(linhasRestantes);
                            }
                        } catch (error) {
                            erros++;
                            errosDetalhes.push(`${produto.codigo}: Erro ao criar`);
                            produtosProcessados++;
                        }
                    }
                    
                    // Liberar UI entre lotes (permite que o navegador atualize)
                    if (i + TAMANHO_LOTE < dadosValidados.length) {
                        await new Promise(resolve => setTimeout(resolve, 10)); // 10ms de pausa entre lotes
                    }
                }

                // Recarregar produtos do banco de dados para garantir que todos estejam atualizados
                produtos = await ipcRenderer.invoke('produtos-listar');
                
                // Atualizar interface - isso remove o skeleton e mostra os produtos reais
                carregarProdutos();
                carregarProdutosGrid();
                
                // Pequeno delay para garantir que a interface seja renderizada antes do toast
                await new Promise(resolve => setTimeout(resolve, 100));

                // Mostrar resultado com detalhes dos preços
                if (sucessos > 0) {
                    // Mostrar exemplo de produto importado com preço
                    const primeiroProduto = dados.find(d => produtos.find(p => p.codigo === d.codigo));
                    let mensagem = `${sucessos} produto(s) importado(s) com sucesso!`;
                    if (primeiroProduto && primeiroProduto.preco > 0) {
                        mensagem += ` Exemplo: ${primeiroProduto.nome} - ${formatarMoeda(primeiroProduto.preco)}`;
                    }
                    showToast(mensagem, 'success', 5000);
                    
                }
                
                if (erros > 0) {
                    const mensagemErro = errosDetalhes.length > 0 
                        ? `${erros} erro(s). Primeiros: ${errosDetalhes.slice(0, 3).join(', ')}`
                        : `${erros} produto(s) não puderam ser importados`;
                    showToast(mensagemErro, 'warning', 5000);
                }

            } catch (error) {
                console.error('Erro ao importar:', error);
                showToast('Erro ao processar arquivo: ' + error.message, 'error');
                // Remover skeleton em caso de erro
                carregarProdutos();
            }
        }

        function fecharModal() {
            fecharModalOtimizado('modalProduto');
        }

        // Buscar produtos na tabela - Otimizado com debounce e paginação
        const buscarProdutosTabelaOtimizado = debounce(function(e) {
            paginaAtualTabela = 1; // Resetar para primeira página ao buscar
            carregarProdutos(); // Usa a busca integrada na função carregarProdutos
        }, 300);
        
        function buscarProdutosTabela(e) {
            buscarProdutosTabelaOtimizado(e);
        }
        
        // Filtrar histórico de vendas
        function filtrarHistorico() {
            const filtroCliente = document.getElementById('filtroClienteHistorico').value.trim().toLowerCase();
            const filtroPagamento = document.getElementById('filtroPagamentoHistorico').value;
            const filtroProduto = document.getElementById('filtroProdutoHistorico').value.trim().toLowerCase();
            const filtroData = document.getElementById('filtroDataHistorico').value;

            if (!vendas || vendas.length === 0) {
                vendasFiltradasHistorico = [];
                atualizarTabelaHistorico();
                return;
            }

            vendasFiltradasHistorico = vendas.filter(v => {
                // Filtro por cliente
                if (filtroCliente) {
                    let nomeCliente = '';
                    if (v.cliente_nome && v.cliente_nome.trim() !== '') {
                        nomeCliente = v.cliente_nome.toLowerCase();
                    } else if (v.cliente_id && clientes && clientes.length > 0) {
                        const cliente = clientes.find(c => c.id === parseInt(v.cliente_id));
                        if (cliente && cliente.nome) {
                            nomeCliente = cliente.nome.toLowerCase();
                        }
                    }
                    if (!nomeCliente.includes(filtroCliente)) {
                        return false;
                    }
                }

                // Filtro por forma de pagamento
                if (filtroPagamento) {
                    const formaPagamento = (v.formaPagamento || v.forma_pagamento || '').trim();
                    if (formaPagamento !== filtroPagamento) {
                        return false;
                    }
                }

                // Filtro por produto/item
                if (filtroProduto) {
                    if (!v.itens || v.itens.length === 0) {
                        return false;
                    }
                    const temProduto = v.itens.some(item => {
                        const nomeProduto = (item.nome || '').toLowerCase();
                        return nomeProduto.includes(filtroProduto);
                    });
                    if (!temProduto) {
                        return false;
                    }
                }

                // Filtro por data
                if (filtroData) {
                    if (!v.data) {
                        return false;
                    }
                    const dataVenda = new Date(v.data);
                    const dataFiltro = new Date(filtroData);
                    const dataVendaStr = dataVenda.toISOString().split('T')[0];
                    const dataFiltroStr = dataFiltro.toISOString().split('T')[0];
                    if (dataVendaStr !== dataFiltroStr) {
                        return false;
                    }
                }

                return true;
            });

            atualizarTabelaHistorico();
        }

        // Limpar filtros do histórico
        function limparFiltrosHistorico() {
            document.getElementById('filtroClienteHistorico').value = '';
            document.getElementById('filtroPagamentoHistorico').value = '';
            document.getElementById('filtroProdutoHistorico').value = '';
            document.getElementById('filtroDataHistorico').value = '';
            vendasFiltradasHistorico = [];
            carregarHistorico();
        }
        
        // Buscar clientes
        function buscarClientes(e) {
            const termo = document.getElementById('buscaClientes').value.trim().toLowerCase();
            const linhas = document.querySelectorAll('#tabelaClientes tr');
            
            linhas.forEach(linha => {
                const texto = linha.textContent.toLowerCase();
                if (termo === '' || texto.includes(termo)) {
                    linha.style.display = '';
                } else {
                    linha.style.display = 'none';
                }
            });
        }
        
        // Histórico
        async function carregarHistorico() {
            if (!vendas || vendas.length === 0) {
                vendasFiltradasHistorico = [];
                atualizarTabelaHistorico();
                return;
            }
            
            // Garantir que lista de clientes esteja carregada para buscar nomes
            if (!clientes || clientes.length === 0) {
                try {
                    clientes = await ipcRenderer.invoke('clientes-listar');
                } catch (error) {
                    console.error('Erro ao carregar clientes:', error);
                }
            }
            
            // Inicializar vendas filtradas com todas as vendas
            vendasFiltradasHistorico = [...vendas].reverse();
            atualizarTabelaHistorico();
        }

        // Atualizar tabela do histórico
        function atualizarTabelaHistorico() {
            const tbody = document.getElementById('tabelaHistorico');
            
            if (!vendasFiltradasHistorico || vendasFiltradasHistorico.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 60px 20px;">
                            <div style="text-align: center; color: #64748b;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" style="display: block; margin: 0 auto 16px; opacity: 0.5;">
                                    <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2M9 17H7v-7h2v7m4 0h-2V7h2v10m4 0h-2v-4h2v4"/>
                                </svg>
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #475569;">Nenhuma venda encontrada</h3>
                                <p style="font-size: 14px; margin-bottom: 24px;">Realize vendas na aba "Vendas" para visualizar o histórico aqui</p>
                                <button class="btn btn-primary" onclick="mudaTab('vendas')" style="display: inline-flex; align-items: center; gap: 8px;">
                                    <span class="material-symbols-rounded">shopping_cart</span>
                                    Ir para Vendas
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                atualizarCheckTodosHistorico();
                const btnRemover = document.getElementById('btnRemoverHistorico');
                if (btnRemover) {
                    btnRemover.disabled = true;
                }
                return;
            }
            
            // Garantir que todas as vendas tenham itens (pode ser array vazio)
            const vendasComItens = vendasFiltradasHistorico.map(v => ({
                ...v,
                itens: v.itens || []
            }));
            
            tbody.innerHTML = vendasComItens.map(v => {
                const numItens = v.itens ? v.itens.length : 0;
                const dataFormatada = v.data ? new Date(v.data).toLocaleString('pt-BR') : 'Data não disponível';
                const formaPagamento = v.formaPagamento || v.forma_pagamento || 'Não informado';
                
                // Obter nome do cliente
                let nomeCliente = 'Cliente não informado';
                // Verificar se já tem cliente_nome (pode ser null, string vazia ou valor válido)
                if (v.cliente_nome && v.cliente_nome.trim() !== '') {
                    nomeCliente = v.cliente_nome;
                } else if (v.cliente_id) {
                    // Se tem cliente_id mas não tem nome, buscar na lista de clientes
                    if (clientes && clientes.length > 0) {
                        const clienteId = parseInt(v.cliente_id);
                        const cliente = clientes.find(c => c.id === clienteId);
                        if (cliente && cliente.nome) {
                            nomeCliente = cliente.nome;
                        }
                    }
                }
                
                // Formatar nomes dos produtos
                let produtosTexto = '';
                if (v.itens && v.itens.length > 0) {
                    const nomesProdutos = v.itens.map(item => {
                        const nome = item.nome || 'Produto sem nome';
                        const quantidade = item.quantidade || 1;
                        // Se quantidade for maior que 1, mostrar quantidade também
                        return quantidade > 1 ? `${nome} (${quantidade}x)` : nome;
                    });
                    
                    // Limitar a exibição para não ficar muito longo
                    if (nomesProdutos.length <= 2) {
                        produtosTexto = nomesProdutos.join(', ');
                    } else if (nomesProdutos.length <= 4) {
                        // Mostrar todos com quebra de linha
                        produtosTexto = nomesProdutos.join(', ');
                    } else {
                        // Mostrar os 3 primeiros e indicar quantos mais
                        const restantes = nomesProdutos.length - 3;
                        produtosTexto = nomesProdutos.slice(0, 3).join(', ') + ` <span style="color:#64748b;font-weight:500;">+${restantes} mais</span>`;
                    }
                } else {
                    produtosTexto = '<span style="color:#94a3b8;font-style:italic;">Nenhum item registrado</span>';
                }
                
                return `
                <tr>
                    <td><input type="checkbox" class="check-venda" value="${v.id}" onchange="atualizarSelecaoHistorico()"></td>
                    <td><strong>#${v.id}</strong></td>
                    <td>${dataFormatada}</td>
                    <td style="max-width:400px;">
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span class="material-symbols-rounded" style="font-size:18px;color:#64748b;flex-shrink:0;">shopping_bag</span>
                            <span style="font-size:13px;color:#1e293b;line-height:1.4;word-wrap:break-word;">${produtosTexto}</span>
                        </div>
                    </td>
                    <td style="font-weight:700;color:#059669;">${formatarMoeda(v.total || 0)}</td>
                    <td><span class="badge badge-success">${formaPagamento}</span></td>
                    <td style="${formaPagamento === 'A Prazo' ? 'font-weight:600;color:#059669;' : 'color:#64748b;'}">${nomeCliente}</td>
                    <td><button class="btn btn-primary" style="padding:8px 14px;font-size:13px;" onclick="verDetalhesVenda(${v.id})"><span class="material-symbols-rounded">visibility</span> Ver Detalhes</button></td>
                </tr>
            `;
            }).join('');
            atualizarCheckTodosHistorico();
            // Atualizar estado do botão de remover histórico
            const btnRemover = document.getElementById('btnRemoverHistorico');
            if (btnRemover) {
                btnRemover.disabled = vendasSelecionadas.size === 0;
            }
        }

        async function verDetalhesVenda(id) {
            let venda = vendas.find(v => v.id === id);
            
            // Se a venda não tiver itens carregados, buscar do banco
            if (!venda || !venda.itens || venda.itens.length === 0) {
                venda = await ipcRenderer.invoke('venda-buscar', id);
                if (!venda) {
                    showToast('Venda não encontrada!', 'error');
                    return;
                }
            }
            
            const itens = venda.itens || [];
            const formaPagamento = venda.formaPagamento || venda.forma_pagamento || 'Não informado';
            const desconto = venda.desconto || 0;
            const subtotal = (itens.reduce((sum, item) => {
                const preco = item.preco_unitario || item.preco || 0;
                const qtd = item.quantidade || 1;
                return sum + (preco * qtd);
            }, 0));
            const total = venda.total || 0;
            
            // Obter nome do cliente
            let nomeCliente = 'Cliente não informado';
            let clienteId = null;
            if (venda.cliente_nome && venda.cliente_nome.trim() !== '') {
                nomeCliente = venda.cliente_nome;
                clienteId = venda.cliente_id;
            } else if (venda.cliente_id) {
                clienteId = venda.cliente_id;
                if (clientes && clientes.length > 0) {
                    const cliente = clientes.find(c => c.id === parseInt(venda.cliente_id));
                    if (cliente && cliente.nome) {
                        nomeCliente = cliente.nome;
                    }
                } else {
                    try {
                        const cliente = await ipcRenderer.invoke('cliente-buscar', venda.cliente_id);
                        if (cliente && cliente.nome) {
                            nomeCliente = cliente.nome;
                        }
                    } catch (error) {
                        console.error('Erro ao buscar cliente:', error);
                    }
                }
            }
            
            // Verificar status de pagamento para vendas A Prazo
            let statusPagamento = null;
            if (formaPagamento === 'A Prazo' && clienteId) {
                try {
                    const cliente = await ipcRenderer.invoke('cliente-buscar', clienteId);
                    if (cliente) {
                        const valorClienteAtual = parseFloat(cliente.status) || 0;
                        
                        // Buscar todas as vendas a prazo deste cliente, ordenadas por data (mais antigas primeiro)
                        const vendasClientePrazo = vendas
                            .filter(v => 
                                v.cliente_id === clienteId && 
                                (v.formaPagamento === 'A Prazo' || v.forma_pagamento === 'A Prazo')
                            )
                            .sort((a, b) => new Date(a.data) - new Date(b.data));
                        
                        const totalTodasVendasPrazo = vendasClientePrazo.reduce((sum, v) => sum + (parseFloat(v.total) || 0), 0);
                        
                        // Se o valor atual do cliente é 0, todas as vendas foram pagas
                        if (valorClienteAtual === 0) {
                            statusPagamento = 'Pago';
                        } else if (valorClienteAtual >= totalTodasVendasPrazo) {
                            // Se o valor atual é maior ou igual ao total, nenhuma venda foi paga
                            statusPagamento = 'Não Pago';
                        } else {
                            // Calcular quanto já foi pago (diferença entre total de vendas e valor atual)
                            const valorPago = totalTodasVendasPrazo - valorClienteAtual;
                            
                            // Calcular quanto falta pagar das vendas mais antigas até chegar nesta venda
                            let acumuladoAteEstaVenda = 0;
                            for (const v of vendasClientePrazo) {
                                acumuladoAteEstaVenda += parseFloat(v.total) || 0;
                                if (v.id === id) break;
                            }
                            
                            // Se já foi pago mais que o acumulado até esta venda (incluindo ela), esta venda está paga
                            if (valorPago >= acumuladoAteEstaVenda) {
                                statusPagamento = 'Pago';
                            } else {
                                statusPagamento = 'Não Pago';
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erro ao verificar status de pagamento:', error);
                }
            }
            
            // Formatar data
            const dataFormatada = venda.data ? new Date(venda.data).toLocaleString('pt-BR') : 'Data não disponível';
            
            // Montar HTML do modal
            let itensHTML = '';
            if (itens.length === 0) {
                itensHTML = '<div style="padding:16px;text-align:center;color:#94a3b8;font-style:italic;">Nenhum item encontrado</div>';
            } else {
                itensHTML = itens.map(item => {
                    const nome = item.nome || 'Produto sem nome';
                    const quantidade = item.quantidade || 1;
                    const precoUnit = item.preco_unitario || item.preco || 0;
                    const subtotalItem = precoUnit * quantidade;
                    return `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f1f5f9;">
                            <div style="flex:1;">
                                <div style="font-weight:600;color:#1e293b;margin-bottom:4px;">${nome}</div>
                                <div style="font-size:13px;color:#64748b;">${quantidade}x ${formatarMoeda(precoUnit)}</div>
                            </div>
                            <div style="font-weight:700;color:#059669;font-size:16px;">${formatarMoeda(subtotalItem)}</div>
                        </div>
                    `;
                }).join('');
            }
            
            const modal = document.getElementById('modalDetalhesVenda');
            const titleEl = document.getElementById('modalDetalhesVendaTitle');
            const contentEl = document.getElementById('modalDetalhesVendaContent');
            
            titleEl.textContent = `VENDA #${venda.id}`;
            contentEl.innerHTML = `
                <div style="margin-bottom:20px;">
                    <div style="font-size:13px;color:#64748b;margin-bottom:8px;">Data/Hora</div>
                    <div style="font-size:15px;color:#1e293b;font-weight:600;">${dataFormatada}</div>
                </div>
                
                <div style="margin-bottom:24px;">
                    <div style="font-size:13px;color:#64748b;margin-bottom:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Itens da Venda</div>
                    <div style="background:#f8fafc;border-radius:8px;padding:16px;max-height:300px;overflow-y:auto;">
                        ${itensHTML}
                    </div>
                </div>
                
                <div style="background:#f8fafc;border-radius:8px;padding:20px;margin-bottom:20px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                        <span style="color:#64748b;font-size:14px;">Subtotal:</span>
                        <span style="font-weight:600;color:#1e293b;font-size:15px;">${formatarMoeda(subtotal)}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                        <span style="color:#64748b;font-size:14px;">Desconto:</span>
                        <span style="font-weight:600;color:#64748b;font-size:15px;">${formatarMoeda(desconto)}</span>
                    </div>
                    <div style="border-top:2px solid #e2e8f0;padding-top:12px;margin-top:12px;display:flex;justify-content:space-between;">
                        <span style="color:#1e293b;font-size:16px;font-weight:700;">TOTAL:</span>
                        <span style="font-weight:700;color:#059669;font-size:20px;">${formatarMoeda(total)}</span>
                    </div>
                </div>
                
                <div style="margin-bottom:20px;">
                    <div style="font-size:13px;color:#64748b;margin-bottom:8px;">Forma de Pagamento</div>
                    <div style="display:inline-block;">
                        <span class="badge badge-success" style="font-size:14px;padding:8px 14px;">${formaPagamento}</span>
                        ${statusPagamento ? `
                            <span class="badge ${statusPagamento === 'Pago' ? 'badge-success' : 'badge-warning'}" style="font-size:14px;padding:8px 14px;margin-left:8px;">
                                ${statusPagamento}
                            </span>
                        ` : ''}
                    </div>
                </div>
                
                ${clienteId ? `
                <div style="margin-bottom:20px;">
                    <div style="font-size:13px;color:#64748b;margin-bottom:8px;">Cliente</div>
                    <div style="font-size:15px;color:#1e293b;font-weight:600;">${nomeCliente}</div>
                </div>
                ` : ''}
            `;
            
            modal.classList.add('active');
        }

        // Fechar modal de detalhes da venda
        function fecharModalDetalhesVenda() {
            document.getElementById('modalDetalhesVenda').classList.remove('active');
        }
        
        // Carregar Conta
        function carregarConta() {
            if (usuarioLogado) {
                document.getElementById('contaNome').textContent = usuarioLogado.nome;
                document.getElementById('contaEmail').textContent = usuarioLogado.email;
                document.getElementById('contaInfoNome').textContent = usuarioLogado.nome;
                document.getElementById('contaInfoEmail').textContent = usuarioLogado.email;
                
                // Nome do Comércio - mostrar "Não informado" se não houver
                const nomeComercio = usuarioLogado.nome_comercio && usuarioLogado.nome_comercio.trim() 
                    ? usuarioLogado.nome_comercio 
                    : 'Não informado';
                const contaInfoNomeComercio = document.getElementById('contaInfoNomeComercio');
                contaInfoNomeComercio.textContent = nomeComercio;
                // Aplicar estilo cinza se for "Não informado"
                if (nomeComercio === 'Não informado') {
                    contaInfoNomeComercio.style.color = '#94a3b8';
                    contaInfoNomeComercio.style.fontStyle = 'italic';
                } else {
                    contaInfoNomeComercio.style.color = '#1e293b';
                    contaInfoNomeComercio.style.fontStyle = 'normal';
                }

                // Atualizar foto
                const fotoDisplay = document.getElementById('contaFotoImgDisplay');
                const fotoIconDisplay = document.getElementById('contaFotoIconDisplay');
                const btnRemoverFoto = document.getElementById('btnRemoverFotoConta');
                if (usuarioLogado.foto) {
                    fotoDisplay.src = usuarioLogado.foto;
                    fotoDisplay.style.display = 'block';
                    fotoIconDisplay.style.display = 'none';
                    // Mostrar botão de remover foto
                    if (btnRemoverFoto) btnRemoverFoto.style.display = 'flex';
                } else {
                    fotoDisplay.style.display = 'none';
                    fotoIconDisplay.style.display = 'block';
                    // Esconder botão de remover foto
                    if (btnRemoverFoto) btnRemoverFoto.style.display = 'none';
                }
            }
        }

        // Remover foto de perfil
        async function removerFotoPerfil() {
            if (!usuarioLogado) return;
            
            // Confirmar remoção
            if (!confirm('Deseja realmente remover a foto de perfil?')) {
                return;
            }

            try {
                // Atualizar conta removendo a foto
                const dados = {
                    id: usuarioLogado.id,
                    nome: usuarioLogado.nome,
                    email: usuarioLogado.email,
                    nome_comercio: usuarioLogado.nome_comercio || '',
                    foto: null // Remover foto
                };

                const result = await ipcRenderer.invoke('usuario-atualizar', dados);

                if (result.success) {
                    // Atualizar usuarioLogado local
                    usuarioLogado = await ipcRenderer.invoke('get-usuario-logado');

                    // Atualizar interface
                    carregarConta();
                    atualizarNomeCabecalho();

                    showToast('Foto removida com sucesso!', 'success');
                } else {
                    showToast('Erro ao remover foto: ' + (result.error || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                console.error('Erro ao remover foto:', error);
                showToast('Erro ao remover foto: ' + error.message, 'error');
            }
        }

        // Função para atualizar nome no cabeçalho
        function atualizarNomeCabecalho() {
            if (!usuarioLogado) return;
            const nomeExibir = usuarioLogado.nome_comercio && usuarioLogado.nome_comercio.trim() !== ''
                ? usuarioLogado.nome_comercio
                : usuarioLogado.nome;
            document.getElementById('usuarioLogadoNome').textContent = 'Olá, ' + nomeExibir;

            // Atualizar avatar
            const avatarIcon = document.getElementById('usuarioLogadoAvatarIcon');
            const avatarImg = document.getElementById('usuarioLogadoAvatarImg');
            
            if (usuarioLogado.foto) {
                avatarImg.src = usuarioLogado.foto;
                avatarImg.style.display = 'block';
                avatarIcon.style.display = 'none';
            } else {
                avatarImg.style.display = 'none';
                avatarIcon.style.display = 'block';
            }

            // Verificar se deve mostrar banner
            verificarBannerNomeComercio();
        }

        // Verificar se deve mostrar banner de nome do comércio
        function verificarBannerNomeComercio() {
            if (!usuarioLogado) {
                // Esconder banner se não houver usuário logado
                const banner = document.getElementById('bannerNomeComercio');
                if (banner) banner.style.display = 'none';
                return;
            }

            const banner = document.getElementById('bannerNomeComercio');
            if (!banner) {
                console.warn('Banner de nome do comércio não encontrado no DOM');
                return;
            }

            // Verificar se o banner foi fechado anteriormente
            const bannerFechado = localStorage.getItem('bannerNomeComercioFechado');
            if (bannerFechado === 'true') {
                banner.style.display = 'none';
                return;
            }

            // Mostrar banner se não tiver nome do comércio
            const temNomeComercio = usuarioLogado.nome_comercio && usuarioLogado.nome_comercio.trim() !== '';
            if (!temNomeComercio) {
                banner.style.display = 'flex'; // Usar flex para manter o layout do banner
            } else {
                banner.style.display = 'none';
            }
        }

        // Fechar banner de nome do comércio
        function fecharBannerNomeComercio() {
            const banner = document.getElementById('bannerNomeComercio');
            if (banner) {
                banner.style.display = 'none';
                localStorage.setItem('bannerNomeComercioFechado', 'true');
            }
        }

        // Abrir modal de editar conta - Otimizado
        function abrirModalEditarConta() {
            if (!usuarioLogado) return;
            
            document.getElementById('contaEditarNome').value = usuarioLogado.nome;
            document.getElementById('contaEditarNomeComercio').value = usuarioLogado.nome_comercio || '';
            document.getElementById('contaEditarEmail').value = usuarioLogado.email;
            document.getElementById('contaEditarSenha').value = '';
            document.getElementById('contaEditarSenhaConfirm').value = '';
            
            // Resetar preview da foto
            const fotoPreview = document.getElementById('contaFotoPreview');
            const fotoImg = document.getElementById('contaFotoImg');
            const fotoIcon = document.getElementById('contaFotoIcon');
            const fotoInput = document.getElementById('contaFotoInput');
            
            if (usuarioLogado.foto) {
                fotoImg.src = usuarioLogado.foto;
                fotoImg.style.display = 'block';
                fotoIcon.style.display = 'none';
            } else {
                fotoImg.style.display = 'none';
                fotoIcon.style.display = 'block';
            }
            
            fotoInput.value = '';
            // Usar função otimizada para abrir modal
            abrirModalOtimizado('modalEditarConta');
        }

        // Fechar modal de editar conta - Otimizado
        function fecharModalEditarConta() {
            fecharModalOtimizado('modalEditarConta');
        }

        // Preview da foto ao selecionar
        function previewFotoConta(file) {
            if (!file) return;
            
            // Validar tipo de arquivo
            if (!file.type.startsWith('image/')) {
                showToast('Por favor, selecione uma imagem!', 'error');
                return;
            }
            
            // Validar tamanho (máximo 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('A imagem deve ter no máximo 5MB!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const fotoImg = document.getElementById('contaFotoImg');
                const fotoIcon = document.getElementById('contaFotoIcon');
                fotoImg.src = e.target.result;
                fotoImg.style.display = 'block';
                fotoIcon.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // Salvar conta
        async function salvarConta(e) {
            e.preventDefault();
            
            const btnSalvar = document.getElementById('btnSalvarConta');
            const btnLabel = document.getElementById('btnSalvarContaLabel');
            const btnSpinner = document.getElementById('btnSalvarContaSpinner');
            
            // Desabilitar botão e mostrar spinner
            btnSalvar.disabled = true;
            btnLabel.style.display = 'none';
            btnSpinner.style.display = 'inline-block';
            
            try {
                const nome = document.getElementById('contaEditarNome').value.trim();
                const nomeComercio = document.getElementById('contaEditarNomeComercio').value.trim();
                const email = document.getElementById('contaEditarEmail').value.trim();
                const senha = document.getElementById('contaEditarSenha').value;
                const senhaConfirm = document.getElementById('contaEditarSenhaConfirm').value;
                
                // Validar senha se fornecida
                if (senha) {
                    if (senha.length < 6) {
                        showToast('A senha deve ter no mínimo 6 caracteres!', 'error');
                        btnSalvar.disabled = false;
                        btnLabel.style.display = 'inline-flex';
                        btnSpinner.style.display = 'none';
                        return;
                    }
                    if (senha !== senhaConfirm) {
                        showToast('As senhas não coincidem!', 'error');
                        btnSalvar.disabled = false;
                        btnLabel.style.display = 'inline-flex';
                        btnSpinner.style.display = 'none';
                        return;
                    }
                }
                
                // Obter foto se foi selecionada
                let foto = usuarioLogado.foto || null;
                const fotoInput = document.getElementById('contaFotoInput');
                if (fotoInput.files && fotoInput.files[0]) {
                    const file = fotoInput.files[0];
                    // Converter para base64
                    const reader = new FileReader();
                    foto = await new Promise((resolve, reject) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                }
                
                // Preparar dados para atualização
                const dados = {
                    nome,
                    nome_comercio: nomeComercio || null,
                    email,
                    foto
                };
                
                if (senha) {
                    dados.senha = senha;
                }
                
                // Atualizar no banco
                const result = await ipcRenderer.invoke('usuario-atualizar', dados);
                
                if (result.success) {
                    // Atualizar usuarioLogado local
                    usuarioLogado = await ipcRenderer.invoke('get-usuario-logado');
                    
                    // Atualizar interface
                    carregarConta();
                    atualizarNomeCabecalho();

                    showToast('Conta atualizada com sucesso!', 'success');
                    fecharModalEditarConta();
                } else {
                    showToast('Erro ao atualizar conta: ' + (result.error || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar conta:', error);
                showToast('Erro ao salvar conta: ' + error.message, 'error');
            } finally {
                // Reabilitar botão e esconder spinner
                btnSalvar.disabled = false;
                btnLabel.style.display = 'inline-flex';
                btnSpinner.style.display = 'none';
            }
        }
        
        // Variável global para vendas filtradas
        let vendasFiltradas = [];
        
        // Carregar Gerenciamento de Vendas
        function carregarGerenciamento() {
            vendasFiltradas = [...vendas].reverse();
            atualizarTabelaGerenciamento();
        }
        
        // Atualizar tabela de gerenciamento
        function atualizarTabelaGerenciamento() {
            const tbody = document.getElementById('tabelaGerenciamento');
            if (vendasFiltradas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 60px 20px;">
                            <div style="text-align: center; color: #64748b;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" style="display: block; margin: 0 auto 16px; opacity: 0.5;">
                                    <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2M9 17H7v-7h2v7m4 0h-2V7h2v10m4 0h-2v-4h2v4"/>
                                </svg>
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #475569;">Nenhuma venda encontrada</h3>
                                <p style="font-size: 14px; margin-bottom: 24px;">Realize vendas na aba "Vendas" para gerenciá-las aqui</p>
                                <button class="btn btn-primary" onclick="mudaTab('vendas')" style="display: inline-flex; align-items: center; gap: 8px;">
                                    <span class="material-symbols-rounded">shopping_cart</span>
                                    Ir para Vendas
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                const btnRemover = document.getElementById('btnRemoverGerenciamento');
                if (btnRemover) {
                    btnRemover.disabled = true;
                }
                return;
            }
            
            tbody.innerHTML = vendasFiltradas.map(v => {
                const produtosLista = v.itens.map(i => 
                    `${i.nome} (${i.quantidade}x) - ${formatarMoeda(i.preco * i.quantidade)}`
                ).join('<br>');
                const totalProdutos = v.itens.reduce((sum, item) => sum + item.quantidade, 0);
                const formaPagamento = v.formaPagamento || v.forma_pagamento || 'Não informado';
                
                return `
                    <tr>
                        <td><input type="checkbox" class="check-venda-gerenciamento" value="${v.id}" onchange="atualizarSelecaoGerenciamento()"></td>
                        <td><strong>#${v.id}</strong></td>
                        <td>${new Date(v.data).toLocaleString('pt-BR')}</td>
                        <td style="max-width:300px;">
                            <div style="font-weight:600;margin-bottom:4px;">${totalProdutos} ${totalProdutos === 1 ? 'produto' : 'produtos'}</div>
                            <div style="font-size:12px;color:#64748b;">${produtosLista}</div>
                        </td>
                        <td style="font-weight:700;color:#059669;font-size:16px;">${formatarMoeda(v.total)}</td>
                        <td><span class="badge badge-success">${formaPagamento}</span></td>
                        <td>
                            <button class="btn btn-primary" style="padding:8px 14px;font-size:13px;" onclick="verDetalhesVenda(${v.id})">
                                <span class="material-symbols-rounded">visibility</span> Detalhes
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            atualizarCheckTodosGerenciamento();
        }
        
        // Filtrar vendas
        function filtrarVendas() {
            const filtroData = document.getElementById('filtroData').value;
            const filtroProduto = document.getElementById('filtroProduto').value.toLowerCase().trim();
            
            vendasFiltradas = [...vendas].reverse().filter(v => {
                // Filtro por data
                if (filtroData) {
                    const vendaData = new Date(v.data).toISOString().split('T')[0];
                    if (vendaData !== filtroData) return false;
                }
                
                // Filtro por produto
                if (filtroProduto) {
                    const temProduto = v.itens.some(item => 
                        item.nome.toLowerCase().includes(filtroProduto)
                    );
                    if (!temProduto) return false;
                }
                
                return true;
            });
            
            atualizarTabelaGerenciamento();
        }
        
        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filtroData').value = '';
            document.getElementById('filtroProduto').value = '';
            carregarGerenciamento();
        }
        
        // ============ FUNÇÕES DE SELEÇÃO DE GERENCIAMENTO ============
        
        // Atualizar seleção de gerenciamento
        function atualizarSelecaoGerenciamento() {
            vendasSelecionadasGerenciamento.clear();
            document.querySelectorAll('.check-venda-gerenciamento:checked').forEach(cb => {
                const row = cb.closest('tr');
                // Só adicionar se a linha estiver visível
                if (row && row.style.display !== 'none') {
                    vendasSelecionadasGerenciamento.add(parseInt(cb.value));
                }
            });
            atualizarCheckTodosGerenciamento();
            // Atualizar estado do botão de remover
            const btnRemover = document.getElementById('btnRemoverGerenciamento');
            if (btnRemover) {
                btnRemover.disabled = vendasSelecionadasGerenciamento.size === 0;
            }
        }
        
        // Selecionar todas as vendas do gerenciamento (toggle - apenas as visíveis)
        function selecionarTodosGerenciamento() {
            const checkboxes = Array.from(document.querySelectorAll('.check-venda-gerenciamento')).filter(cb => {
                const row = cb.closest('tr');
                return row && row.style.display !== 'none';
            });
            const checked = checkboxes.filter(cb => cb.checked);
            const todosMarcados = checkboxes.length > 0 && checked.length === checkboxes.length;
            
            checkboxes.forEach(cb => {
                cb.checked = !todosMarcados;
            });
            atualizarSelecaoGerenciamento();
        }
        
        // Toggle todas as vendas do gerenciamento (apenas as visíveis)
        function toggleTodosGerenciamento(checked) {
            document.querySelectorAll('.check-venda-gerenciamento').forEach(cb => {
                const row = cb.closest('tr');
                // Só alterar se a linha estiver visível
                if (row && row.style.display !== 'none') {
                    cb.checked = checked;
                }
            });
            atualizarSelecaoGerenciamento();
        }
        
        // Atualizar checkbox "selecionar todos" de gerenciamento
        function atualizarCheckTodosGerenciamento() {
            const checkTodos = document.getElementById('checkTodosGerenciamento');
            if (!checkTodos) return;
            // Contar apenas checkboxes visíveis
            const checkboxesVisiveis = Array.from(document.querySelectorAll('.check-venda-gerenciamento')).filter(cb => {
                const row = cb.closest('tr');
                return row && row.style.display !== 'none';
            });
            const selecionados = checkboxesVisiveis.filter(cb => cb.checked).length;
            checkTodos.checked = checkboxesVisiveis.length > 0 && selecionados === checkboxesVisiveis.length;
            checkTodos.indeterminate = selecionados > 0 && selecionados < checkboxesVisiveis.length;
        }
        
        // Remover vendas selecionadas do gerenciamento
        async function removerVendasGerenciamentoSelecionadas() {
            if (vendasSelecionadasGerenciamento.size === 0) {
                showToast('Nenhuma venda selecionada!', 'warning');
                return;
            }
            
            const quantidade = vendasSelecionadasGerenciamento.size;
            const ok = await showConfirm(`Deseja realmente excluir ${quantidade} venda(s) selecionada(s)? Esta ação não pode ser desfeita!`);
            if (!ok) return;
            
            let sucessos = 0;
            let erros = 0;
            
            for (const id of vendasSelecionadasGerenciamento) {
                const result = await ipcRenderer.invoke('venda-deletar', id);
                if (result.success) {
                    vendas = vendas.filter(v => v.id !== id);
                    sucessos++;
                } else {
                    erros++;
                }
            }
            
            vendasSelecionadasGerenciamento.clear();
            carregarGerenciamento();
            atualizarEstatisticas();
            
            if (sucessos > 0) {
                showToast(`${sucessos} venda(s) excluída(s) com sucesso!`, 'success');
            }
            if (erros > 0) {
                showToast(`${erros} venda(s) não puderam ser excluídas`, 'error');
            }
        }

        // Verificar sessão salva e fazer login automático
        async function verificarSessaoSalva() {
            try {
                const result = await ipcRenderer.invoke('verificar-sessao');
                if (result.success && result.usuario) {
                    usuarioLogado = result.usuario;
                    document.getElementById('loginScreen').classList.add('hidden');
                    atualizarNomeCabecalho();
                    await carregarDadosUsuario();
                } else {
                    // Não há sessão salva, verificar primeiro acesso
                    verificarPrimeiroAcesso();
                }
            } catch (error) {
                console.error('Erro ao verificar sessão:', error);
                verificarPrimeiroAcesso();
            }
        }

        // Inicializar
        verificarSessaoSalva();
        
        // Garantir que a área de produtos seja carregada quando a página carrega (usar requestAnimationFrame)
        requestAnimationFrame(() => {
            // Atualizar ícones das abas
            atualizarIconesTab();
            
            const vendasTab = document.getElementById('tab-vendas');
            if (vendasTab && vendasTab.classList.contains('active')) {
                carregarProdutosGrid(); // Sempre chamar (mostra produtos ou mensagem de "nenhum produto")
            }
            const gerenciamentoTab = document.getElementById('tab-gerenciamento');
            if (gerenciamentoTab && gerenciamentoTab.classList.contains('active')) {
                atualizarEstatisticas();
            }
        });
        // ============ FUNÇÕES DE CLIENTES ============
        
        // Carregar clientes
        async function carregarClientes() {
            clientes = await ipcRenderer.invoke('clientes-listar');
            clientesFiltrados = [...clientes];
            exibirClientes();
        }
        
        // Variáveis para seleção de clientes e vendas
        let clientesSelecionados = new Set();
        let vendasSelecionadas = new Set();
        let vendasSelecionadasGerenciamento = new Set();
        
        // Exibir clientes na tabela
        function exibirClientes() {
            const tbody = document.getElementById('tabelaClientes');
            
            if (!clientesFiltrados || clientesFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 60px 20px;">
                            <div style="text-align: center; color: #64748b;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" style="display: block; margin: 0 auto 16px; opacity: 0.5;">
                                    <path fill="currentColor" d="M16 7a4 4 0 1 1-8 0a4 4 0 0 1 8 0M12 14a7 7 0 0 0-7 7h14a7 7 0 0 0-7-7"/>
                                </svg>
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #475569;">Nenhum cliente cadastrado</h3>
                                <p style="font-size: 14px; margin-bottom: 24px;">Cadastre clientes para realizar vendas a prazo e gerenciar pagamentos</p>
                                <button class="btn btn-primary" onclick="abrirModalCliente()" style="display: inline-flex; align-items: center; gap: 8px;">
                                    <span class="material-symbols-rounded">person_add</span>
                                    Adicionar Cliente
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                const btnRemover = document.getElementById('btnRemoverClientes');
                if (btnRemover) {
                    btnRemover.disabled = true;
                }
                return;
            }
            
            tbody.innerHTML = clientesFiltrados.map(cliente => {
                const dataCadastro = cliente.dia_cadastro && cliente.mes_cadastro 
                    ? `${cliente.dia_cadastro}/${cliente.mes_cadastro}`
                    : '-';
                
                const valor = parseFloat(cliente.status) || 0;
                
                return `
                <tr>
                    <td><input type="checkbox" class="check-cliente" value="${cliente.id}" onchange="atualizarSelecaoClientes()"></td>
                    <td style="font-weight:600;color:#1e293b;">${cliente.nome}</td>
                    <td>${formatarCPF(cliente.cpf)}</td>
                    <td style="font-weight:600;color:#059669;font-size:16px;">${formatarMoeda(valor)}</td>
                    <td>${dataCadastro}</td>
                    <td>
                        <button class="btn btn-success" style="padding:8px 14px;font-size:13px;margin-right:5px;display:inline-flex;align-items:center;gap:4px;width:auto;margin-top:0;" onclick="marcarClienteComoPago(${cliente.id})">
                            <span class="material-symbols-rounded" style="font-size:18px;">check_circle</span> Pago
                        </button>
                        <button class="btn btn-secondary" style="padding:8px 14px;font-size:13px;display:inline-flex;align-items:center;gap:4px;" onclick="excluirCliente(${cliente.id})">
                            <span class="material-symbols-rounded" style="font-size:18px;">delete</span> Excluir
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
            if (typeof atualizarCheckTodosClientes === 'function') {
                atualizarCheckTodosClientes();
            }
            // Atualizar estado do botão de remover clientes
            const btnRemover = document.getElementById('btnRemoverClientes');
            if (btnRemover) {
                btnRemover.disabled = clientesSelecionados.size === 0;
            }
        }
        
        // Abrir modal de cliente (novo) - Otimizado
        function abrirModalCliente() {
            editandoClienteId = null;
            
            // Verificar se os elementos existem antes de acessar
            const modalClienteTitle = document.getElementById('modalClienteTitle');
            const clienteNome = document.getElementById('clienteNome');
            const clienteCpf = document.getElementById('clienteCpf');
            const clienteValorEl = document.getElementById('clienteValor');
            const cpfErro = document.getElementById('cpfErro');
            
            if (modalClienteTitle) modalClienteTitle.textContent = 'Adicionar Cliente';
            if (clienteNome) clienteNome.value = '';
            if (clienteCpf) clienteCpf.value = '';
            if (clienteValorEl) clienteValorEl.value = '';
            if (cpfErro) cpfErro.textContent = '';
            
            // Usar função otimizada para abrir modal
            abrirModalOtimizado('modalCliente');
        }
        
        // Marcar cliente como pago
        async function marcarClienteComoPago(id) {
            const cliente = await ipcRenderer.invoke('cliente-buscar', id);
            if (!cliente) {
                showToast('Cliente não encontrado!', 'error');
                return;
            }
            
            const valorAtual = parseFloat(cliente.status) || 0;
            
            if (valorAtual === 0) {
                showToast('Cliente já está com valor zerado!', 'info');
                return;
            }
            
            const confirmacao = await showConfirm(
                `Deseja marcar "${cliente.nome}" como pago?\n\nValor atual: ${formatarMoeda(valorAtual)}\nO valor será zerado.`
            );
            
            if (!confirmacao) {
                return;
            }
            
            try {
                // Buscar o cliente completo para manter os dados
                const clienteAtual = await ipcRenderer.invoke('cliente-buscar', id);
                if (!clienteAtual) {
                    showToast('Cliente não encontrado!', 'error');
                    return;
                }
                
                // Zerar o valor do cliente (marcar como pago)
                const resultadoAtualizacao = await ipcRenderer.invoke('cliente-atualizar', {
                    id: id,
                    cliente: {
                        nome: clienteAtual.nome,
                        cpf: clienteAtual.cpf,
                        status: '0'
                    }
                });
                
                if (resultadoAtualizacao.success) {
                    showToast(`Cliente "${cliente.nome}" marcado como pago!`, 'success');
                    // Recarregar lista de clientes
                    await carregarClientes();
                } else {
                    showToast('Erro ao marcar cliente como pago: ' + (resultadoAtualizacao.error || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                console.error('Erro ao marcar cliente como pago:', error);
                showToast('Erro ao marcar cliente como pago', 'error');
            }
        }
        
        // Fechar modal de cliente - Otimizado
        function fecharModalCliente() {
            fecharModalOtimizado('modalCliente');
            editandoClienteId = null;
        }
        
        // Salvar cliente
        async function salvarCliente(e) {
            e.preventDefault();
            
            const btnSalvar = document.getElementById('btnSalvarCliente');
            const btnLabel = document.getElementById('btnSalvarClienteLabel');
            const btnSpinner = document.getElementById('btnSalvarClienteSpinner');

            if (btnSalvar) {
                btnSalvar.disabled = true;
                btnSalvar.classList.add('btn-loading');
            }
            if (btnLabel) btnLabel.style.display = 'none';
            if (btnSpinner) btnSpinner.style.display = 'inline-block';
            
            const nome = document.getElementById('clienteNome').value.trim();
            const cpf = document.getElementById('clienteCpf').value.replace(/\D/g, '');
            const clienteValorEl = document.getElementById('clienteValor');
            const valorStr = clienteValorEl ? clienteValorEl.value.replace(',', '.') : '0';
            const valor = parseFloat(valorStr) || 0;
            
            // Validar CPF
            if (!validarCPF(cpf)) {
                document.getElementById('cpfErro').textContent = 'CPF inválido!';
                document.getElementById('cpfErro').style.color = '#dc2626';
                
                if (btnSalvar) {
                    btnSalvar.disabled = false;
                    btnSalvar.classList.remove('btn-loading');
                }
                if (btnLabel) btnLabel.style.display = 'inline-flex';
                if (btnSpinner) btnSpinner.style.display = 'none';
                return;
            }
            
            document.getElementById('cpfErro').textContent = '';
            
            const cliente = {
                nome,
                cpf,
                status: valor // Usando status para armazenar o valor monetário
            };
            
            let result;
            if (editandoClienteId) {
                result = await ipcRenderer.invoke('cliente-atualizar', { id: editandoClienteId, cliente });
            } else {
                result = await ipcRenderer.invoke('cliente-criar', cliente);
            }
            
            if (result.success) {
                showToast(editandoClienteId ? 'Cliente atualizado com sucesso!' : 'Cliente cadastrado com sucesso!', 'success');
                fecharModalCliente();
                await carregarClientes();
            } else {
                showToast('Erro ao salvar cliente: ' + (result.error || 'Erro desconhecido'), 'error');
            }

            if (btnSalvar) {
                btnSalvar.disabled = false;
                btnSalvar.classList.remove('btn-loading');
            }
            if (btnLabel) btnLabel.style.display = 'inline-flex';
            if (btnSpinner) btnSpinner.style.display = 'none';
        }
        
        // Excluir cliente
        async function excluirCliente(id) {
            const cliente = clientes.find(c => c.id === id);
            const ok = await showConfirm(`Deseja realmente excluir o cliente "${cliente?.nome || 'este cliente'}"?`);
            if (!ok) return;
            
            const result = await ipcRenderer.invoke('cliente-excluir', id);
            if (result.success) {
                showToast('Cliente excluído com sucesso!', 'success');
                await carregarClientes();
            } else {
                showToast('Erro ao excluir cliente: ' + (result.error || 'Erro desconhecido'), 'error');
            }
        }
        
        // ============ FUNÇÕES DE SELEÇÃO DE CLIENTES ============
        
        // Atualizar seleção de clientes
        function atualizarSelecaoClientes() {
            clientesSelecionados.clear();
            document.querySelectorAll('.check-cliente:checked').forEach(cb => {
                const row = cb.closest('tr');
                // Só adicionar se a linha estiver visível
                if (row && row.style.display !== 'none') {
                    clientesSelecionados.add(parseInt(cb.value));
                }
            });
            atualizarCheckTodosClientes();
            // Atualizar estado do botão de remover
            const btnRemover = document.getElementById('btnRemoverClientes');
            if (btnRemover) {
                btnRemover.disabled = clientesSelecionados.size === 0;
            }
        }
        
        // Selecionar todos os clientes (toggle - apenas os visíveis)
        function selecionarTodosClientes() {
            const checkboxes = Array.from(document.querySelectorAll('.check-cliente')).filter(cb => {
                const row = cb.closest('tr');
                return row && row.style.display !== 'none';
            });
            const checked = checkboxes.filter(cb => cb.checked);
            const todosMarcados = checkboxes.length > 0 && checked.length === checkboxes.length;
            
            checkboxes.forEach(cb => {
                cb.checked = !todosMarcados;
            });
            atualizarSelecaoClientes();
        }
        
        // Toggle todos os clientes (apenas os visíveis)
        function toggleTodosClientes(checked) {
            document.querySelectorAll('.check-cliente').forEach(cb => {
                const row = cb.closest('tr');
                // Só alterar se a linha estiver visível
                if (row && row.style.display !== 'none') {
                    cb.checked = checked;
                }
            });
            atualizarSelecaoClientes();
        }
        
        // Atualizar checkbox "selecionar todos" de clientes
        function atualizarCheckTodosClientes() {
            const checkTodos = document.getElementById('checkTodosClientes');
            if (!checkTodos) return;
            // Contar apenas checkboxes visíveis
            const checkboxesVisiveis = Array.from(document.querySelectorAll('.check-cliente')).filter(cb => {
                const row = cb.closest('tr');
                return row && row.style.display !== 'none';
            });
            const selecionados = checkboxesVisiveis.filter(cb => cb.checked).length;
            checkTodos.checked = checkboxesVisiveis.length > 0 && selecionados === checkboxesVisiveis.length;
            checkTodos.indeterminate = selecionados > 0 && selecionados < checkboxesVisiveis.length;
        }
        
        // Remover clientes selecionados
        async function removerClientesSelecionados() {
            if (clientesSelecionados.size === 0) {
                showToast('Nenhum cliente selecionado!', 'warning');
                return;
            }
            
            const quantidade = clientesSelecionados.size;
            const ok = await showConfirm(`Deseja realmente excluir ${quantidade} cliente(s) selecionado(s)?`);
            if (!ok) return;
            
            let sucessos = 0;
            let erros = 0;
            
            for (const id of clientesSelecionados) {
                const result = await ipcRenderer.invoke('cliente-excluir', id);
                if (result.success) {
                    clientes = clientes.filter(c => c.id !== id);
                    clientesFiltrados = clientesFiltrados.filter(c => c.id !== id);
                    sucessos++;
                } else {
                    erros++;
                }
            }
            
            clientesSelecionados.clear();
            exibirClientes();
            carregarClientes();
            
            if (sucessos > 0) {
                showToast(`${sucessos} cliente(s) excluído(s) com sucesso!`, 'success');
            }
            if (erros > 0) {
                showToast(`${erros} cliente(s) não puderam ser excluídos`, 'error');
            }
        }
        
        // ============ FUNÇÕES DE SELEÇÃO DE HISTÓRICO ============
        
        // Atualizar seleção de histórico
        function atualizarSelecaoHistorico() {
            vendasSelecionadas.clear();
            document.querySelectorAll('.check-venda:checked').forEach(cb => {
                const row = cb.closest('tr');
                // Só adicionar se a linha estiver visível
                if (row && row.style.display !== 'none') {
                    vendasSelecionadas.add(parseInt(cb.value));
                }
            });
            atualizarCheckTodosHistorico();
            // Atualizar estado do botão de remover
            const btnRemover = document.getElementById('btnRemoverHistorico');
            if (btnRemover) {
                btnRemover.disabled = vendasSelecionadas.size === 0;
            }
        }
        
        // Selecionar todas as vendas (toggle - apenas as visíveis)
        function selecionarTodosHistorico() {
            const checkboxes = Array.from(document.querySelectorAll('.check-venda')).filter(cb => {
                const row = cb.closest('tr');
                return row && row.style.display !== 'none';
            });
            const checked = checkboxes.filter(cb => cb.checked);
            const todosMarcados = checkboxes.length > 0 && checked.length === checkboxes.length;
            
            checkboxes.forEach(cb => {
                cb.checked = !todosMarcados;
            });
            atualizarSelecaoHistorico();
        }
        
        // Toggle todas as vendas (apenas as visíveis)
        function toggleTodosHistorico(checked) {
            document.querySelectorAll('.check-venda').forEach(cb => {
                const row = cb.closest('tr');
                // Só alterar se a linha estiver visível
                if (row && row.style.display !== 'none') {
                    cb.checked = checked;
                }
            });
            atualizarSelecaoHistorico();
        }
        
        // Atualizar checkbox "selecionar todos" de histórico
        function atualizarCheckTodosHistorico() {
            const checkTodos = document.getElementById('checkTodosHistorico');
            if (!checkTodos) return;
            // Contar apenas checkboxes visíveis
            const checkboxesVisiveis = Array.from(document.querySelectorAll('.check-venda')).filter(cb => {
                const row = cb.closest('tr');
                return row && row.style.display !== 'none';
            });
            const selecionados = checkboxesVisiveis.filter(cb => cb.checked).length;
            checkTodos.checked = checkboxesVisiveis.length > 0 && selecionados === checkboxesVisiveis.length;
            checkTodos.indeterminate = selecionados > 0 && selecionados < checkboxesVisiveis.length;
        }
        
        // Remover vendas selecionadas
        async function removerVendasSelecionadas() {
            if (vendasSelecionadas.size === 0) {
                showToast('Nenhuma venda selecionada!', 'warning');
                return;
            }
            
            const quantidade = vendasSelecionadas.size;
            const ok = await showConfirm(`Deseja realmente excluir ${quantidade} venda(s) selecionada(s)? Esta ação não pode ser desfeita!`);
            if (!ok) return;
            
            let sucessos = 0;
            let erros = 0;
            
            for (const id of vendasSelecionadas) {
                const result = await ipcRenderer.invoke('venda-deletar', id);
                if (result.success) {
                    vendas = vendas.filter(v => v.id !== id);
                    sucessos++;
                } else {
                    erros++;
                }
            }
            
            vendasSelecionadas.clear();
            carregarHistorico();
            atualizarEstatisticas();
            
            if (sucessos > 0) {
                showToast(`${sucessos} venda(s) excluída(s) com sucesso!`, 'success');
            }
            if (erros > 0) {
                showToast(`${erros} venda(s) não puderam ser excluídas`, 'error');
            }
        }
        
        // Filtrar clientes
        function filtrarClientes() {
            const statusFiltro = document.getElementById('filtroStatusCliente').value;
            const diaFiltro = document.getElementById('filtroDiaCliente').value;
            const mesFiltro = document.getElementById('filtroMesCliente').value;
            
            clientesFiltrados = clientes.filter(cliente => {
                // Filtro de valor (status agora armazena valor monetário)
                if (statusFiltro && statusFiltro.trim() !== '') {
                    const valorCliente = parseFloat(cliente.status) || 0;
                    const valorFiltro = parseFloat(statusFiltro.replace(',', '.')) || 0;
                    // Comparar valores com margem de erro para evitar problemas de precisão
                    if (Math.abs(valorCliente - valorFiltro) > 0.01) {
                        return false;
                    }
                }
                
                // Filtro de dia
                if (diaFiltro && cliente.dia_cadastro != diaFiltro) {
                    return false;
                }
                
                // Filtro de mês
                if (mesFiltro && cliente.mes_cadastro != mesFiltro) {
                    return false;
                }
                
                return true;
            });
            
            exibirClientes();
        }
        
        // Limpar filtros
        function limparFiltrosClientes() {
            document.getElementById('filtroStatusCliente').value = '';
            document.getElementById('filtroDiaCliente').value = '';
            document.getElementById('filtroMesCliente').value = '';
            clientesFiltrados = [...clientes];
            exibirClientes();
        }
        
        // Aplicar máscara de CPF
        function aplicarMascaraCPF(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length <= 11) {
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                input.value = valor;
            }
        }
        
        // Formatar valor monetário no input
        function formatarValorInput(input) {
            let valor = input.value.replace(/[^\d,]/g, '');
            // Garantir apenas uma vírgula
            const partes = valor.split(',');
            if (partes.length > 2) {
                valor = partes[0] + ',' + partes.slice(1).join('');
            }
            // Limitar a 2 casas decimais
            if (partes.length === 2 && partes[1].length > 2) {
                valor = partes[0] + ',' + partes[1].substring(0, 2);
            }
            input.value = valor;
        }
        
        // Formatar CPF para exibição
        function formatarCPF(cpf) {
            if (!cpf) return '';
            const cpfLimpo = cpf.replace(/\D/g, '');
            if (cpfLimpo.length === 11) {
                return cpfLimpo.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            return cpf;
        }
        
        // Validar CPF
        function validarCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            
            if (cpf.length !== 11) return false;
            if (/^(\d)\1+$/.test(cpf)) return false; // Todos os dígitos iguais
            
            let soma = 0;
            let resto;
            
            // Validar primeiro dígito verificador
            for (let i = 1; i <= 9; i++) {
                soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
            }
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.substring(9, 10))) return false;
            
            // Validar segundo dígito verificador
            soma = 0;
            for (let i = 1; i <= 10; i++) {
                soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
            }
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.substring(10, 11))) return false;
            
            return true;
        }

    </script>
</body>
</html>

